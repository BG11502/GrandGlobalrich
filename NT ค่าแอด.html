<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .table tfoot td { font-weight: bold; background-color: #f1f1f1; }
    .btn-icon { display: inline-flex; align-items: center; gap: 0.4em; }
    .btn-outline-secondary:hover { background-color: #e2e6ea; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between mb-4">
    <a href="index.html" class="btn btn-outline-primary btn-icon"><i class="bi bi-house-door"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-secondary btn-icon"><i class="bi bi-graph-up-arrow"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a>
  </div>

  <h2 class="text-center mb-4 text-primary">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h2>

  <!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
  <div class="card p-3 mb-4">
    <h5 class="mb-3">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
    <div class="input-group">
      <input type="text" id="newOwner" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà" />
      <button class="btn btn-success" id="btnAddOwner"><i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div id="ownerList" class="d-flex flex-wrap gap-2 mt-3"></div>
  </div>

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
  <div class="card p-4 mb-4">
    <form id="adForm">
      <input type="hidden" id="editId" />
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="date" class="form-control" required /></div>
        <div class="col-md-3"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><input type="text" id="accountName" class="form-control" required /></div>
        <div class="col-md-3"><label class="form-label">ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><input type="text" id="accountId" class="form-control" required /></div>
        <div class="col-md-3"><label class="form-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="owner" class="form-select" required></select></div>
        <div class="col-md-3"><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="status" class="form-select"><option>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option><option>‡∏£‡∏∞‡∏á‡∏±‡∏ö</option></select></div>
        <div class="col-md-3"><label class="form-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label><input type="number" id="spendTotal" class="form-control" step="0.01" value="0" /></div>
        <div class="col-md-3"><label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</label><input type="number" id="costPerPurchase" class="form-control" step="0.01" value="0" /></div>
        <div class="col-md-3"><label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label><input type="number" id="purchases" class="form-control" value="0" /></div>
        <div class="col-md-3"><label class="form-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label><input type="number" id="revenue" class="form-control" step="0.01" value="0" /></div>
        <div class="col-md-3"><label class="form-label">ROAS</label><input type="number" id="roas" class="form-control" step="0.01" value="0" /></div>
      </div>
      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </form>
  </div>

  <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
    <select id="filterOwner" class="form-select w-auto"></select>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <div class="mb-3 text-end">
    <button id="toggleHistoryBtn" class="btn btn-outline-secondary">‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏° Undo ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
  <div id="undoContainer" class="mb-3 text-center" style="display:none;">
    <button id="undoBtn" class="btn btn-sm btn-warning">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <div class="card p-4">
    <h5 class="text-secondary mb-3"><i class="bi bi-clock-history"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-light">
          <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>ID</th><th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>ROAS</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
        </thead>
        <tbody id="historyBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="5">‡∏£‡∏ß‡∏°</td>
            <td id="sumSpend">0.00</td>
            <td id="avgCost">0.00</td>
            <td id="sumPurchase">0</td>
            <td id="sumRevenue">0.00</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
const supabaseUrl = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

let adData = [];
let lastDeletedEntry = null;

const historyTableDiv = document.querySelector(".table-responsive");
const toggleBtn = document.getElementById("toggleHistoryBtn");

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å localStorage
function loadHistoryVisibility() {
  const visible = localStorage.getItem("historyVisible");
  if (visible === "false") {
    historyTableDiv.style.display = "none";
    toggleBtn.textContent = "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";
  } else {
    historyTableDiv.style.display = "block";
    toggleBtn.textContent = "‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";
  }
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞ toggle
toggleBtn.addEventListener("click", () => {
  if (historyTableDiv.style.display === "none") {
    historyTableDiv.style.display = "block";
    toggleBtn.textContent = "‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";
    localStorage.setItem("historyVisible", "true");
  } else {
    historyTableDiv.style.display = "none";
    toggleBtn.textContent = "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á";
    localStorage.setItem("historyVisible", "false");
  }
});

function showUndoButton(show) {
  const undoContainer = document.getElementById("undoContainer");
  undoContainer.style.display = show ? "block" : "none";
}

async function loadOwners() {
  const { data } = await _supabase.from('ad_owners').select('name');
  const ownerSel = document.getElementById("owner");
  const filterSel = document.getElementById("filterOwner");
  const list = document.getElementById("ownerList");
  ownerSel.innerHTML = `<option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>`;
  filterSel.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  list.innerHTML = "";

  if (data) {
    data.forEach((o) => {
      ownerSel.innerHTML += `<option value="${o.name}">${o.name}</option>`;
      filterSel.innerHTML += `<option value="${o.name}">${o.name}</option>`;
      list.innerHTML += `<div class="badge bg-secondary p-2">${o.name}
        <button class="btn-close btn-sm ms-2" onclick="removeOwner('${o.name}')"></button></div>`;
    });
  }
}

async function loadHistory() {
  const filter = document.getElementById("filterOwner").value;
  let { data } = await _supabase.from("ad_history").select("*").order("date", { ascending: false });
  adData = data || [];
  if (filter !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") adData = adData.filter(e => e.owner === filter);
  renderTable();
  showUndoButton(lastDeletedEntry !== null);
}

function renderTable() {
  const tbody = document.getElementById("historyBody");
  if (adData.length === 0) return tbody.innerHTML = '<tr><td colspan="11">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
  tbody.innerHTML = "";
  let sumSpend = 0, sumCost = 0, sumPurchase = 0, sumRevenue = 0;
  adData.forEach((e, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${e.date}</td><td>${e.account_name}</td><td>${e.account_id}</td><td>${e.owner}</td><td>${e.status}</td>
        <td>${(+e.spend_total).toFixed(2)}</td><td>${(+e.cost_per_purchase).toFixed(2)}</td><td>${e.purchases}</td>
        <td>${(+e.revenue).toFixed(2)}</td><td>${(+e.roas).toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editEntry(${i})"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`;
    sumSpend += +e.spend_total;
    sumCost += +e.cost_per_purchase;
    sumPurchase += +e.purchases;
    sumRevenue += +e.revenue;
  });
  document.getElementById("sumSpend").textContent = sumSpend.toFixed(2);
  document.getElementById("avgCost").textContent = (adData.length ? sumCost / adData.length : 0).toFixed(2);
  document.getElementById("sumPurchase").textContent = sumPurchase;
  document.getElementById("sumRevenue").textContent = sumRevenue.toFixed(2);
}

async function addOwner() {
  const name = document.getElementById("newOwner").value.trim();
  if (!name) return;
  const { error } = await _supabase.from("ad_owners").insert([{ name }]);
  if (error) return alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  document.getElementById("newOwner").value = "";
  loadOwners();
}

async function removeOwner(name) {
  if (!confirm("‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ?")) return;
  await _supabase.from("ad_owners").delete().eq("name", name);
  loadOwners();
}

function editEntry(i) {
  const e = adData[i];
  document.getElementById("editId").value = e.id;
  date.value = e.date;
  accountName.value = e.account_name;
  accountId.value = e.account_id;
  owner.value = e.owner;
  status.value = e.status;
  spendTotal.value = e.spend_total;
  costPerPurchase.value = e.cost_per_purchase;
  purchases.value = e.purchases;
  revenue.value = e.revenue;
  roas.value = e.roas;
  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function deleteEntry(i) {
  if (!confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;
  const id = adData[i].id;
  lastDeletedEntry = adData[i]; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Undo
  const { error } = await _supabase.from("ad_history").delete().eq("id", id);
  if (error) {
    alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
    lastDeletedEntry = null;
    return;
  }
  loadHistory();
  showUndoButton(true);
}

document.getElementById("undoBtn").addEventListener("click", async () => {
  if (!lastDeletedEntry) return;
  const { error } = await _supabase.from("ad_history").insert([lastDeletedEntry]);
  if (error) return alert("‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  lastDeletedEntry = null;
  showUndoButton(false);
  loadHistory();
});

document.getElementById("adForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = document.getElementById("editId").value;
  const entry = {
    date: date.value,
    account_name: accountName.value,
    account_id: accountId.value,
    owner: owner.value,
    status: status.value,
    spend_total: parseFloat(spendTotal.value) || 0,
    cost_per_purchase: parseFloat(costPerPurchase.value) || 0,
    purchases: parseInt(purchases.value) || 0,
    revenue: parseFloat(revenue.value) || 0,
    roas: parseFloat(roas.value) || 0,
  };
  if (id) await _supabase.from("ad_history").update(entry).eq("id", id);
  else await _supabase.from("ad_history").insert([entry]);
  document.getElementById("adForm").reset();
  document.getElementById("editId").value = "";
  loadHistory();
});

document.getElementById("btnAddOwner").addEventListener("click", addOwner);
document.getElementById("filterOwner").addEventListener("change", loadHistory);

loadOwners();
loadHistory();
loadHistoryVisibility();
</script>
</body>
</html>
