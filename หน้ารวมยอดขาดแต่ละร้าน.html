<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>รายงานยอดขายแต่ละร้าน</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #f0f2f5; /* สีพื้นหลังที่ดูสบายตาขึ้น */
            font-family: 'Inter', sans-serif; /* ใช้ Font Inter */
            color: #333;
        }
        .container {
            max-width: 1300px; /* เพิ่มความกว้างสูงสุดของ container */
        }
        .summary-card {
            min-width: 200px;
            border-radius: 15px; /* มุมโค้งมนมากขึ้น */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* เพิ่มเงาให้โดดเด่นขึ้น */
            transition: transform 0.2s ease-in-out; /* เพิ่ม animation เล็กน้อย */
            height: 100%; /* ทำให้ card สูงเท่ากัน */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-card:hover {
            transform: translateY(-5px); /* เลื่อนขึ้นเล็กน้อยเมื่อ hover */
        }
        .summary-card .card-body {
            padding: 1.5rem;
        }
        .filter-box {
            border: none; /* ลบ border ออก */
            border-radius: 15px; /* มุมโค้งมน */
            padding: 30px; /* เพิ่ม padding */
            background: #fff;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* เงาเดียวกันกับ Card */
        }
        .form-label {
            font-weight: 600; /* ทำให้ label ดูเข้มขึ้น */
            color: #555;
            margin-bottom: 0.5rem;
        }
        .form-select, .form-control {
            border-radius: 10px; /* มุมโค้งมนสำหรับ input/select */
            border-color: #ced4da; /* สีขอบ input */
        }
        .month-checkboxes label {
            margin-right: 15px; /* เพิ่มระยะห่างระหว่าง checkbox */
        }
        .card {
            border-radius: 15px; /* มุมโค้งมน */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* เพิ่มเงา */
            border: none; /* ลบ border ของ card */
        }
        .card-header {
            background-color: #f8f9fa; /* สีพื้นหลัง header ของ card */
            border-bottom: 1px solid #e9ecef; /* เส้นแบ่งเบาๆ */
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            color: #333;
            border-radius: 15px 15px 0 0 !important; /* มุมโค้งมนเฉพาะด้านบน */
        }
        .card-body {
            padding: 1.5rem;
        }
        .btn {
            border-radius: 10px; /* มุมโค้งมนสำหรับปุ่ม */
            padding: 0.6rem 1.2rem;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
        }
        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .table {
            margin-bottom: 0;
        }
        .table th, .table td {
            padding: 0.9rem; /* เพิ่ม padding ในตาราง */
            vertical-align: middle;
        }
        .table thead th {
            border-bottom: 2px solid #dee2e6; /* เส้นใต้ header ตาราง */
            font-weight: 600;
            color: #495057;
        }
        .table tbody tr:last-child td {
            border-bottom: none; /* ไม่มีเส้นใต้ที่แถวสุดท้าย */
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.02); /* สีแถบสลับที่ดูซอฟต์ลง */
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,.05); /* สี hover ที่ดูนุ่มนวลขึ้น */
        }
        .modal-content {
            border-radius: 15px; /* มุมโค้งมนสำหรับ Modal */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .modal-header {
            border-bottom: none;
            padding: 1.5rem;
        }
        .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem;
        }
        .text-primary {
            color: #007bff !important; /* สีฟ้า Bootstrap primary */
        }
        .text-success {
            color: #28a745 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .fw-bold {
            font-weight: 700 !important;
        }
        /* Custom styling for specific headers */
        .card-header.bg-success {
            background-color: #28a745 !important;
            border-radius: 15px 15px 0 0 !important;
        }
        .table-primary thead {
            background-color: #e0f2ff; /* สีฟ้าอ่อนสำหรับ header ตาราง SKU */
        }
        .table-success thead {
            background-color: #d4edda; /* สีเขียวอ่อนสำหรับ header ตารางกระปุก */
        }
    </style>
</head>
<body class="p-4">
    <div class="container my-3">
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-outline-secondary" onclick="history.back()"><i class="bi bi-arrow-left"></i> ย้อนกลับ</button>
            <a href="index.html" class="btn btn-primary"><i class="bi bi-house-door-fill"></i> หน้าหลัก</a>
        </div>
    </div>

    <div class="container">
        <h3 class="mb-4 fw-bold text-primary">รายงานยอดขายแต่ละร้าน</h3>

        <div class="filter-box mb-5">
            <div class="row g-4 align-items-end"> 
                <div class="col-md-3 col-lg-2">
                    <label class="form-label">เลือกปี</label>
                    <select id="yearSelect" class="form-select"></select>
                </div>

                <div class="col-md-9 col-lg-6">
                    <label class="form-label">เลือกเดือน (ตามระบบ)</label>
                    <div class="d-flex flex-wrap gap-3" id="monthCheckboxes"></div> 
                </div>

                <div class="col-md-6 col-lg-4">
                    <label class="form-label">เลือกช่วงวันที่</label>
                    <div class="d-flex gap-2"> 
                        <input type="date" id="startDate" class="form-control">
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <label class="form-label">เลือกร้าน</label>
                    <select id="shopFilter" class="form-select" multiple size="8"> <option value="">ทั้งหมด</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-8 d-flex align-items-end justify-content-start gap-3"> 
                    <button class="btn btn-success" onclick="loadData()"><i class="bi bi-check-circle-fill"></i> ยืนยันการกรอง</button>
                    <button class="btn btn-outline-danger" onclick="resetFilter()"><i class="bi bi-x-circle-fill"></i> ล้างการกรอง</button>
                </div>
            </div>
        </div>

        <div class="row mb-5 g-4" id="summaryCards"></div> 
        <div class="card mb-5">
            <div class="card-header fw-bold">
                <i class="bi bi-shop me-2"></i> สรุปยอดขายรวมแต่ละร้านค้า
            </div>
            <div class="card-body table-responsive" id="shopTableContainer">
            </div>
        </div>

        <div class="card mt-5">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-check me-2"></i> รายละเอียดยอดขายรายเดือน</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleVisibility('monthlySummaryBody', 'toggleMonthlySummaryIcon')">
                    <i id="toggleMonthlySummaryIcon" class="bi bi-eye-slash-fill"></i>
                </button>
            </div>
            <div class="card-body table-responsive d-none" id="monthlySummaryBody">
                <table class="table table-bordered table-hover text-end align-middle table-striped">
                    <thead class="table-light text-center">
                        <tr>
                            <th>เดือน</th>
                            <th>จำนวนการสั่งซื้อ</th>
                            <th>จำนวนยอดยกเลิก</th>
                            <th>ออเดอร์คงเหลือ</th>
                            <th>ยอดขายรวม</th>
                            <th>ยอดยกเลิก</th>
                            <th>ยอดเงินคงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody id="monthlySummaryTableBody"></tbody>
                    <tfoot class="table-dark fw-bold">
                        <tr>
                            <td class="text-center">รวม</td>
                            <td id="totalMonthlyQty">0</td>
                            <td id="totalMonthlyRet">0</td>
                            <td id="totalMonthlyRemainingOrders">0</td>
                            <td id="totalMonthlyAmt">฿0.00</td>
                            <td id="totalMonthlyRef">฿0.00</td>
                            <td id="totalMonthlyRemainingAmount">฿0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="card p-4 mt-5">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-box-seam me-2"></i> รายละเอียด SKU รายวัน</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleVisibility('skuTableBodyContainer', 'toggleSkuTableIcon')">
                    <i id="toggleSkuTableIcon" class="bi bi-eye-slash-fill"></i>
                </button>
            </div>
            <div class="card-body d-none" id="skuTableBodyContainer">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchSKU" placeholder="🔍 ค้นหา SKU" oninput="loadData()" />
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <select id="sortOption" class="form-select w-auto d-inline" onchange="loadData()">
                            <option value="">🔃 เรียงตาม...</option>
                            <option value="qty">จำนวนขายมาก → น้อย</option>
                            <option value="amt">ยอดขายมาก → น้อย</option>
                        </select>
                        <button class="btn btn-info ms-2" onclick="analyzeSKUSales()"><i class="bi bi-robot"></i> วิเคราะห์ยอดขาย SKU</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-center align-middle table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>SKU</th>
                                <th>จำนวนการสั่งซื้อ</th>
                                <th>จำนวนยอดยกเลิก</th>
                                <th>ยอดขายรวม</th>
                                <th>ยอดยกเลิก</th>
                                <th>ยอดเงินคงเหลือ</th>
                            </tr>
                        </thead>
                        <tbody id="skuTableBody"></tbody>
                        <tfoot class="table-dark fw-bold">
                            <tr>
                                <td>รวม</td>
                                <td id="sumSkuQty">0</td>
                                <td id="sumSkuReturn">0</td>
                                <td id="sumSkuAmount">0.00</td>
                                <td id="sumSkuRefund">0.00</td>
                                <td id="sumSkuRemainingAmount">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-5">
            <div class="card-header bg-success text-white fw-bold">
                <i class="bi bi-boxes me-2"></i> ยอดกระปุกรวม (ตามสินค้า)
            </div>
            <div class="card-body table-responsive">
                <table class="table table-bordered text-center align-middle table-striped">
                    <thead class="table-success" id="productJarTableHead">
                    </thead>
                    <tbody id="productJarTableBody">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiAnalysisModalLabel"><i class="bi bi-stars"></i> ผลการวิเคราะห์ยอดขาย SKU ด้วย AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiAnalysisContent">
                        <p class="text-center text-muted">กำลังวิเคราะห์ข้อมูล...</p>
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                // ถ้าไม่มีข้อมูลผู้ใช้ใน localStorage ให้พาไปหน้า login.html
                window.location.href = 'login.html';
            }
        });

        const client = supabase.createClient(
            "https://vzxttbvwukpsxqdaulvo.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
        );

        const yearSelect = document.getElementById("yearSelect");
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const monthCheckboxes = document.getElementById("monthCheckboxes");
        const shopFilter = document.getElementById("shopFilter");
        const searchSKUInput = document.getElementById("searchSKU");
        const sortOptionSelect = document.getElementById("sortOption");

        const monthlySummaryTableBody = document.getElementById("monthlySummaryTableBody");
        const skuTableBody = document.getElementById("skuTableBody");
        const productJarTableHead = document.getElementById("productJarTableHead");
        const productJarTableBody = document.getElementById("productJarTableBody");

        const aiAnalysisModal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
        const aiAnalysisContent = document.getElementById('aiAnalysisContent');

        let currentSKUDataForAnalysis = {}; // เก็บข้อมูล SKU ที่ถูกกรองและเรียงลำดับแล้ว

        const monthNames = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];

        // Populate year dropdown
        for (let y = 2022; y <= new Date().getFullYear(); y++) {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }

        // Populate month checkboxes
        monthCheckboxes.innerHTML = monthNames.map((m, i) => `
            <div class='form-check'>
                <input class='form-check-input month-check' type='checkbox' value='${i + 1}' id='m${i}'>
                <label class='form-check-label' for='m${i}'>${m}</label>
            </div>`).join("");

        function getSelectedMonths() {
            return Array.from(document.querySelectorAll(".month-check:checked")).map(el => parseInt(el.value));
        }
        
        // --- NEW FUNCTION: Get selected shops from multiple select ---
        function getSelectedShops() {
            const selectedOptions = Array.from(shopFilter.selectedOptions);
            // ถ้ามี "ทั้งหมด" ถูกเลือก หรือไม่มีการเลือกอะไรเลย ให้ถือว่าเลือกทั้งหมด
            if (selectedOptions.some(option => option.value === "") || selectedOptions.length === 0) {
                return []; // คืนค่าเป็น array ว่าง เพื่อให้ query ไม่กรอง shop_name
            }
            return selectedOptions.map(option => option.value);
        }
        // --- END NEW FUNCTION ---

        function resetFilter() {
            document.querySelectorAll(".month-check").forEach(el => el.checked = false);
            startDateInput.value = "";
            endDateInput.value = "";
            // --- MODIFIED: Clear all selections for multiple shop select ---
            Array.from(shopFilter.options).forEach(option => {
                option.selected = false;
            });
            // --- END MODIFIED ---
            searchSKUInput.value = "";
            sortOptionSelect.value = "";
            loadData();
        }

        function formatNumber(num) {
            return num?.toLocaleString("th-TH", { minimumFractionDigits: 2 });
        }

        // Function to toggle visibility
        function toggleVisibility(elementId, iconId) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(iconId);

            if (element.classList.contains('d-none')) {
                element.classList.remove('d-none');
                icon.classList.remove('bi-eye-slash-fill');
                icon.classList.add('bi-eye-fill');
            } else {
                element.classList.add('d-none');
                icon.classList.remove('bi-eye-fill');
                icon.classList.add('bi-eye-slash-fill');
            }
        }

        // Function to parse product_description string into an array of { product, qty }
        function parseDescription(desc) {
            if (!desc) return [];
            const prefixRemoved = desc.replace(/^สินค้า\s*/, '');
            if (!prefixRemoved) return [];
            const parts = prefixRemoved.split('+');
            return parts.map(part => {
                const m = part.match(/(.+?)\s*([0-9]+)\s*กระปุก/);
                if (m) {
                    return {
                        product: m[1].trim(),
                        qty: parseInt(m[2], 10)
                    };
                } else {
                    // Handle cases where format might be slightly off, e.g., just a product name without "กระปุก"
                    return {
                        product: part.trim(),
                        qty: 0 // Default to 0 if quantity not found
                    };
                }
            });
        }

        async function loadData() {
            const selectedYear = parseInt(yearSelect.value);
            const selectedMonths = getSelectedMonths();
            const selectedShops = getSelectedShops(); // --- MODIFIED: Use new function ---

            let startDate, endDate;

            if (selectedMonths.length > 0) {
                const minMonth = Math.min(...selectedMonths);
                const maxMonth = Math.max(...selectedMonths);
                // Adjust for your specific month range (26th of prev month to 25th of current month)
                startDate = dayjs(`${selectedYear}-${String(minMonth).padStart(2, '0')}-26`).subtract(1, 'month').toDate();
                endDate = dayjs(`${selectedYear}-${String(maxMonth).padStart(2, '0')}-25`).toDate();
            } else if (startDateInput.value && endDateInput.value) {
                startDate = new Date(startDateInput.value);
                endDate = new Date(endDateInput.value);
            } else {
                startDate = new Date(selectedYear, 0, 1);
                endDate = new Date(selectedYear, 11, 31);
            }

            let query = client
                .from("sku_history")
                .select("*")
                .gte("date", dayjs(startDate).format("YYYY-MM-DD"))
                .lte("date", dayjs(endDate).format("YYYY-MM-DD"));

            // --- MODIFIED: Use .in() for multiple shop selection ---
            if (selectedShops.length > 0) {
                query = query.in("shop_name", selectedShops);
            }
            // --- END MODIFIED ---

            const { data, error } = await query; // data is sku_history entries

            if (error) {
                alert("โหลดข้อมูลผิดพลาด");
                console.error(error);
                return;
            }

            renderShopList(data);
            renderTable(data);
            loadMonthlySummary(data);
            renderSKUTable(data);
            await renderProductJarTable(data); // Pass sku_history data here
        }

        function renderShopList(data) {
            const uniqueShops = Array.from(new Set(data.map(d => d.shop_name).filter(Boolean)));
            // Keep existing selections if any
            const currentSelectedValues = getSelectedShops(); 

            shopFilter.innerHTML = `<option value="">ทั้งหมด</option>` + uniqueShops.map(shop => {
                const isSelected = currentSelectedValues.includes(shop) ? 'selected' : '';
                return `<option value="${shop}" ${isSelected}>${shop}</option>`;
            }).join("");
        }

        function renderTable(data) {
            const summaryByShop = {};
            let totalAmt = 0, totalQty = 0, totalRet = 0, totalRef = 0;

            data.forEach(entry => {
                const shop = entry.shop_name || "ไม่ระบุร้าน";
                if (!summaryByShop[shop]) {
                    summaryByShop[shop] = { amt: 0, qty: 0, ret: 0, ref: 0 };
                }

                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        summaryByShop[shop].amt += sku.amt || 0;
                        summaryByShop[shop].qty += sku.qty || 0;
                        summaryByShop[shop].ret += sku.ret || 0;
                        summaryByShop[shop].ref += sku.ref || 0;

                        totalAmt += sku.amt || 0;
                        totalQty += sku.qty || 0;
                        totalRet += sku.ret || 0;
                        totalRef += sku.ref || 0;
                    });
                }
            });

            const remainingOrders = totalQty - totalRet;
            const remainingAmount = totalAmt - totalRef;

            document.getElementById("summaryCards").innerHTML = `
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">จำนวนการสั่งซื้อ</h6>
                    <h5 class="fw-bold">${formatNumber(totalQty)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">จำนวนยอดยกเลิก</h6>
                    <h5 class="text-danger fw-bold">${formatNumber(totalRet)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">ออเดอร์คงเหลือ</h6>
                    <h5 class="fw-bold">${formatNumber(remainingOrders)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">ยอดขายรวม</h6>
                    <h5 class="text-success fw-bold">฿${formatNumber(totalAmt)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">ยอดยกเลิก</h6>
                    <h5 class="text-danger fw-bold">฿${formatNumber(totalRef)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">ยอดเงินคงเหลือ</h6>
                    <h5 class="fw-bold">฿${formatNumber(remainingAmount)}</h5></div></div></div>
            `;

            let html = `<table class="table table-bordered table-hover bg-white table-striped">
                <thead class="table-light text-center">
                    <tr>
                        <th>ร้านค้า</th>
                        <th>ยอดขายรวม</th>
                        <th>จำนวนการสั่งซื้อ</th>
                        <th>จำนวนยอดยกเลิก</th>
                        <th>ยอดยกเลิก</th>
                        <th>ออเดอร์คงเหลือ</th>
                        <th>ยอดเงินคงเหลือ</th>
                    </tr>
                </thead><tbody>`;

            Object.entries(summaryByShop).forEach(([shop, s]) => {
                const shopRemainingOrders = s.qty - s.ret;
                const shopRemainingAmount = s.amt - s.ref;
                html += `<tr>
                    <td>${shop}</td>
                    <td class="text-end text-success">฿${formatNumber(s.amt)}</td>
                    <td class="text-end">${formatNumber(s.qty)}</td>
                    <td class="text-end text-danger">${formatNumber(s.ret)}</td>
                    <td class="text-end text-danger">฿${formatNumber(s.ref)}</td>
                    <td class="text-end">${formatNumber(shopRemainingOrders)}</td>
                    <td class="text-end">฿${formatNumber(shopRemainingAmount)}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            document.getElementById("shopTableContainer").innerHTML = html;
        }

        function loadMonthlySummary(data) {
            const monthlySummary = Array.from({ length: 12 }, (_, i) => ({ month: i, qty: 0, ret: 0, amt: 0, ref: 0, remainingOrders: 0, remainingAmount: 0 }));

            data.forEach(entry => {
                const date = dayjs(entry.date);
                let monthIndex = date.date() >= 26 ? date.month() + 1 : date.month();
                if (monthIndex === 12) monthIndex = 0;

                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        monthlySummary[monthIndex].qty += sku.qty || 0;
                        monthlySummary[monthIndex].ret += sku.ret || 0;
                        monthlySummary[monthIndex].amt += sku.amt || 0;
                        monthlySummary[monthIndex].ref += sku.ref || 0;
                    });
                }
            });

            monthlySummary.forEach(m => {
                m.remainingOrders = m.qty - m.ret;
                m.remainingAmount = m.amt - m.ref;
            });

            monthlySummaryTableBody.innerHTML = "";

            let totalQty = 0, totalRet = 0, totalAmt = 0, totalRef = 0, totalRemainingOrders = 0, totalRemainingAmount = 0;

            monthlySummary.forEach((m, i) => {
                totalQty += m.qty;
                totalRet += m.ret;
                totalAmt += m.amt;
                totalRef += m.ref;
                totalRemainingOrders += m.remainingOrders;
                totalRemainingAmount += m.remainingAmount;

                monthlySummaryTableBody.innerHTML += `<tr>
                    <td class="text-center">${monthNames[i]}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatNumber(m.ret)}</td>
                    <td>${formatNumber(m.remainingOrders)}</td>
                    <td>฿${formatNumber(m.amt)}</td>
                    <td>฿${formatNumber(m.ref)}</td>
                    <td>฿${formatNumber(m.remainingAmount)}</td>
                </tr>`;
            });

            document.getElementById("totalMonthlyQty").textContent = formatNumber(totalQty);
            document.getElementById("totalMonthlyRet").textContent = formatNumber(totalRet);
            document.getElementById("totalMonthlyRemainingOrders").textContent = formatNumber(totalRemainingOrders);
            document.getElementById("totalMonthlyAmt").textContent = `฿${formatNumber(totalAmt)}`;
            document.getElementById("totalMonthlyRef").textContent = `฿${formatNumber(totalRef)}`;
            document.getElementById("totalMonthlyRemainingAmount").textContent = `฿${formatNumber(totalRemainingAmount)}`;
        }

        function renderSKUTable(data) {
            skuTableBody.innerHTML = "";

            const skuMap = {};
            data.forEach(entry => {
                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        if (!skuMap[sku.name]) {
                            skuMap[sku.name] = { qty: 0, ret: 0, amt: 0, ref: 0 };
                        }
                        skuMap[sku.name].qty += sku.qty || 0;
                        skuMap[sku.name].ret += sku.ret || 0;
                        skuMap[sku.name].amt += sku.amt || 0;
                        skuMap[sku.name].ref += sku.ref || 0;
                    });
                }
            });

            let skuEntries = Object.entries(skuMap);

            const keyword = searchSKUInput.value.toLowerCase();
            if (keyword) {
                skuEntries = skuEntries.filter(([skuName]) => skuName.toLowerCase().includes(keyword));
            }

            const sortOption = sortOptionSelect.value;
            if (sortOption === "qty") {
                skuEntries.sort((a, b) => b[1].qty - a[1].qty);
            } else if (sortOption === "amt") {
                skuEntries.sort((a, b) => b[1].amt - a[1].amt);
            }

            currentSKUDataForAnalysis = Object.fromEntries(skuEntries); // เก็บข้อมูล SKU ที่ถูกกรองและเรียงลำดับแล้ว

            let sumSkuQty = 0, sumSkuRet = 0, sumSkuAmt = 0, sumSkuRef = 0, sumSkuRemainingAmount = 0; // เพิ่ม sumSkuRemainingAmount

            skuEntries.forEach(([sku, s]) => {
                const remainingAmount = s.amt - s.ref; // คำนวณยอดเงินคงเหลือสำหรับแต่ละ SKU
                skuTableBody.innerHTML += `
                    <tr>
                        <td>${sku}</td>
                        <td>${formatNumber(s.qty)}</td>
                        <td>${formatNumber(s.ret)}</td>
                        <td>฿${formatNumber(s.amt)}</td>
                        <td>฿${formatNumber(s.ref)}</td>
                        <td>฿${formatNumber(remainingAmount)}</td>
                    </tr>
                `;
                sumSkuQty += s.qty;
                sumSkuRet += s.ret;
                sumSkuAmt += s.amt;
                sumSkuRef += s.ref;
                sumSkuRemainingAmount += remainingAmount; // รวม remainingAmount
            });

            document.getElementById("sumSkuQty").textContent = formatNumber(sumSkuQty);
            document.getElementById("sumSkuReturn").textContent = formatNumber(sumSkuRet);
            document.getElementById("sumSkuAmount").textContent = formatNumber(sumSkuAmt);
            document.getElementById("sumSkuRefund").textContent = formatNumber(sumSkuRef);
            document.getElementById("sumSkuRemainingAmount").textContent = formatNumber(sumSkuRemainingAmount); // แสดงสรุป remainingAmount
        }

        // New function to load product names and render the "ยอดกระปุก" table header and body
        async function renderProductJarTable(skuHistoryData) { // รับข้อมูล sku_history ที่ถูกกรองแล้ว
            // 1. ดึงชื่อสินค้าทั้งหมดสำหรับหัวตาราง
            const { data: productNamesData, error: productNamesError } = await client
                .from('product_names')
                .select('product_name')
                .order('product_name', { ascending: true }); // ดึงชื่อสินค้าและเรียงลำดับ

            if (productNamesError) {
                console.error('Error loading product names for Jar Table:', productNamesError.message);
                productJarTableHead.innerHTML = `<tr><th>ไม่สามารถโหลดข้อมูลสินค้าได้</th></tr>`;
                productJarTableBody.innerHTML = `<tr><td colspan="1" class="text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>`; // แสดงข้อผิดพลาดใน body ด้วย
                return;
            }

            if (!productNamesData || productNamesData.length === 0) {
                productJarTableHead.innerHTML = `<tr><th>ไม่พบข้อมูลสินค้า</th></tr>`;
                productJarTableBody.innerHTML = `<tr><td colspan="1">ไม่พบข้อมูลยอดกระปุก</td></tr>`;
                return;
            }

            // สร้างหัวตาราง (<th>) จากชื่อสินค้าที่ได้มา
            const headerHtml = `<tr>${productNamesData.map(p => `<th>${p.product_name}</th>`).join('')}</tr>`;
            productJarTableHead.innerHTML = headerHtml;

            // 2. ดึงข้อมูล SKU composition (product_description) จาก daily_sku_usage_skus
            const { data: skuCompositionData, error: skuCompositionError } = await client
                .from('daily_sku_usage_skus')
                .select('sku_name, product_description');

            if (skuCompositionError) {
                console.error('Error loading SKU compositions:', skuCompositionError.message);
                productJarTableBody.innerHTML = `<tr><td colspan="${productNamesData.length}" class="text-danger">ไม่สามารถโหลดข้อมูลองค์ประกอบ SKU ได้</td></tr>`;
                return;
            }

            const skuCompositionMap = new Map();
            skuCompositionData.forEach(item => {
                skuCompositionMap.set(item.sku_name, parseDescription(item.product_description));
            });

            // 3. คำนวณยอดกระปุกรวมสำหรับแต่ละสินค้า
            const totalJarCountsByProduct = new Map(); // Map เพื่อเก็บยอดกระปุกรวมของแต่ละ product_name

            skuHistoryData.forEach(historyEntry => {
                if (historyEntry.skus && Array.isArray(historyEntry.skus)) {
                    historyEntry.skus.forEach(skuFromHistory => {
                        const skuName = skuFromHistory.name; // SKU name จาก sku_history
                        const skuOrderQty = skuFromHistory.qty || 0; // จำนวนการสั่งซื้อของ SKU นั้นๆ

                        const skuProducts = skuCompositionMap.get(skuName);

                        if (skuProducts) {
                            skuProducts.forEach(productDetail => {
                                const productName = productDetail.product;
                                const productJarQtyInSku = productDetail.qty; // จำนวนกระปุกของสินค้านี้ใน SKU นั้นๆ

                                const jarContribution = skuOrderQty * productJarQtyInSku;

                                totalJarCountsByProduct.set(
                                    productName,
                                    (totalJarCountsByProduct.get(productName) || 0) + jarContribution
                                );
                            });
                        }
                    });
                }
            });

            // 4. เตรียมข้อมูลสำหรับแถวตาราง "ยอดกระปุก"
            let rowHtml = '<tr>';
            productNamesData.forEach(product => {
                const jarCount = totalJarCountsByProduct.get(product.product_name) || 0;
                rowHtml += `<td>${formatNumber(jarCount)}</td>`;
            });
            rowHtml += '</tr>';

            productJarTableBody.innerHTML = rowHtml; // อัปเดต tbody
        }

        // Function for AI Analysis (Placeholder for actual AI integration)
        async function analyzeSKUSales() {
            aiAnalysisContent.innerHTML = `
                <p class="text-center text-muted">กำลังวิเคราะห์ข้อมูล...</p>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            aiAnalysisModal.show();

            // Simulate API call to an AI service
            setTimeout(async () => {
                try {
                    const topSellingSKUs = Object.entries(currentSKUDataForAnalysis)
                        .sort((a, b) => b[1].amt - a[1].amt)
                        .slice(0, 5) // Get top 5 SKUs by amount
                        .map(([name, data]) => `${name} (ยอดขาย ฿${formatNumber(data.amt)}, จำนวน ${formatNumber(data.qty)} ชิ้น)`);

                    const lowestSellingSKUs = Object.entries(currentSKUDataForAnalysis)
                        .sort((a, b) => a[1].amt - b[1].amt)
                        .filter(([name, data]) => data.amt > 0) // Filter out SKUs with 0 sales
                        .slice(0, 5) // Get lowest 5 SKUs by amount
                        .map(([name, data]) => `${name} (ยอดขาย ฿${formatNumber(data.amt)}, จำนวน ${formatNumber(data.qty)} ชิ้น)`);

                    const analysisText = `
                        <h5>ภาพรวมการวิเคราะห์:</h5>
                        <p>ข้อมูลยอดขาย SKU ที่ถูกกรองและเรียงลำดับในปัจจุบัน แสดงให้เห็นแนวโน้มที่น่าสนใจดังนี้:</p>
                        <ul>
                            <li><strong>SKU ยอดนิยม 5 อันดับแรก (ตามยอดขาย):</strong>
                                <ul>
                                    ${topSellingSKUs.length > 0 ? topSellingSKUs.map(sku => `<li>${sku}</li>`).join('') : '<li>ไม่พบข้อมูล SKU ยอดนิยม</li>'}
                                </ul>
                            </li>
                            <li><strong>SKU ที่มียอดขายน้อย 5 อันดับแรก (มากกว่า 0):</strong>
                                <ul>
                                    ${lowestSellingSKUs.length > 0 ? lowestSellingSKUs.map(sku => `<li>${sku}</li>`).join('') : '<li>ไม่พบข้อมูล SKU ที่มียอดขายน้อย</li>'}
                                </ul>
                            </li>
                        </ul>
                        <p class="text-muted"><em>คำแนะนำ:</em> การวิเคราะห์นี้เป็นเพียงข้อมูลเบื้องต้น คุณสามารถนำข้อมูลเหล่านี้ไปพิจารณาเพื่อปรับกลยุทธ์การตลาด, การจัดสต็อกสินค้า หรือการส่งเสริมการขายได้</p>
                    `;
                    aiAnalysisContent.innerHTML = analysisText;
                } catch (error) {
                    aiAnalysisContent.innerHTML = `<p class="text-danger">เกิดข้อผิดพลาดในการวิเคราะห์ข้อมูล: ${error.message}</p>`;
                    console.error("AI Analysis Error:", error);
                }
            }, 1500); // Simulate network delay
        }


        window.addEventListener("DOMContentLoaded", () => {
            yearSelect.value = new Date().getFullYear();
            loadData();
        });
    </script>
</body>
</html>
