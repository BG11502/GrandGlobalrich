<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #f0f2f5; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô */
            font-family: 'Inter', sans-serif; /* ‡πÉ‡∏ä‡πâ Font Inter */
            color: #333;
        }
        .container {
            max-width: 1300px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á container */
        }
        .summary-card {
            min-width: 200px;
            border-radius: 15px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
            transition: transform 0.2s ease-in-out; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° animation ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            height: 100%; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ card ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-card:hover {
            transform: translateY(-5px); /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
        }
        .summary-card .card-body {
            padding: 1.5rem;
        }
        .filter-box {
            border: none; /* ‡∏•‡∏ö border ‡∏≠‡∏≠‡∏Å */
            border-radius: 15px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
            padding: 30px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding */
            background: #fff;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* ‡πÄ‡∏á‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö Card */
        }
        .form-label {
            font-weight: 600; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ label ‡∏î‡∏π‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
            color: #555;
            margin-bottom: 0.5rem;
        }
        .form-select, .form-control {
            border-radius: 10px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input/select */
            border-color: #ced4da; /* ‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö input */
        }
        .month-checkboxes label {
            margin-right: 15px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á checkbox */
        }
        .card {
            border-radius: 15px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô */
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤ */
            border: none; /* ‡∏•‡∏ö border ‡∏Ç‡∏≠‡∏á card */
        }
        .card-header {
            background-color: #f8f9fa; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á header ‡∏Ç‡∏≠‡∏á card */
            border-bottom: 1px solid #e9ecef; /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ö‡∏≤‡πÜ */
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            color: #333;
            border-radius: 15px 15px 0 0 !important; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
        }
        .card-body {
            padding: 1.5rem;
        }
        .btn {
            border-radius: 10px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° */
            padding: 0.6rem 1.2rem;
            font-weight: 500;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #218838;
        }
        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .table {
            margin-bottom: 0;
        }
        .table th, .table td {
            padding: 0.9rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            vertical-align: middle;
        }
        .table thead th {
            border-bottom: 2px solid #dee2e6; /* ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ header ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            font-weight: 600;
            color: #495057;
        }
        .table tbody tr:last-child td {
            border-bottom: none; /* ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ */
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.02); /* ‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡∏•‡∏á */
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,.05); /* ‡∏™‡∏µ hover ‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡∏Ç‡∏∂‡πâ‡∏ô */
        }
        .modal-content {
            border-radius: 15px; /* ‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal */
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        .modal-header {
            border-bottom: none;
            padding: 1.5rem;
        }
        .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem;
        }
        .text-primary {
            color: #007bff !important; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ Bootstrap primary */
        }
        .text-success {
            color: #28a745 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        .fw-bold {
            font-weight: 700 !important;
        }
        /* Custom styling for specific headers */
        .card-header.bg-success {
            background-color: #28a745 !important;
            border-radius: 15px 15px 0 0 !important;
        }
        .table-primary thead {
            background-color: #e0f2ff; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö header ‡∏ï‡∏≤‡∏£‡∏≤‡∏á SKU */
        }
        .table-success thead {
            background-color: #d4edda; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö header ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å */
        }
    </style>
</head>
<body class="p-4">
    <div class="container my-3">
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-outline-secondary" onclick="history.back()"><i class="bi bi-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <a href="index.html" class="btn btn-primary"><i class="bi bi-house-door-fill"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </div>
    </div>

    <div class="container">
        <h3 class="mb-4 fw-bold text-primary">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô</h3>

        <div class="filter-box mb-5">
            <div class="row g-4 align-items-end"> 
                <div class="col-md-3 col-lg-2">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
                    <select id="yearSelect" class="form-select"></select>
                </div>

                <div class="col-md-9 col-lg-6">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö)</label>
                    <div class="d-flex flex-wrap gap-3" id="monthCheckboxes"></div> 
                </div>

                <div class="col-md-6 col-lg-4">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <div class="d-flex gap-2"> 
                        <input type="date" id="startDate" class="form-control">
                        <input type="date" id="endDate" class="form-control">
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô</label>
                    <select id="shopFilter" class="form-select" multiple size="8"> <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-8 d-flex align-items-end justify-content-start gap-3"> 
                    <button class="btn btn-success" onclick="loadData()"><i class="bi bi-check-circle-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
                    <button class="btn btn-outline-danger" onclick="resetFilter()"><i class="bi bi-x-circle-fill"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
                </div>
            </div>
        </div>

        <div class="row mb-5 g-4" id="summaryCards"></div> 
        <div class="card mb-5">
            <div class="card-header fw-bold">
                <i class="bi bi-shop me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
            </div>
            <div class="card-body table-responsive" id="shopTableContainer">
            </div>
        </div>

        <div class="card mt-5">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-check me-2"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleVisibility('monthlySummaryBody', 'toggleMonthlySummaryIcon')">
                    <i id="toggleMonthlySummaryIcon" class="bi bi-eye-slash-fill"></i>
                </button>
            </div>
            <div class="card-body table-responsive d-none" id="monthlySummaryBody">
                <table class="table table-bordered table-hover text-end align-middle table-striped">
                    <thead class="table-light text-center">
                        <tr>
                            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                            <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                            <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        </tr>
                    </thead>
                    <tbody id="monthlySummaryTableBody"></tbody>
                    <tfoot class="table-dark fw-bold">
                        <tr>
                            <td class="text-center">‡∏£‡∏ß‡∏°</td>
                            <td id="totalMonthlyQty">0</td>
                            <td id="totalMonthlyRet">0</td>
                            <td id="totalMonthlyRemainingOrders">0</td>
                            <td id="totalMonthlyAmt">‡∏ø0.00</td>
                            <td id="totalMonthlyRef">‡∏ø0.00</td>
                            <td id="totalMonthlyRemainingAmount">‡∏ø0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="card p-4 mt-5">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-box-seam me-2"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î SKU ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleVisibility('skuTableBodyContainer', 'toggleSkuTableIcon')">
                    <i id="toggleSkuTableIcon" class="bi bi-eye-slash-fill"></i>
                </button>
            </div>
            <div class="card-body d-none" id="skuTableBodyContainer">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchSKU" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SKU" oninput="loadData()" />
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <select id="sortOption" class="form-select w-auto d-inline" onchange="loadData()">
                            <option value="">üîÉ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°...</option>
                            <option value="qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
                            <option value="amt">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢</option>
                        </select>
                        <button class="btn btn-info ms-2" onclick="analyzeSKUSales()"><i class="bi bi-robot"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ SKU</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-center align-middle table-striped">
                        <thead class="table-primary">
                            <tr>
                                <th>SKU</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                                <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            </tr>
                        </thead>
                        <tbody id="skuTableBody"></tbody>
                        <tfoot class="table-dark fw-bold">
                            <tr>
                                <td>‡∏£‡∏ß‡∏°</td>
                                <td id="sumSkuQty">0</td>
                                <td id="sumSkuReturn">0</td>
                                <td id="sumSkuAmount">0.00</td>
                                <td id="sumSkuRefund">0.00</td>
                                <td id="sumSkuRemainingAmount">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-5">
            <div class="card-header bg-success text-white fw-bold">
                <i class="bi bi-boxes me-2"></i> ‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏£‡∏ß‡∏° (‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
            </div>
            <div class="card-body table-responsive">
                <table class="table table-bordered text-center align-middle table-striped">
                    <thead class="table-success" id="productJarTableHead">
                    </thead>
                    <tbody id="productJarTableBody">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiAnalysisModalLabel"><i class="bi bi-stars"></i> ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ SKU ‡∏î‡πâ‡∏ß‡∏¢ AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiAnalysisContent">
                        <p class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login.html
                window.location.href = 'login.html';
            }
        });

        const client = supabase.createClient(
            "https://vzxttbvwukpsxqdaulvo.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
        );

        const yearSelect = document.getElementById("yearSelect");
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");
        const monthCheckboxes = document.getElementById("monthCheckboxes");
        const shopFilter = document.getElementById("shopFilter");
        const searchSKUInput = document.getElementById("searchSKU");
        const sortOptionSelect = document.getElementById("sortOption");

        const monthlySummaryTableBody = document.getElementById("monthlySummaryTableBody");
        const skuTableBody = document.getElementById("skuTableBody");
        const productJarTableHead = document.getElementById("productJarTableHead");
        const productJarTableBody = document.getElementById("productJarTableBody");

        const aiAnalysisModal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
        const aiAnalysisContent = document.getElementById('aiAnalysisContent');

        let currentSKUDataForAnalysis = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß

        const monthNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];

        // Populate year dropdown
        for (let y = 2022; y <= new Date().getFullYear(); y++) {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }

        // Populate month checkboxes
        monthCheckboxes.innerHTML = monthNames.map((m, i) => `
            <div class='form-check'>
                <input class='form-check-input month-check' type='checkbox' value='${i + 1}' id='m${i}'>
                <label class='form-check-label' for='m${i}'>${m}</label>
            </div>`).join("");

        function getSelectedMonths() {
            return Array.from(document.querySelectorAll(".month-check:checked")).map(el => parseInt(el.value));
        }
        
        // --- NEW FUNCTION: Get selected shops from multiple select ---
        function getSelectedShops() {
            const selectedOptions = Array.from(shopFilter.selectedOptions);
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (selectedOptions.some(option => option.value === "") || selectedOptions.length === 0) {
                return []; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ query ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏á shop_name
            }
            return selectedOptions.map(option => option.value);
        }
        // --- END NEW FUNCTION ---

        function resetFilter() {
            document.querySelectorAll(".month-check").forEach(el => el.checked = false);
            startDateInput.value = "";
            endDateInput.value = "";
            // --- MODIFIED: Clear all selections for multiple shop select ---
            Array.from(shopFilter.options).forEach(option => {
                option.selected = false;
            });
            // --- END MODIFIED ---
            searchSKUInput.value = "";
            sortOptionSelect.value = "";
            loadData();
        }

        function formatNumber(num) {
            return num?.toLocaleString("th-TH", { minimumFractionDigits: 2 });
        }

        // Function to toggle visibility
        function toggleVisibility(elementId, iconId) {
            const element = document.getElementById(elementId);
            const icon = document.getElementById(iconId);

            if (element.classList.contains('d-none')) {
                element.classList.remove('d-none');
                icon.classList.remove('bi-eye-slash-fill');
                icon.classList.add('bi-eye-fill');
            } else {
                element.classList.add('d-none');
                icon.classList.remove('bi-eye-fill');
                icon.classList.add('bi-eye-slash-fill');
            }
        }

        // Function to parse product_description string into an array of { product, qty }
        function parseDescription(desc) {
            if (!desc) return [];
            const prefixRemoved = desc.replace(/^‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\s*/, '');
            if (!prefixRemoved) return [];
            const parts = prefixRemoved.split('+');
            return parts.map(part => {
                const m = part.match(/(.+?)\s*([0-9]+)\s*‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å/);
                if (m) {
                    return {
                        product: m[1].trim(),
                        qty: parseInt(m[2], 10)
                    };
                } else {
                    // Handle cases where format might be slightly off, e.g., just a product name without "‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å"
                    return {
                        product: part.trim(),
                        qty: 0 // Default to 0 if quantity not found
                    };
                }
            });
        }

        async function loadData() {
            const selectedYear = parseInt(yearSelect.value);
            const selectedMonths = getSelectedMonths();
            const selectedShops = getSelectedShops(); // --- MODIFIED: Use new function ---

            let startDate, endDate;

            if (selectedMonths.length > 0) {
                const minMonth = Math.min(...selectedMonths);
                const maxMonth = Math.max(...selectedMonths);
                // Adjust for your specific month range (26th of prev month to 25th of current month)
                startDate = dayjs(`${selectedYear}-${String(minMonth).padStart(2, '0')}-26`).subtract(1, 'month').toDate();
                endDate = dayjs(`${selectedYear}-${String(maxMonth).padStart(2, '0')}-25`).toDate();
            } else if (startDateInput.value && endDateInput.value) {
                startDate = new Date(startDateInput.value);
                endDate = new Date(endDateInput.value);
            } else {
                startDate = new Date(selectedYear, 0, 1);
                endDate = new Date(selectedYear, 11, 31);
            }

            let query = client
                .from("sku_history")
                .select("*")
                .gte("date", dayjs(startDate).format("YYYY-MM-DD"))
                .lte("date", dayjs(endDate).format("YYYY-MM-DD"));

            // --- MODIFIED: Use .in() for multiple shop selection ---
            if (selectedShops.length > 0) {
                query = query.in("shop_name", selectedShops);
            }
            // --- END MODIFIED ---

            const { data, error } = await query; // data is sku_history entries

            if (error) {
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
                console.error(error);
                return;
            }

            renderShopList(data);
            renderTable(data);
            loadMonthlySummary(data);
            renderSKUTable(data);
            await renderProductJarTable(data); // Pass sku_history data here
        }

        function renderShopList(data) {
            const uniqueShops = Array.from(new Set(data.map(d => d.shop_name).filter(Boolean)));
            // Keep existing selections if any
            const currentSelectedValues = getSelectedShops(); 

            shopFilter.innerHTML = `<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + uniqueShops.map(shop => {
                const isSelected = currentSelectedValues.includes(shop) ? 'selected' : '';
                return `<option value="${shop}" ${isSelected}>${shop}</option>`;
            }).join("");
        }

        function renderTable(data) {
            const summaryByShop = {};
            let totalAmt = 0, totalQty = 0, totalRet = 0, totalRef = 0;

            data.forEach(entry => {
                const shop = entry.shop_name || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡πâ‡∏≤‡∏ô";
                if (!summaryByShop[shop]) {
                    summaryByShop[shop] = { amt: 0, qty: 0, ret: 0, ref: 0 };
                }

                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        summaryByShop[shop].amt += sku.amt || 0;
                        summaryByShop[shop].qty += sku.qty || 0;
                        summaryByShop[shop].ret += sku.ret || 0;
                        summaryByShop[shop].ref += sku.ref || 0;

                        totalAmt += sku.amt || 0;
                        totalQty += sku.qty || 0;
                        totalRet += sku.ret || 0;
                        totalRef += sku.ref || 0;
                    });
                }
            });

            const remainingOrders = totalQty - totalRet;
            const remainingAmount = totalAmt - totalRef;

            document.getElementById("summaryCards").innerHTML = `
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h6>
                    <h5 class="fw-bold">${formatNumber(totalQty)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h6>
                    <h5 class="text-danger fw-bold">${formatNumber(totalRet)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h6>
                    <h5 class="fw-bold">${formatNumber(remainingOrders)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h6>
                    <h5 class="text-success fw-bold">‡∏ø${formatNumber(totalAmt)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h6>
                    <h5 class="text-danger fw-bold">‡∏ø${formatNumber(totalRef)}</h5></div></div></div>
                <div class="col-md-4 col-lg-2"><div class="card summary-card text-center"><div class="card-body">
                    <h6 class="card-title text-muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h6>
                    <h5 class="fw-bold">‡∏ø${formatNumber(remainingAmount)}</h5></div></div></div>
            `;

            let html = `<table class="table table-bordered table-hover bg-white table-striped">
                <thead class="table-light text-center">
                    <tr>
                        <th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                        <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                        <th>‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</th>
                        <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                        <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                    </tr>
                </thead><tbody>`;

            Object.entries(summaryByShop).forEach(([shop, s]) => {
                const shopRemainingOrders = s.qty - s.ret;
                const shopRemainingAmount = s.amt - s.ref;
                html += `<tr>
                    <td>${shop}</td>
                    <td class="text-end text-success">‡∏ø${formatNumber(s.amt)}</td>
                    <td class="text-end">${formatNumber(s.qty)}</td>
                    <td class="text-end text-danger">${formatNumber(s.ret)}</td>
                    <td class="text-end text-danger">‡∏ø${formatNumber(s.ref)}</td>
                    <td class="text-end">${formatNumber(shopRemainingOrders)}</td>
                    <td class="text-end">‡∏ø${formatNumber(shopRemainingAmount)}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            document.getElementById("shopTableContainer").innerHTML = html;
        }

        function loadMonthlySummary(data) {
            const monthlySummary = Array.from({ length: 12 }, (_, i) => ({ month: i, qty: 0, ret: 0, amt: 0, ref: 0, remainingOrders: 0, remainingAmount: 0 }));

            data.forEach(entry => {
                const date = dayjs(entry.date);
                let monthIndex = date.date() >= 26 ? date.month() + 1 : date.month();
                if (monthIndex === 12) monthIndex = 0;

                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        monthlySummary[monthIndex].qty += sku.qty || 0;
                        monthlySummary[monthIndex].ret += sku.ret || 0;
                        monthlySummary[monthIndex].amt += sku.amt || 0;
                        monthlySummary[monthIndex].ref += sku.ref || 0;
                    });
                }
            });

            monthlySummary.forEach(m => {
                m.remainingOrders = m.qty - m.ret;
                m.remainingAmount = m.amt - m.ref;
            });

            monthlySummaryTableBody.innerHTML = "";

            let totalQty = 0, totalRet = 0, totalAmt = 0, totalRef = 0, totalRemainingOrders = 0, totalRemainingAmount = 0;

            monthlySummary.forEach((m, i) => {
                totalQty += m.qty;
                totalRet += m.ret;
                totalAmt += m.amt;
                totalRef += m.ref;
                totalRemainingOrders += m.remainingOrders;
                totalRemainingAmount += m.remainingAmount;

                monthlySummaryTableBody.innerHTML += `<tr>
                    <td class="text-center">${monthNames[i]}</td>
                    <td>${formatNumber(m.qty)}</td>
                    <td>${formatNumber(m.ret)}</td>
                    <td>${formatNumber(m.remainingOrders)}</td>
                    <td>‡∏ø${formatNumber(m.amt)}</td>
                    <td>‡∏ø${formatNumber(m.ref)}</td>
                    <td>‡∏ø${formatNumber(m.remainingAmount)}</td>
                </tr>`;
            });

            document.getElementById("totalMonthlyQty").textContent = formatNumber(totalQty);
            document.getElementById("totalMonthlyRet").textContent = formatNumber(totalRet);
            document.getElementById("totalMonthlyRemainingOrders").textContent = formatNumber(totalRemainingOrders);
            document.getElementById("totalMonthlyAmt").textContent = `‡∏ø${formatNumber(totalAmt)}`;
            document.getElementById("totalMonthlyRef").textContent = `‡∏ø${formatNumber(totalRef)}`;
            document.getElementById("totalMonthlyRemainingAmount").textContent = `‡∏ø${formatNumber(totalRemainingAmount)}`;
        }

        function renderSKUTable(data) {
            skuTableBody.innerHTML = "";

            const skuMap = {};
            data.forEach(entry => {
                if (entry.skus && Array.isArray(entry.skus)) {
                    entry.skus.forEach(sku => {
                        if (!skuMap[sku.name]) {
                            skuMap[sku.name] = { qty: 0, ret: 0, amt: 0, ref: 0 };
                        }
                        skuMap[sku.name].qty += sku.qty || 0;
                        skuMap[sku.name].ret += sku.ret || 0;
                        skuMap[sku.name].amt += sku.amt || 0;
                        skuMap[sku.name].ref += sku.ref || 0;
                    });
                }
            });

            let skuEntries = Object.entries(skuMap);

            const keyword = searchSKUInput.value.toLowerCase();
            if (keyword) {
                skuEntries = skuEntries.filter(([skuName]) => skuName.toLowerCase().includes(keyword));
            }

            const sortOption = sortOptionSelect.value;
            if (sortOption === "qty") {
                skuEntries.sort((a, b) => b[1].qty - a[1].qty);
            } else if (sortOption === "amt") {
                skuEntries.sort((a, b) => b[1].amt - a[1].amt);
            }

            currentSKUDataForAnalysis = Object.fromEntries(skuEntries); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß

            let sumSkuQty = 0, sumSkuRet = 0, sumSkuAmt = 0, sumSkuRef = 0, sumSkuRemainingAmount = 0; // ‡πÄ‡∏û‡∏¥‡πà‡∏° sumSkuRemainingAmount

            skuEntries.forEach(([sku, s]) => {
                const remainingAmount = s.amt - s.ref; // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ SKU
                skuTableBody.innerHTML += `
                    <tr>
                        <td>${sku}</td>
                        <td>${formatNumber(s.qty)}</td>
                        <td>${formatNumber(s.ret)}</td>
                        <td>‡∏ø${formatNumber(s.amt)}</td>
                        <td>‡∏ø${formatNumber(s.ref)}</td>
                        <td>‡∏ø${formatNumber(remainingAmount)}</td>
                    </tr>
                `;
                sumSkuQty += s.qty;
                sumSkuRet += s.ret;
                sumSkuAmt += s.amt;
                sumSkuRef += s.ref;
                sumSkuRemainingAmount += remainingAmount; // ‡∏£‡∏ß‡∏° remainingAmount
            });

            document.getElementById("sumSkuQty").textContent = formatNumber(sumSkuQty);
            document.getElementById("sumSkuReturn").textContent = formatNumber(sumSkuRet);
            document.getElementById("sumSkuAmount").textContent = formatNumber(sumSkuAmt);
            document.getElementById("sumSkuRefund").textContent = formatNumber(sumSkuRef);
            document.getElementById("sumSkuRemainingAmount").textContent = formatNumber(sumSkuRemainingAmount); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ remainingAmount
        }

        // New function to load product names and render the "‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å" table header and body
        async function renderProductJarTable(skuHistoryData) { // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• sku_history ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            // 1. ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const { data: productNamesData, error: productNamesError } = await client
                .from('product_names')
                .select('product_name')
                .order('product_name', { ascending: true }); // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö

            if (productNamesError) {
                console.error('Error loading product names for Jar Table:', productNamesError.message);
                productJarTableHead.innerHTML = `<tr><th>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</th></tr>`;
                productJarTableBody.innerHTML = `<tr><td colspan="1" class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô body ‡∏î‡πâ‡∏ß‡∏¢
                return;
            }

            if (!productNamesData || productNamesData.length === 0) {
                productJarTableHead.innerHTML = `<tr><th>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th></tr>`;
                productJarTableBody.innerHTML = `<tr><td colspan="1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å</td></tr>`;
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (<th>) ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤
            const headerHtml = `<tr>${productNamesData.map(p => `<th>${p.product_name}</th>`).join('')}</tr>`;
            productJarTableHead.innerHTML = headerHtml;

            // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU composition (product_description) ‡∏à‡∏≤‡∏Å daily_sku_usage_skus
            const { data: skuCompositionData, error: skuCompositionError } = await client
                .from('daily_sku_usage_skus')
                .select('sku_name, product_description');

            if (skuCompositionError) {
                console.error('Error loading SKU compositions:', skuCompositionError.message);
                productJarTableBody.innerHTML = `<tr><td colspan="${productNamesData.length}" class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö SKU ‡πÑ‡∏î‡πâ</td></tr>`;
                return;
            }

            const skuCompositionMap = new Map();
            skuCompositionData.forEach(item => {
                skuCompositionMap.set(item.sku_name, parseDescription(item.product_description));
            });

            // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            const totalJarCountsByProduct = new Map(); // Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ product_name

            skuHistoryData.forEach(historyEntry => {
                if (historyEntry.skus && Array.isArray(historyEntry.skus)) {
                    historyEntry.skus.forEach(skuFromHistory => {
                        const skuName = skuFromHistory.name; // SKU name ‡∏à‡∏≤‡∏Å sku_history
                        const skuOrderQty = skuFromHistory.qty || 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á SKU ‡∏ô‡∏±‡πâ‡∏ô‡πÜ

                        const skuProducts = skuCompositionMap.get(skuName);

                        if (skuProducts) {
                            skuProducts.forEach(productDetail => {
                                const productName = productDetail.product;
                                const productJarQtyInSku = productDetail.qty; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô SKU ‡∏ô‡∏±‡πâ‡∏ô‡πÜ

                                const jarContribution = skuOrderQty * productJarQtyInSku;

                                totalJarCountsByProduct.set(
                                    productName,
                                    (totalJarCountsByProduct.get(productName) || 0) + jarContribution
                                );
                            });
                        }
                    });
                }
            });

            // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á "‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å"
            let rowHtml = '<tr>';
            productNamesData.forEach(product => {
                const jarCount = totalJarCountsByProduct.get(product.product_name) || 0;
                rowHtml += `<td>${formatNumber(jarCount)}</td>`;
            });
            rowHtml += '</tr>';

            productJarTableBody.innerHTML = rowHtml; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï tbody
        }

        // Function for AI Analysis (Placeholder for actual AI integration)
        async function analyzeSKUSales() {
            aiAnalysisContent.innerHTML = `
                <p class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            aiAnalysisModal.show();

            // Simulate API call to an AI service
            setTimeout(async () => {
                try {
                    const topSellingSKUs = Object.entries(currentSKUDataForAnalysis)
                        .sort((a, b) => b[1].amt - a[1].amt)
                        .slice(0, 5) // Get top 5 SKUs by amount
                        .map(([name, data]) => `${name} (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏ø${formatNumber(data.amt)}, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${formatNumber(data.qty)} ‡∏ä‡∏¥‡πâ‡∏ô)`);

                    const lowestSellingSKUs = Object.entries(currentSKUDataForAnalysis)
                        .sort((a, b) => a[1].amt - b[1].amt)
                        .filter(([name, data]) => data.amt > 0) // Filter out SKUs with 0 sales
                        .slice(0, 5) // Get lowest 5 SKUs by amount
                        .map(([name, data]) => `${name} (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡∏ø${formatNumber(data.amt)}, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${formatNumber(data.qty)} ‡∏ä‡∏¥‡πâ‡∏ô)`);

                    const analysisText = `
                        <h5>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</h5>
                        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ SKU ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                        <ul>
                            <li><strong>SKU ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢):</strong>
                                <ul>
                                    ${topSellingSKUs.length > 0 ? topSellingSKUs.map(sku => `<li>${sku}</li>`).join('') : '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</li>'}
                                </ul>
                            </li>
                            <li><strong>SKU ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0):</strong>
                                <ul>
                                    ${lowestSellingSKUs.length > 0 ? lowestSellingSKUs.map(sku => `<li>${sku}</li>`).join('') : '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢</li>'}
                                </ul>
                            </li>
                        </ul>
                        <p class="text-muted"><em>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</em> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î, ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
                    `;
                    aiAnalysisContent.innerHTML = analysisText;
                } catch (error) {
                    aiAnalysisContent.innerHTML = `<p class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>`;
                    console.error("AI Analysis Error:", error);
                }
            }, 1500); // Simulate network delay
        }


        window.addEventListener("DOMContentLoaded", () => {
            yearSelect.value = new Date().getFullYear();
            loadData();
        });
    </script>
</body>
</html>
