<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + Supabase CRUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h3 class="mb-4">üìÑ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå </h3>

    <div class="mb-3">
      <label for="inputText" class="form-label">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</label>
      <textarea id="inputText" class="form-control" rows="10" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô:
134
‡∏ä‡∏∑‡πà‡∏≠ ‡∏•‡∏±‡∏î‡∏î‡∏≤‡∏ß‡∏±‡∏•‡∏¢‡πå ‡∏®‡∏£‡∏µ‡πÄ‡∏™‡∏£‡∏¥‡∏°(a‡∏°)
‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà 46/2 ‡∏°.3 ‡∏ï.‡∏£‡∏≥‡∏û‡∏±‡∏ô
‡∏≠.‡∏ó‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏à.‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ 22170
‡πÇ‡∏ó‡∏£.0828924150

S3 1
COD
‡πÄ‡∏û‡∏à ‡∏ã‡∏≤‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πà‡∏≤ ‡πÄ‡∏û‡∏à‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå 
FB Kikk Pluempak 
*‡∏ã‡∏≤‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πà‡∏≤ 1‡πÅ‡∏ñ‡∏°2 COD 199
@USR80"></textarea>
    </div>

    <button class="btn btn-primary mb-4" onclick="convertText()">‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button class="btn btn-info mb-3" onclick="exportToExcel()">üì• Export Excel</button>

    <h5 class="text-success">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h5>
    <form id="orderForm" class="row g-3 mb-4" onsubmit="event.preventDefault(); saveOrUpdateOrder();">
      <input type="hidden" id="recordId" />

      <div class="col-md-2">
        <label class="form-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà *</label>
        <input type="text" class="form-control" id="orderId" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
        <input type="text" class="form-control" id="customerName" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£1 *</label>
        <input type="text" class="form-control" id="phone1" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£2</label>
        <input type="text" class="form-control" id="phone2">
      </div>

      <div class="col-md-6">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏• *</label>
        <input type="text" class="form-control" id="socialName" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô *</label>
        <input type="text" class="form-control" id="payment" required>
      </div>

      <div class="col-md-12">
        <label class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà *</label>
        <input type="text" class="form-control" id="address" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏• *</label>
        <input type="text" class="form-control" id="subdistrict" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ *</label>
        <input type="text" class="form-control" id="district" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</label>
        <input type="text" class="form-control" id="province" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå *</label>
        <input type="text" class="form-control" id="zipcode" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® *</label>
        <input type="text" class="form-control" id="country" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">‡∏Ç‡∏ô‡∏™‡πà‡∏á *</label>
        <input type="text" class="form-control" id="shipping" required value="kerry">
      </div>

      <div class="col-md-6">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô) *</label>
        <input type="text" class="form-control" id="skuQty" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input type="number" min="0" step="0.01" class="form-control" id="productPrice" value="0">
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
        <input type="number" min="0" step="0.01" class="form-control" id="productDiscount" value="0">
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="number" min="0" step="0.01" class="form-control" id="orderDiscount" value="0">
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</label>
        <input type="number" min="0" step="0.01" class="form-control" id="shippingFee" value="0">
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
        <input type="number" min="0" step="0.01" class="form-control" id="codFee" value="0">
      </div>

      <div class="col-md-3">
        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="date" class="form-control" id="orderDate" required>
      </div>

      <div class="col-md-12">
        <label class="form-label">‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏ô‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏±‡∏™‡∏î‡∏∏</label>
        <input type="text" class="form-control" id="note">
      </div>

      <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-success" id="saveBtn">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">üßπ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </form>

    <hr />

    <h5 class="mb-3">üìë ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h5>
    <input type="text" id="searchOrderId" class="form-control mb-3" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)" oninput="filterOrders()" />

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle" id="ordersTable">
        <thead class="table-dark">
          <tr>
            <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£1</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£2</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•</th>
            <th>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
            <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
            <th>‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•</th>
            <th>‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
            <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
            <th>‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</th>
            <th>‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô) *</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</th>
            <th>‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡πÇ‡∏ô‡πâ‡∏ï</th>
            <th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
            <th>‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
  </div>

<script>
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Supabase
  const SUPABASE_URL = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á client Supabase
  supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function convertText() {
    const text = document.getElementById('inputText').value;
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);

    const getValue = (key, fallback = '') =>
      lines.find(l => l.includes(key))?.replace(key, '').trim() || fallback;

    // ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà
    document.getElementById('orderId').value = lines[0] || '';

    // ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    document.getElementById('customerName').value = getValue('‡∏ä‡∏∑‡πà‡∏≠');

    // ‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏Ñ‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏π‡πà (‡∏ï‡∏±‡∏î‡∏ï‡∏≥‡∏ö‡∏•‡∏≠‡∏≠‡∏Å)
    const rawAddressLine = lines.find(l => l.startsWith('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà')) || '';
    let addressOnly = rawAddressLine.replace('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', '').trim();
    const ‡∏ïIndex = addressOnly.indexOf('‡∏ï.');
    if (‡∏ïIndex !== -1) {
      addressOnly = addressOnly.substring(0, ‡∏ïIndex).trim();
    }
    document.getElementById('address').value = addressOnly;

    const rawText = lines.join(' ');

    // ‡∏î‡∏∂‡∏á‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•, ‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    const subdistrictMatch = rawText.match(/‡∏ï\.\s*([^\s]+)/);
    const districtMatch = rawText.match(/‡∏≠\.\s*([^\s]+)/);
    const provinceMatch = rawText.match(/‡∏à\.\s*([^\s]+)/);

    document.getElementById('subdistrict').value = subdistrictMatch?.[1] || '';
    document.getElementById('district').value = districtMatch?.[1] || '';
    document.getElementById('province').value = provinceMatch?.[1] || '';

    // ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå 5 ‡∏´‡∏•‡∏±‡∏Å
    document.getElementById('zipcode').value = rawText.match(/\d{5}/)?.[0] || '';

    // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£1 (‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ó‡∏£.0828924150)
    document.getElementById('phone1').value = rawText.match(/‡πÇ‡∏ó‡∏£\.*\s*(\d{9,10})/)?.[1] || '';

    // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£2 ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ (‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)
    document.getElementById('phone2').value = '';
    
    // SKU + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ S)
    document.getElementById('skuQty').value = lines.find(l => /^S/i.test(l)) || '';

    // ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô COD ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏≠‡∏ô
    const paymentLine = lines.find(l => /^COD$|^‡πÇ‡∏≠‡∏ô$/i.test(l)) || '';
    document.getElementById('payment').value = paymentLine || '';

    // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å COD ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏≠‡∏ô ‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "COD 199"
    const codPriceMatch = rawText.match(/COD\s*(\d+(\.\d+)?)/i);
    const transferPriceMatch = rawText.match(/‡πÇ‡∏≠‡∏ô\s*(\d+(\.\d+)?)/i);

    document.getElementById('productPrice').value =
      codPriceMatch ? codPriceMatch[1] :
      transferPriceMatch ? transferPriceMatch[1] :
      '';

    // ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ FB ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const socialLine = lines.find(l => /^FB\s+/i.test(l));
    document.getElementById('socialName').value = socialLine ? socialLine.trim() : '';

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.getElementById('productDiscount').value = 0;
    document.getElementById('orderDiscount').value = 0;
    document.getElementById('shippingFee').value = 0;
    document.getElementById('codFee').value = 0;
    document.getElementById('shipping').value = 'kerry'; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô kerry ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
    document.getElementById('country').value = '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢';
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('note').value = '';
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  async function saveOrUpdateOrder() {
    const recordId = document.getElementById('recordId').value;
    const order = {
      order_id: document.getElementById('orderId').value,
      customer_name: document.getElementById('customerName').value,
      phone1: document.getElementById('phone1').value,
      phone2: document.getElementById('phone2').value,
      social_name: document.getElementById('socialName').value,
      payment: document.getElementById('payment').value,
      address: document.getElementById('address').value,
      subdistrict: document.getElementById('subdistrict').value,
      district: document.getElementById('district').value,
      province: document.getElementById('province').value,
      zipcode: document.getElementById('zipcode').value,
      country: document.getElementById('country').value,
      shipping: document.getElementById('shipping').value,
      sku_qty: document.getElementById('skuQty').value,
      product_price: parseFloat(document.getElementById('productPrice').value) || 0,
      product_discount: parseFloat(document.getElementById('productDiscount').value) || 0,
      order_discount: parseFloat(document.getElementById('orderDiscount').value) || 0,
      shipping_fee: parseFloat(document.getElementById('shippingFee').value) || 0,
      cod_fee: parseFloat(document.getElementById('codFee').value) || 0,
      order_date: document.getElementById('orderDate').value,
      note: document.getElementById('note').value,
    };

    if (!order.order_id) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå');
      return;
    }

    if (recordId) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const { data, error } = await supabase
        .from('orders')
        .update(order)
        .eq('id', recordId);

      if (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + error.message);
        console.error(error);
      } else {
        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        resetForm();
        loadOrders();
      }
    } else {
      // ‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      const { data, error } = await supabase
        .from('orders')
        .insert([order]);

      if (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message);
        console.error(error);
      } else {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        resetForm();
        loadOrders();
      }
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  async function loadOrders() {
    const { data, error } = await supabase
      .from('orders')
      .select()
      .order('created_at', { ascending: false });

    if (error) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      console.error(error);
      return;
    }

    const tbody = document.getElementById('ordersTbody');
    tbody.innerHTML = '';

    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.order_id || ''}</td>
        <td>${item.customer_name || ''}</td>
        <td>${item.phone1 || ''}</td>
        <td>${item.phone2 || ''}</td>
        <td>${item.social_name || ''}</td>
        <td>${item.payment || ''}</td>
        <td>${item.address || ''}</td>
        <td>${item.subdistrict || ''}</td>
        <td>${item.district || ''}</td>
        <td>${item.province || ''}</td>
        <td>${item.zipcode || ''}</td>
        <td>${item.country || ''}</td>
        <td>${item.shipping || ''}</td>
        <td>${item.sku_qty || ''}</td>
        <td>${item.product_price ?? 0}</td>
        <td>${item.product_discount ?? 0}</td>
        <td>${item.order_discount ?? 0}</td>
        <td>${item.shipping_fee ?? 0}</td>
        <td>${item.cod_fee ?? 0}</td>
        <td>${item.order_date || ''}</td>
        <td>${item.note || ''}</td>
        <td><button class="btn btn-sm btn-warning" onclick="editOrder('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteOrder('${item.id}')">‡∏•‡∏ö</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  async function editOrder(id) {
    const { data, error } = await supabase
      .from('orders')
      .select()
      .eq('id', id)
      .single();

    if (error) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      return;
    }

    const order = data;
    document.getElementById('recordId').value = order.id;
    document.getElementById('orderId').value = order.order_id || '';
    document.getElementById('customerName').value = order.customer_name || '';
    document.getElementById('phone1').value = order.phone1 || '';
    document.getElementById('phone2').value = order.phone2 || '';
    document.getElementById('socialName').value = order.social_name || '';
    document.getElementById('payment').value = order.payment || '';
    document.getElementById('address').value = order.address || '';
    document.getElementById('subdistrict').value = order.subdistrict || '';
    document.getElementById('district').value = order.district || '';
    document.getElementById('province').value = order.province || '';
    document.getElementById('zipcode').value = order.zipcode || '';
    document.getElementById('country').value = order.country || '';
    document.getElementById('shipping').value = order.shipping || '';
    document.getElementById('skuQty').value = order.sku_qty || '';
    document.getElementById('productPrice').value = order.product_price ?? 0;
    document.getElementById('productDiscount').value = order.product_discount ?? 0;
    document.getElementById('orderDiscount').value = order.order_discount ?? 0;
    document.getElementById('shippingFee').value = order.shipping_fee ?? 0;
    document.getElementById('codFee').value = order.cod_fee ?? 0;
    document.getElementById('orderDate').value = order.order_date || '';
    document.getElementById('note').value = order.note || '';

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  async function deleteOrder(id) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

    const { error } = await supabase
      .from('orders')
      .delete()
      .eq('id', id);

    if (error) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ' + error.message);
      return;
    }

    alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    loadOrders();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
  function resetForm() {
    document.getElementById('orderForm').reset();
    document.getElementById('recordId').value = '';
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà
  async function filterOrders() {
    const filter = document.getElementById('searchOrderId').value.trim().toLowerCase();

    if (!filter) {
      loadOrders();
      return;
    }

    const { data, error } = await supabase
      .from('orders')
      .select()
      .ilike('order_id', `%${filter}%`)
      .order('created_at', { ascending: false });

    if (error) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + error.message);
      return;
    }

    const tbody = document.getElementById('ordersTbody');
    tbody.innerHTML = '';

    data.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.order_id || ''}</td>
        <td>${item.customer_name || ''}</td>
        <td>${item.phone1 || ''}</td>
        <td>${item.phone2 || ''}</td>
        <td>${item.social_name || ''}</td>
        <td>${item.payment || ''}</td>
        <td>${item.address || ''}</td>
        <td>${item.subdistrict || ''}</td>
        <td>${item.district || ''}</td>
        <td>${item.province || ''}</td>
        <td>${item.zipcode || ''}</td>
        <td>${item.country || ''}</td>
        <td>${item.shipping || ''}</td>
        <td>${item.sku_qty || ''}</td>
        <td>${item.product_price ?? 0}</td>
        <td>${item.product_discount ?? 0}</td>
        <td>${item.order_discount ?? 0}</td>
        <td>${item.shipping_fee ?? 0}</td>
        <td>${item.cod_fee ?? 0}</td>
        <td>${item.order_date || ''}</td>
        <td>${item.note || ''}</td>
        <td><button class="btn btn-sm btn-warning" onclick="editOrder('${item.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        <td><button class="btn btn-sm btn-danger" onclick="deleteOrder('${item.id}')">‡∏•‡∏ö</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel ‡πÑ‡∏ü‡∏•‡πå
  function exportToExcel() {
    const headers = [
      '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà', '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£1', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£2', '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•', '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
      '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', '‡πÅ‡∏Ç‡∏ß‡∏á/‡∏ï‡∏≥‡∏ö‡∏•', '‡πÄ‡∏Ç‡∏ï/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', '‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', '‡∏Ç‡∏ô‡∏™‡πà‡∏á',
      '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô) ', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á', '‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á',
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', '‡πÇ‡∏ô‡πâ‡∏ï'
    ];

    const tbody = document.getElementById('ordersTbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const data = rows.map(tr => {
      const cells = tr.querySelectorAll('td');
      return Array.from(cells).slice(0, headers.length).map(td => td.textContent.trim());
    });

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á workbook ‡πÅ‡∏•‡∏∞ worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    XLSX.utils.book_append_sheet(wb, ws, 'Orders');

    XLSX.writeFile(wb, 'orders_export.xlsx');
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
  window.onload = () => {
    resetForm();
    loadOrders();
  };
</script>
</body>
</html>
