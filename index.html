<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .sidebar { width: 240px; background-color: #343a40; min-height: 100vh; color: white; }
    .sidebar .nav-link { color: white; }
    .sidebar .nav-link:hover { background-color: #495057; }
    td[title] { cursor: help; }
    .table th, .table td { white-space: nowrap; }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <div class="d-flex">
    <div class="sidebar p-4">
      <h4 class="mb-4">üì¶ ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
      <ul class="nav flex-column">
        <li><a class="nav-link" href="#">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° SKU</a></li>
        <li><a class="nav-link" href="‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
        <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô.html">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a></li>
        <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
        <li><a class="nav-link" href="‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤.html">‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>
        <li><a class="nav-link" href="‡πÄ‡∏û‡∏¥‡πà‡∏°sku.html">‡πÄ‡∏û‡∏¥‡∏°sku</a></li>
        <li><a class="nav-link" href="#" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li> </ul>
    </div>

    <div class="flex-grow-1 p-4">
      <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h6><h4 id="totalAmountCard">0.00</h4></div></div>
        <div class="col-md-3"><div class="card p-3"><h6>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h6><h4 id="totalQtyCard">0</h4></div></div>
        <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h6><h4 id="totalRefundCard">0.00</h4></div></div>
        <div class="col-md-3"><div class="card p-3"><h6>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</h6><h4 id="totalReturnCard">0</h4></div></div>
      </div>

      <div class="card p-4 mb-4">
        <h2 class="mb-4 text-primary">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</h2>
        <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-3" />
        <div class="row g-2 mb-3">
          <div class="col-md-6"><input type="date" id="recordStartDate" class="form-control" /></div>
          <div class="col-md-6"><input type="date" id="recordEndDate" class="form-control" /></div>
        </div>
        <div class="row g-2 mb-4">
          <div class="col-md-8">
            <select class="form-select" id="shopSelect"></select>
          </div>
          <div class="col-md-4 d-grid">
            <button class="btn btn-outline-secondary" type="button" id="addShopBtn">
              <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>
        </div>

        <button class="btn btn-primary mb-4" type="button" id="saveMultipleDatesBtn">
          <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        </button>

        <div class="table-responsive">
          <table class="table table-bordered table-hover text-center align-middle">
            <thead class="table-primary">
              <tr>
                <th>Seller SKU</th>
                <th>Quantity</th>
                <th>Return</th>
                <th>Order Amount</th>
                <th>Refund</th>
              </tr>
            </thead>
            <tbody id="summaryBody"></tbody>
            <tfoot class="table-dark fw-bold">
              <tr>
                <td>‡∏£‡∏ß‡∏°</td>
                <td id="totalQty">0</td>
                <td id="totalReturn">0</td>
                <td id="totalAmount">0.00</td>
                <td id="totalRefund">0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="text-danger mb-0">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
          <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#historyCollapse" aria-expanded="false" aria-controls="historyCollapse">
            ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô
          </button>
        </div>

        <div class="collapse" id="historyCollapse">
          <div class="row g-2 mb-3">
            <div class="col-md-5"><input type="date" class="form-control" id="filterStartDate" /></div>
            <div class="col-md-5"><input type="date" class="form-control" id="filterEndDate" /></div>
            <div class="col-md-2 d-grid">
              <button class="btn btn-outline-primary" type="button" id="applyFilterBtn">
                <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
              <thead class="table-danger">
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</th>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="historyList">
                <tr><td colspan="3" class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
    document.addEventListener("DOMContentLoaded", () => {
      const loggedInUser = localStorage.getItem('loggedInUser');
      if (!loggedInUser) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login.html
        window.location.href = 'login.html';
      }
      // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      // console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà:", JSON.parse(loggedInUser).username);
    });

    // ‡πÇ‡∏Ñ‡πâ‡∏î Supabase ‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const _supabase = supabase.createClient(
      "https://vzxttbvwukpsxqdaulvo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
    );

    const excelFileInput = document.getElementById("excelFile");
    const summaryBody = document.getElementById("summaryBody");
    const totalQtyEl = document.getElementById("totalQty");
    const totalReturnEl = document.getElementById("totalReturn");
    const totalAmountEl = document.getElementById("totalAmount");
    const totalRefundEl = document.getElementById("totalRefund");

    const totalQtyCard = document.getElementById("totalQtyCard");
    const totalReturnCard = document.getElementById("totalReturnCard");
    const totalAmountCard = document.getElementById("totalAmountCard");
    const totalRefundCard = document.getElementById("totalRefundCard");

    const recordStartDateInput = document.getElementById("recordStartDate");
    const recordEndDateInput = document.getElementById("recordEndDate");
    const shopSelect = document.getElementById("shopSelect");
    const addShopBtn = document.getElementById("addShopBtn");
    const saveMultipleDatesBtn = document.getElementById("saveMultipleDatesBtn");

    const filterStartDateInput = document.getElementById("filterStartDate");
    const filterEndDateInput = document.getElementById("filterEndDate");
    const applyFilterBtn = document.getElementById("applyFilterBtn");
    const historyListTbody = document.getElementById("historyList");
    const logoutBtn = document.getElementById("logoutBtn"); // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö

    let excelData = null;
    let summaryData = null;
    let shopList = [];
    let historyData = [];

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem('loggedInUser'); // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å localStorage
      window.location.href = 'login.html'; // ‡∏û‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
    });

    excelFileInput.addEventListener("change", handleExcelUpload);
    addShopBtn.addEventListener("click", handleAddNewShop);
    saveMultipleDatesBtn.addEventListener("click", handleSaveMultipleDates);
    applyFilterBtn.addEventListener("click", applyHistoryFilter);

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô DOMContentLoaded ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ loadShopsFromSupabase ‡πÅ‡∏•‡∏∞ fetchHistoryFromSupabase ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    document.addEventListener("DOMContentLoaded", async () => {
      // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß
      await loadShopsFromSupabase();
      await fetchHistoryFromSupabase();
    });

    function handleExcelUpload(e) {
      const file = e.target.files[0];
      if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel");
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: 0 });
        if (!jsonData.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");
        excelData = jsonData;
        summarizeData();
      };
      reader.readAsArrayBuffer(file);
    }

    function summarizeData() {
      const summary = {};
      summaryBody.innerHTML = "";
      let tQ = 0, tR = 0, tA = 0, tF = 0;

      excelData.forEach(row => {
        const sku = row["Seller SKU"] || row["SKU"] || row["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
        const qty = parseFloat(row["Quantity"] || 0) || 0;
        const ret = parseFloat(row["Sku Quantity of return"] || 0) || 0;
        const amt = parseFloat(row["Order Amount"] || 0) || 0;
        const ref = parseFloat(row["Order Refund Amount"] || 0) || 0;
        if (!summary[sku]) summary[sku] = { qty: 0, ret: 0, amt: 0, ref: 0 };
        summary[sku].qty += qty;
        summary[sku].ret += ret;
        summary[sku].amt += amt;
        summary[sku].ref += ref;
        tQ += qty;
        tR += ret;
        tA += amt;
        tF += ref;
      });

      Object.entries(summary).forEach(([sku, obj]) => {
        summaryBody.innerHTML += `
          <tr>
            <td title="${sku}">${sku}</td>
            <td>${obj.qty}</td>
            <td>${obj.ret}</td>
            <td>${obj.amt.toFixed(2)}</td>
            <td>${obj.ref.toFixed(2)}</td>
          </tr>
        `;
      });

      totalQtyEl.textContent = tQ;
      totalReturnEl.textContent = tR;
      totalAmountEl.textContent = tA.toFixed(2);
      totalRefundEl.textContent = tF.toFixed(2);

      totalQtyCard.textContent = tQ;
      totalReturnCard.textContent = tR;
      totalAmountCard.textContent = tA.toFixed(2);
      totalRefundCard.textContent = tF.toFixed(2);

      summaryData = { tQ, tR, tA, tF, skuCount: Object.keys(summary).length, summary };
    }

    async function syncNewSkusToDailySkuUsage() {
      if (!summaryData) return;

      const { data: existingSkus, error } = await _supabase
        .from("daily_sku_usage_skus")
        .select("sku_name");

      if (error) {
        console.error("‡πÇ‡∏´‡∏•‡∏î SKU ‡∏´‡∏•‡∏±‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
        return;
      }

      const existingSkuSet = new Set(existingSkus.map(s => s.sku_name));

      const newSkus = Object.keys(summaryData.summary).filter(sku => !existingSkuSet.has(sku) && sku !== "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏");

      if (newSkus.length === 0) {
        console.log("‡πÑ‡∏°‡πà‡∏°‡∏µ SKU ‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°");
        return;
      }

      const insertRows = newSkus.map(sku => ({
        sku_name: sku,
        created_at: new Date().toISOString()
      }));

      const { error: insertError } = await _supabase
        .from("daily_sku_usage_skus")
        .insert(insertRows);

      if (insertError) {
        console.error("‡πÄ‡∏û‡∏¥‡πà‡∏° SKU ‡πÉ‡∏´‡∏°‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", insertError);
      } else {
        console.log(`‡πÄ‡∏û‡∏¥‡πà‡∏° SKU ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${newSkus.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, newSkus);
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° SKU ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${newSkus.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
      }
    }

    async function handleSaveMultipleDates() {
      if (!summaryData || !excelData) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô");
      const start = recordStartDateInput.value;
      const end = recordEndDateInput.value;
      const shop = shopSelect.value;

      if (!start || !end) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
      if (!shop) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

      const startDate = new Date(start);
      const endDate = new Date(end);
      if (startDate > endDate) return alert("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î");

      // ‡∏ã‡∏¥‡∏á‡∏Å‡πå SKU ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      await syncNewSkusToDailySkuUsage();

      const skuList = Object.entries(summaryData.summary).map(([sku, obj]) => ({ name: sku, ...obj }));
      const rows = [];

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        rows.push({
          date: d.toISOString().slice(0, 10),
          total_qty: summaryData.tQ,
          total_return: summaryData.tR,
          total_amount: summaryData.tA,
          total_refund: summaryData.tF,
          sku_count: summaryData.skuCount,
          skus: skuList,
          shop_name: shop
        });
      }

      const { error } = await _supabase.from("sku_history").insert(rows);
      if (error) {
        console.error("Insert error:", error);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      } else {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        await fetchHistoryFromSupabase();
      }
    }

    async function loadShopsFromSupabase() {
      const { data, error } = await _supabase.from("sku_history").select("shop_name").not("shop_name", "is", null);
      if (error) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", error);
        return;
      }
      const uniqueShops = [...new Set(data.map(row => row.shop_name).filter(Boolean))];
      shopList = uniqueShops;

      renderShopSelect();
    }

    function renderShopSelect() {
      shopSelect.innerHTML = shopList.map(shop => `<option value="${shop}">${shop}</option>`).join("");
      if (shopList.length > 0) shopSelect.value = shopList[0];
    }

    function handleAddNewShop() {
      const name = prompt("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:");
      if (!name) return;
      if (shopList.includes(name)) {
        alert("‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö");
        return;
      }
      shopList.push(name);
      renderShopSelect();
      shopSelect.value = name;
    }

    async function fetchHistoryFromSupabase() {
      const { data, error } = await _supabase.from("sku_history").select("id, date, shop_name").order("date", { ascending: true });
      if (error) {
        console.error("Fetch error:", error);
        return;
      }
      historyData = data || [];
      renderHistoryList(historyData);
    }

    function renderHistoryList(data) {
      historyListTbody.innerHTML = "";
      if (!data.length) {
        historyListTbody.innerHTML = `<tr><td colspan="3" class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;
        return;
      }
      data.forEach((entry, i) => {
        historyListTbody.innerHTML += `
        <tr>
          <td>
            <span id="date-${i}">${entry.date}</span>
            <input type="date" class="form-control d-none" id="editDate-${i}" value="${entry.date}">
          </td>
          <td>
            <span id="shop-${i}">${entry.shop_name || "-"}</span>
            <input type="text" class="form-control d-none" id="editShop-${i}" value="${entry.shop_name || ""}">
          </td>
          <td>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditRow(${i})" aria-label="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-sm btn-outline-success me-1 d-none" id="saveBtn-${i}" onclick="saveEditedDate(${i}, '${entry.id}')" aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="bi bi-check-circle"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${entry.id}', '${entry.date}')" aria-label="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
        `;
      });
    }

    function toggleEditRow(index) {
      document.getElementById(`date-${index}`).classList.toggle("d-none");
      document.getElementById(`editDate-${index}`).classList.toggle("d-none");
      document.getElementById(`shop-${index}`).classList.toggle("d-none");
      document.getElementById(`editShop-${index}`).classList.toggle("d-none");
      document.getElementById(`saveBtn-${index}`).classList.toggle("d-none");
    }

    async function saveEditedDate(index, id) {
      const newDate = document.getElementById(`editDate-${index}`).value;
      const newShop = document.getElementById(`editShop-${index}`).value.trim();
      if (!newDate) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà");
      if (!newShop) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô");

      const { error } = await _supabase
        .from("sku_history")
        .update({ date: newDate, shop_name: newShop })
        .eq("id", id);

      if (error) {
        alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        console.error(error);
      } else {
        alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        await fetchHistoryFromSupabase();
      }
    }

    async function deleteHistory(id, date) {
      if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

      const { error } = await _supabase.from("sku_history").delete().eq("id", id);

      if (error) {
        alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        console.error(error);
      } else {
        alert("‚úÖ ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        await fetchHistoryFromSupabase();
      }
    }

    function applyHistoryFilter() {
      const start = filterStartDateInput.value;
      const end = filterEndDateInput.value;
      const filtered = historyData.filter(entry => {
        if (start && entry.date < start) return false;
        if (end && entry.date > end) return false;
        return true;
      });
      renderHistoryList(filtered);
    }
  </script>

</body>
</html>
