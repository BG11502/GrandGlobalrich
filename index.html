<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .sidebar { width: 240px; background-color: #343a40; min-height: 100vh; color: white; }
    .sidebar .nav-link { color: white; }
    .sidebar .nav-link:hover { background-color: #495057; }
    td[title] { cursor: help; }
    .table th, .table td { white-space: nowrap; }
  </style>
</head>
<body>
<div class="d-flex">
  <div class="sidebar p-4">
    <h4 class="mb-4">üì¶ ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
    <ul class="nav flex-column">
      <li><a class="nav-link" href="#">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° SKU</a></li>
      <li><a class="nav-link" href="‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
      <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô.html">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a></li>
      <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
    </ul>
  </div>

  <div class="flex-grow-1 p-4">
    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h6><h4 id="totalAmountCard">0.00</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h6><h4 id="totalQtyCard">0</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h6><h4 id="totalRefundCard">0.00</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</h6><h4 id="totalReturnCard">0</h4></div></div>
    </div>

    <!-- Store Selector -->
    <div class="card p-4 mb-4">
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô:</label>
          <select class="form-select" id="storeSelect"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:</label>
          <div class="input-group">
            <input type="text" class="form-control" id="newStoreName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
            <button class="btn btn-success" onclick="addNewStore()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload + Table -->
    <div class="card p-4 mb-4">
      <h2 class="mb-4 text-primary">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</h2>
      <input type="file" id="excelFile" accept=".xlsx" class="form-control mb-3">
      <div class="row g-2 mb-3">
        <div class="col-md-6"><input type="date" id="recordStartDate" class="form-control"></div>
        <div class="col-md-6"><input type="date" id="recordEndDate" class="form-control"></div>
      </div>
      <button class="btn btn-primary mb-4" onclick="saveToSupabase()">
        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      </button>
      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center align-middle">
          <thead class="table-primary">
            <tr><th>Seller SKU</th><th>Quantity</th><th>Return</th><th>Order Amount</th><th>Refund</th></tr>
          </thead>
          <tbody id="summaryBody"></tbody>
          <tfoot class="table-dark fw-bold">
            <tr>
              <td>‡∏£‡∏ß‡∏°</td><td id="totalQty">0</td><td id="totalReturn">0</td>
              <td id="totalAmount">0.00</td><td id="totalRefund">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- History Table -->
    <div class="card p-4">
      <h5 class="mb-3 text-danger">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
      <div class="row g-2 mb-3">
        <div class="col-md-5"><input type="date" class="form-control" id="filterStartDate"></div>
        <div class="col-md-5"><input type="date" class="form-control" id="filterEndDate"></div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-outline-primary" onclick="filterHistory()">
            <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center">
          <thead class="table-danger"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡πâ‡∏≤‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody id="historyList"><tr><td colspan="3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const supabase = supabase.createClient(
  "https://vzxttbvwukpsxqdaulvo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
);

let stores = [];

async function loadStores() {
  const { data, error } = await supabase.from("stores").select("name").order("name");
  if (!error) {
    stores = data.map(s => s.name);
    const select = document.getElementById("storeSelect");
    select.innerHTML = stores.map(s => `<option>${s}</option>`).join("");
  }
}

async function addNewStore() {
  const name = document.getElementById("newStoreName").value.trim();
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô");
  if (stores.includes(name)) return alert("‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
  const { error } = await supabase.from("stores").insert([{ name }]);
  if (error) return alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  await loadStores();
  document.getElementById("storeSelect").value = name;
  document.getElementById("newStoreName").value = "";
}

function summarizeData() {
  const body = document.getElementById("summaryBody");
  const summary = {}, data = window.excelData;
  let tQ=0, tR=0, tA=0, tF=0;
  body.innerHTML = "";
  data.forEach(row => {
    const sku = row["Seller SKU"] || row["SKU"] || row["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const qty = +row["Quantity"] || 0;
    const ret = +row["Sku Quantity of return"] || 0;
    const amt = +row["Order Amount"] || 0;
    const ref = +row["Order Refund Amount"] || 0;
    if (!summary[sku]) summary[sku] = { qty: 0, ret: 0, amt: 0, ref: 0 };
    summary[sku].qty += qty;
    summary[sku].ret += ret;
    summary[sku].amt += amt;
    summary[sku].ref += ref;
    tQ += qty; tR += ret; tA += amt; tF += ref;
  });
  for (const [sku, val] of Object.entries(summary)) {
    body.innerHTML += `<tr><td title="${sku}">${sku}</td><td>${val.qty}</td><td>${val.ret}</td><td>${val.amt.toFixed(2)}</td><td>${val.ref.toFixed(2)}</td></tr>`;
  }
  document.getElementById("totalQty").textContent = tQ;
  document.getElementById("totalReturn").textContent = tR;
  document.getElementById("totalAmount").textContent = tA.toFixed(2);
  document.getElementById("totalRefund").textContent = tF.toFixed(2);
  document.getElementById("totalQtyCard").textContent = tQ;
  document.getElementById("totalReturnCard").textContent = tR;
  document.getElementById("totalAmountCard").textContent = tA.toFixed(2);
  document.getElementById("totalRefundCard").textContent = tF.toFixed(2);
  window.summaryData = { summary, tQ, tR, tA, tF, skuCount: Object.keys(summary).length };
}

document.getElementById("excelFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    window.excelData = XLSX.utils.sheet_to_json(sheet, { defval: 0 });
    summarizeData();
  };
  reader.readAsArrayBuffer(file);
});

async function saveToSupabase() {
  const store = document.getElementById("storeSelect").value;
  const start = document.getElementById("recordStartDate").value;
  const end = document.getElementById("recordEndDate").value;
  if (!store || !start || !end || !window.summaryData) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

  const summary = window.summaryData;
  const skuList = Object.entries(summary.summary).map(([k,v]) => ({ name: k, ...v }));
  const rows = [];
  const cur = new Date(start), last = new Date(end);

  while (cur <= last) {
    rows.push({
      date: cur.toISOString().split("T")[0],
      store_name: store,
      total_qty: summary.tQ,
      total_return: summary.tR,
      total_amount: summary.tA,
      total_refund: summary.tF,
      sku_count: summary.skuCount,
      skus: skuList
    });
    cur.setDate(cur.getDate()+1);
  }

  const { error } = await supabase.from("sku_history").insert(rows);
  if (error) return alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  fetchHistory();
}

async function fetchHistory() {
  const { data, error } = await supabase.from("sku_history").select("id, date, store_name").order("date");
  if (error) return;
  const tbody = document.getElementById("historyList");
  tbody.innerHTML = data.map((d,i) => `
    <tr>
      <td><span id="date-${i}">${d.date}</span></td>
      <td>${d.store_name}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditDate(${i})"><i class="bi bi-pencil-square"></i></button>
        <button class="btn btn-sm btn-outline-success me-1 d-none" id="saveBtn-${i}" onclick="saveEditedDate(${i}, '${d.id}')"><i class="bi bi-check-circle"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${d.id}')"><i class="bi bi-trash"></i></button>
        <input type="date" class="form-control d-none" id="editDate-${i}" value="${d.date}">
      </td>
    </tr>`).join("");
  window._historyData = data;
}

function toggleEditDate(i) {
  document.getElementById(`date-${i}`).classList.add("d-none");
  document.getElementById(`editDate-${i}`).classList.remove("d-none");
  document.getElementById(`saveBtn-${i}`).classList.remove("d-none");
}

async function saveEditedDate(i, id) {
  const newDate = document.getElementById(`editDate-${i}`).value;
  const { error } = await supabase.from("sku_history").update({ date: newDate }).eq("id", id);
  if (!error) fetchHistory();
}

async function deleteHistory(id) {
  if (!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠?")) return;
  const { error } = await supabase.from("sku_history").delete().eq("id", id);
  if (!error) fetchHistory();
}

function filterHistory() {
  const start = document.getElementById("filterStartDate").value;
  const end = document.getElementById("filterEndDate").value;
  const filtered = (window._historyData || []).filter(d => (!start || d.date >= start) && (!end || d.date <= end));
  renderHistoryList(filtered);
}

function renderHistoryList(data) {
  const tbody = document.getElementById("historyList");
  tbody.innerHTML = data.map((d,i) => `
    <tr>
      <td><span id="date-${i}">${d.date}</span></td>
      <td>${d.store_name}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditDate(${i})"><i class="bi bi-pencil-square"></i></button>
        <button class="btn btn-sm btn-outline-success me-1 d-none" id="saveBtn-${i}" onclick="saveEditedDate(${i}, '${d.id}')"><i class="bi bi-check-circle"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${d.id}')"><i class="bi bi-trash"></i></button>
        <input type="date" class="form-control d-none" id="editDate-${i}" value="${d.date}">
      </td>
    </tr>`).join("");
}

document.addEventListener("DOMContentLoaded", () => {
  loadStores();
  fetchHistory();
});
</script>
</body>
</html>
