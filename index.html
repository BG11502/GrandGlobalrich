<!DOCTYPE html>
<html lang="th">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <meta charset="UTF-8">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .sidebar {
      width: 240px;
      background-color: #343a40;
      min-height: 100vh;
      color: white;
    }
    .sidebar .nav-link { color: white; }
    .sidebar .nav-link:hover { background-color: #495057; }
    td[title] { cursor: help; }
    .table th, .table td { white-space: nowrap; }
  </style>
</head>
<body>

<div class="d-flex">
  <!-- Sidebar -->
  <div class="sidebar p-4">
    <h4 class="mb-4">üì¶ ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
    <ul class="nav flex-column">
      <li><a class="nav-link" href="#">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° SKU</a></li>
      <li><a class="nav-link" href="‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
      <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô.html">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</a></li>
      <li><a class="nav-link" href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</a></li>
    </ul>
  </div>

  <!-- Content -->
  <div class="flex-grow-1 p-4">
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h6><h4 id="totalAmountCard">0.00</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h6><h4 id="totalQtyCard">0</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h6><h4 id="totalRefundCard">0.00</h4></div></div>
      <div class="col-md-3"><div class="card p-3"><h6>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</h6><h4 id="totalReturnCard">0</h4></div></div>
    </div>

    <div class="card p-4 mb-4">
      <h2 class="mb-4 text-primary">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏≤‡∏° Seller SKU</h2>
      <div class="mb-3">
        <label class="form-label">üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx):</label>
        <input type="file" id="excelFile" accept=".xlsx" class="form-control">
      </div>
      <div class="row g-2 mb-3">
        <div class="col-md-6"><input type="date" id="recordStartDate" class="form-control"></div>
        <div class="col-md-6"><input type="date" id="recordEndDate" class="form-control"></div>
      </div>
      <button class="btn btn-primary mb-4" onclick="saveToHistoryMultipleDates()">
        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      </button>

      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center align-middle">
          <thead class="table-primary">
            <tr><th>Seller SKU</th><th>Quantity</th><th>Return</th><th>Order Amount</th><th>Refund</th></tr>
          </thead>
          <tbody id="summaryBody"></tbody>
          <tfoot class="table-dark fw-bold">
            <tr>
              <td>‡∏£‡∏ß‡∏°</td>
              <td id="totalQty">0</td>
              <td id="totalReturn">0</td>
              <td id="totalAmount">0.00</td>
              <td id="totalRefund">0.00</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="mb-3 text-danger">üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
      <div class="row g-2 mb-3">
        <div class="col-md-5"><input type="date" class="form-control" id="filterStartDate"></div>
        <div class="col-md-5"><input type="date" class="form-control" id="filterEndDate"></div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-outline-primary" onclick="applyHistoryFilter()">
            <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-hover text-center">
          <thead class="table-danger">
            <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
          </thead>
          <tbody id="historyList"><tr><td colspan="2" class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const _supabase = window.supabase.createClient(
  "https://vzxttbvwukpsxqdaulvo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
);

document.getElementById("excelFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel");
  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: 0 });
    if (!jsonData.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");
    window.excelData = jsonData;
    summarizeData();
  };
  reader.readAsArrayBuffer(file);
});

function summarizeData() {
  const summary = {}, body = document.getElementById("summaryBody");
  body.innerHTML = "";
  let tQ = 0, tR = 0, tA = 0, tF = 0;
  window.excelData.forEach(row => {
    const sku = row["Seller SKU"] || row["SKU"] || row["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const qty = parseFloat(row["Quantity"] || 0) || 0;
    const ret = parseFloat(row["Sku Quantity of return"] || 0) || 0;
    const amt = parseFloat(row["Order Amount"] || 0) || 0;
    const ref = parseFloat(row["Order Refund Amount"] || 0) || 0;
    if (!summary[sku]) summary[sku] = { qty: 0, ret: 0, amt: 0, ref: 0 };
    summary[sku].qty += qty;
    summary[sku].ret += ret;
    summary[sku].amt += amt;
    summary[sku].ref += ref;
    tQ += qty; tR += ret; tA += amt; tF += ref;
  });
  Object.entries(summary).forEach(([sku, obj]) => {
    body.innerHTML += `<tr><td title="${sku}">${sku}</td><td>${obj.qty}</td><td>${obj.ret}</td><td>${obj.amt.toFixed(2)}</td><td>${obj.ref.toFixed(2)}</td></tr>`;
  });
  document.getElementById("totalQty").textContent = tQ;
  document.getElementById("totalReturn").textContent = tR;
  document.getElementById("totalAmount").textContent = tA.toFixed(2);
  document.getElementById("totalRefund").textContent = tF.toFixed(2);
  document.getElementById("totalQtyCard").textContent = tQ;
  document.getElementById("totalReturnCard").textContent = tR;
  document.getElementById("totalAmountCard").textContent = tA.toFixed(2);
  document.getElementById("totalRefundCard").textContent = tF.toFixed(2);
  window.summaryData = { tQ, tR, tA, tF, skuCount: Object.keys(summary).length, summary };
}

window.saveToHistoryMultipleDates = async function () {
  if (!window.summaryData || !window.excelData) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô");
  const start = document.getElementById("recordStartDate").value;
  const end = document.getElementById("recordEndDate").value;
  if (!start || !end) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

  const cur = new Date(start), last = new Date(end);
  const skuMap = {};
  window.excelData.forEach(row => {
    const sku = row["Seller SKU"] || row["SKU"] || row["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const qty = parseFloat(row["Quantity"] || 0) || 0;
    const ret = parseFloat(row["Sku Quantity of return"] || 0) || 0;
    const amt = parseFloat(row["Order Amount"] || 0) || 0;
    const ref = parseFloat(row["Order Refund Amount"] || 0) || 0;
    if (!skuMap[sku]) skuMap[sku] = { name: sku, qty: 0, ret: 0, amt: 0, ref: 0 };
    skuMap[sku].qty += qty;
    skuMap[sku].ret += ret;
    skuMap[sku].amt += amt;
    skuMap[sku].ref += ref;
  });
  const skuList = Object.values(skuMap);
  const rows = [];
  while (cur <= last) {
    rows.push({
      date: cur.toISOString().split("T")[0],
      total_qty: window.summaryData.tQ,
      total_return: window.summaryData.tR,
      total_amount: window.summaryData.tA,
      total_refund: window.summaryData.tF,
      sku_count: window.summaryData.skuCount,
      skus: skuList,
    });
    cur.setDate(cur.getDate() + 1);
  }

  const { error } = await _supabase.from("sku_history").insert(rows);
  if (error) {
    console.error("Insert error:", error);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
  } else {
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    fetchHistoryFromSupabase();
  }
};

async function fetchHistoryFromSupabase() {
  const { data, error } = await _supabase
  .from("sku_history")
  .select("id, date") // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° id ‡∏î‡πâ‡∏ß‡∏¢
  .order("date", { ascending: true });

  if (error) {
    console.error("Fetch error:", error);
    return;
  }
  renderHistoryList(data);
}

window.renderHistoryList = function (data = []) {
  const tbody = document.getElementById("historyList");
  tbody.innerHTML = "";
  data.forEach((entry, index) => {
    tbody.innerHTML += `
      <tr>
        <td>
          <span id="date-${index}">${entry.date}</span>
          <input type="date" class="form-control d-none" id="editDate-${index}" value="${entry.date}">
        </td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditDate(${index})">
            <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          </button>
          <button class="btn btn-sm btn-outline-success me-1 d-none" id="saveBtn-${index}" onclick="saveEditedDate(${index}, '${entry.id}')">
            <i class="bi bi-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteHistory('${entry.id}', '${entry.date}')">
            <i class="bi bi-trash"></i> ‡∏•‡∏ö
          </button>
        </td>
      </tr>`;
  });

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="2" class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>`;
  }

  window._historyData = data;
};

window.toggleEditDate = function (index) {
  document.getElementById(`date-${index}`).classList.add("d-none");
  document.getElementById(`editDate-${index}`).classList.remove("d-none");
  document.getElementById(`saveBtn-${index}`).classList.remove("d-none");
};

window.saveEditedDate = async function (index, id) {
  const newDate = document.getElementById(`editDate-${index}`).value;
  if (!newDate) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà");
  const { error } = await _supabase.from("sku_history").update({ date: newDate }).eq("id", id);
  if (error) {
    alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  } else {
    alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    fetchHistoryFromSupabase();
  }
};

window.deleteHistory = async function (id, date) {
  if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  const { error } = await _supabase.from("sku_history").delete().eq("id", id);
  if (error) {
    alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ");
  } else {
    alert("‚úÖ ‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    fetchHistoryFromSupabase();
  }
};

window.applyHistoryFilter = function () {
  const start = document.getElementById("filterStartDate").value;
  const end = document.getElementById("filterEndDate").value;
  const filtered = (window._historyData || []).filter(e => {
    return (!start || e.date >= start) && (!end || e.date <= end);
  });
  renderHistoryList(filtered);
};

document.addEventListener("DOMContentLoaded", fetchHistoryFromSupabase);
</script>
</body>
</html>
