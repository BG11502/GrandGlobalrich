<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
    .table th, .table td { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container py-4">
  <h3 class="text-primary mb-3">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</h3>

  <div class="card p-3 mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
        <select id="yearSelect" class="form-select"></select>
      </div>
      <div class="col-md-9">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
        <div id="monthChecks" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>
    <div class="text-end mt-3">
      <button class="btn btn-primary" onclick="renderReport()">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>

  <div class="card p-3 mb-4">
    <h5 class="mb-3">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h5>
    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th><th>‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>ROAS</th></tr>
        </thead>
        <tbody id="monthlyBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card p-3">
    <h5 class="mb-3">üóìÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h5>
    <div class="table-responsive">
      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th><th>‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>ROAS</th></tr>
        </thead>
        <tbody id="dailyBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
// Supabase config
const supabase = supabase.createClient(
  "https://vzxttbvwukpsxqdaulvo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
);

const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];

// ‡πÇ‡∏´‡∏•‡∏î dropdown ‡∏õ‡∏µ + month checkboxes
document.addEventListener("DOMContentLoaded", async () => {
  const { data } = await supabase.from("ad_history").select("date").order("date");
  if (!data) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const years = [...new Set(data.map(d => new Date(d.date).getFullYear()))];
  const ySel = document.getElementById("yearSelect");
  years.forEach(y => {
    ySel.innerHTML += `<option value="${y}">${y}</option>`;
  });

  const box = document.getElementById("monthChecks");
  months.forEach((m, i) => {
    box.innerHTML += `
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="m${i+1}" value="${i+1}" checked>
        <label class="form-check-label" for="m${i+1}">${m}</label>
      </div>`;
  });
});

// renderReport ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á + ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function renderReport() {
  const { data, error } = await supabase.from("ad_history").select("*").order("date");
  if (error) return alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

  console.log("data from supabase", data);

  const year = +document.getElementById("yearSelect").value;
  const monthsSelected = Array.from(document.querySelectorAll("#monthChecks input:checked")).map(c => +c.value);

  // ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  const monthly = {};
  data.forEach(r => {
    const d = new Date(r.date);
    const m = d.getMonth()+1;
    if (d.getFullYear() !== year || !monthsSelected.includes(m)) return;

    const key = m;
    if (!monthly[key]) monthly[key] = {ad:0,cost:0,qty:0,rev:0};
    monthly[key].ad += +r.spend_total;
    monthly[key].cost += (+r.cost_per_purchase * +r.purchases);
    monthly[key].qty += +r.purchases;
    monthly[key].rev += +r.revenue;
  });

  const tbodyM = document.getElementById("monthlyBody");
  tbodyM.innerHTML = "";
  monthsSelected.forEach(m => {
    const v = monthly[m] || {ad:0,cost:0,qty:0,rev:0};
    tbodyM.innerHTML += `<tr>
      <td>${months[m-1]}</td>
      <td>‡∏ø${v.ad.toFixed(2)}</td>
      <td>‡∏ø${v.cost.toFixed(2)}</td>
      <td>${v.qty}</td>
      <td>‡∏ø${v.rev.toFixed(2)}</td>
      <td>${(v.ad ? (v.rev/v.ad).toFixed(2) : '0.00')}</td>
    </tr>`;
  });

  // ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
  const daily = {};
  data.forEach(r => {
    const d = new Date(r.date);
    const m = d.getMonth()+1;
    if (d.getFullYear() !== year || !monthsSelected.includes(m)) return;
    const key = r.date;
    if (!daily[key]) daily[key] = {ad:0,cost:0,qty:0,rev:0};
    daily[key].ad += +r.spend_total;
    daily[key].cost += (+r.cost_per_purchase * +r.purchases);
    daily[key].qty += +r.purchases;
    daily[key].rev += +r.revenue;
  });

  const tbodyD = document.getElementById("dailyBody");
  tbodyD.innerHTML = "";
  Object.entries(daily).sort().forEach(([d,v])=>{
    tbodyD.innerHTML += `<tr>
      <td>${d}</td>
      <td>‡∏ø${v.ad.toFixed(2)}</td>
      <td>‡∏ø${v.cost.toFixed(2)}</td>
      <td>${v.qty}</td>
      <td>‡∏ø${v.rev.toFixed(2)}</td>
      <td>${(v.ad ? (v.rev/v.ad).toFixed(2) : '0.00')}</td>
    </tr>`;
  });
}
</script>
</body>
</html>
