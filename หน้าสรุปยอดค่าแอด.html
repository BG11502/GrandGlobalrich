<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    .card-summary .card-body {
      text-align: center;
      font-size: 1.25rem;
      background-color: #f8f9fa;
    }
    .table thead th {
      background-color: #f1f1f1;
    }
    .text-money {
      font-weight: bold;
      color: #198754; /* Green for positive values / money */
    }
    .text-refund {
      color: #dc3545; /* Red for negative values / refunds */
      font-weight: bold;
    }
    /* Optional: Style for ROAS to stand out slightly if needed */
    .text-roas {
        font-weight: bold;
        color: #007bff; /* Blue */
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="text-center mb-4 text-primary">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</h2>
<div class="container py-4">
  <div class="d-flex justify-content-between mb-4">
    <a href="‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-primary btn-icon"><i class="bi bi-house-door"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î </a>
    <a href="index.html" class="btn btn-outline-secondary btn-icon"><i class="bi bi-graph-up-arrow"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  </div>
  <div class="card p-3 mb-4">
    <div class="row g-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
        <select id="yearSelect" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
        <div class="d-flex flex-wrap gap-1" id="monthCheckboxes">
          </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <div class="input-group">
          <input type="date" id="startDate" class="form-control" />
          <input type="date" id="endDate" class="form-control" />
        </div>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-success w-100" onclick="applyFilter()"><i class="bi bi-filter-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
        <button class="btn btn-danger" onclick="resetFilter()"><i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-5 g-3 mb-4 card-summary">
    <div class="col"><div class="card"><div class="card-body">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î<br><span id="totalSpend" class="text-money">‡∏ø0.00</span></div></div></div>
    <div class="col"><div class="card"><div class="card-body">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠<br><span id="totalPurchasesSummary">0</span></div></div></div>
    <div class="col"><div class="card"><div class="card-body">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠<br><span id="avgCostPerPurchaseSummary" class="text-money">‡∏ø0.00</span></div></div></div>
    <div class="col"><div class="card"><div class="card-body">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ<br><span id="totalRevenueSummary" class="text-money">‡∏ø0.00</span></div></div></div>
    <div class="col"><div class="card"><div class="card-body">ROAS<br><span id="totalRoas" class="text-roas">0.00</span></div></div></div>
  </div>

  <div class="card p-3 mb-4">
    <h5 class="text-secondary mb-3"><i class="bi bi-person-lines-fill me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>ROAS</th>
          </tr>
        </thead>
        <tbody id="ownerSummaryBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card p-3">
    <h5 class="text-secondary mb-3"><i class="bi bi-calendar3"></i>  ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î 26-25)</h5>
    <div class="table-responsive">
      <table class="table table-striped text-center align-middle">
        <thead>
          <tr>
            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th>‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</th>
          </tr>
        </thead>
        <tbody id="monthlyTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const _supabase = supabase.createClient(
  "https://vzxttbvwukpsxqdaulvo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
);

let allData = []; // Store all loaded data

document.addEventListener('DOMContentLoaded', () => {
    initUI();
    loadData();
});

function initUI() {
  const y = new Date().getFullYear();
  const yearSelect = document.getElementById('yearSelect');
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á option ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞ 5 ‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  for (let i = y - 5; i <= y; i++) {
    yearSelect.innerHTML += `<option value="${i}" ${i === y ? "selected" : ""}>${i}</option>`;
  }

  const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
  const monthBox = document.getElementById('monthCheckboxes');
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á checkboxes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ
  monthNames.forEach((m, i) => {
    monthBox.innerHTML += `<div class="form-check me-2">
      <input class="form-check-input" type="checkbox" value="${i+1}" id="m${i+1}">
      <label class="form-check-label" for="m${i+1}">${m}</label></div>`;
  });
}

async function loadData() {
  const { data, error } = await _supabase.from('ad_history').select('*');
  if (error) {
    console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
    return alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
  }
  allData = data || [];
  applyFilter(); // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
}

function applyFilter() {
  const selectedYear = parseInt(document.getElementById('yearSelect').value);
  const selectedMonths = [...document.querySelectorAll('#monthCheckboxes input:checked')].map(c => +c.value);
  const startDateInput = document.getElementById("startDate").value;
  const endDateInput = document.getElementById("endDate").value;

  let filtered = allData.filter(d => {
    const dataDate = new Date(d.date);
    let isWithinDateRange = true; // Assume true if no specific start/end dates are provided

    // Check custom date range if provided (Highest priority)
    if (startDateInput && endDateInput) {
      const startDate = new Date(startDateInput);
      const endDate = new Date(endDateInput);
      // Set end date to end of day to include full day
      endDate.setHours(23, 59, 59, 999);
      return dataDate >= startDate && dataDate <= endDate;
    } else if (startDateInput) {
      const startDate = new Date(startDateInput);
      return dataDate >= startDate;
    } else if (endDateInput) {
      const endDate = new Date(endDateInput);
      endDate.setHours(23, 59, 59, 999);
      return dataDate <= endDate;
    } else {
        // --- 26th-25th Monthly Cycle Logic ---
        // If no custom date range, apply year and custom month (26-25) logic

        const reportMonthsToFilter = selectedMonths.length > 0 ? selectedMonths : Array.from({length: 12}, (_, i) => i + 1); // Use all months if none selected

        for (const reportMonth of reportMonthsToFilter) {
            let cycleStartYear = selectedYear;
            let cycleEndYear = selectedYear;
            let cycleStartMonth = reportMonth - 1; // 0-indexed for Date object
            let cycleEndMonth = reportMonth - 1;   // 0-indexed for Date object

            // Adjust start month/year for the 26th-25th cycle
            if (reportMonth === 1) { // If "January" (month 1), cycle starts Dec 26 of previous year
                cycleStartMonth = 11; // December
                cycleStartYear = selectedYear - 1;
            } else {
                cycleStartMonth = reportMonth - 2; // e.g., if reportMonth is Feb (2), cycle starts Jan (1)
            }

            const cycleStartDate = new Date(cycleStartYear, cycleStartMonth, 26);
            const cycleEndDate = new Date(cycleEndYear, cycleEndMonth, 25);
            // Set time to end of day for cycleEndDate to include full day
            cycleEndDate.setHours(23, 59, 59, 999);

            if (dataDate >= cycleStartDate && dataDate <= cycleEndDate) {
                return true; // Data point matches one of the selected/all 26-25 month cycles
            }
        }
        return false; // Data point did not match any of the 26-25 month cycles
    }
  });

  renderSummary(filtered);
  renderOwnerSummary(filtered);
  renderMonthly(filtered); // This will now process the filtered data based on 26-25 logic
}

function resetFilter() {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.querySelectorAll('#monthCheckboxes input').forEach(c => c.checked = false);
  // Set current year as default
  document.getElementById('yearSelect').value = new Date().getFullYear();
  applyFilter();
}

function renderSummary(data) {
  let totalSpend = 0;
  let totalPurchases = 0;
  let totalRevenue = 0;

  data.forEach(e => {
    totalSpend += +e.spend_total;
    totalPurchases += +e.purchases;
    totalRevenue += +e.revenue;
  });

  const avgCostPerPurchase = totalPurchases > 0 ? totalSpend / totalPurchases : 0;
  const totalRoas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

  document.getElementById('totalSpend').textContent = "‡∏ø" + totalSpend.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalPurchasesSummary').textContent = totalPurchases.toLocaleString();
  document.getElementById('avgCostPerPurchaseSummary').textContent = "‡∏ø" + avgCostPerPurchase.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalRevenueSummary').textContent = "‡∏ø" + totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2});
  document.getElementById('totalRoas').textContent = totalRoas.toFixed(2);
}

function renderOwnerSummary(data) {
  const grouped = {};
  data.forEach(e => {
    const owner = e.owner;
    if (!grouped[owner]) {
      grouped[owner] = { spend: 0, purchases: 0, revenue: 0 };
    }
    grouped[owner].spend += +e.spend_total;
    grouped[owner].purchases += +e.purchases;
    grouped[owner].revenue += +e.revenue;
  });

  const tbody = document.getElementById("ownerSummaryBody");
  tbody.innerHTML = "";

  Object.entries(grouped).forEach(([owner, g]) => {
    const ownerAvgCostPerPurchase = g.purchases > 0 ? g.spend / g.purchases : 0;
    const ownerRoas = g.spend > 0 ? (g.revenue / g.spend) : 0;

    tbody.innerHTML += `<tr>
      <td>${owner}</td>
      <td class="text-money">‡∏ø${g.spend.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
      <td>‡∏ø${ownerAvgCostPerPurchase.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
      <td>${g.purchases.toLocaleString()}</td>
      <td class="text-money">‡∏ø${g.revenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
      <td class="text-roas">${ownerRoas.toFixed(2)}</td>
    </tr>`;
  });
}

function renderMonthly(data) {
  const monthly = {};
  const selectedYear = parseInt(document.getElementById('yearSelect').value);
  const monthNames = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

  // Initialize monthly object for all 12 "reporting months" based on 26-25 cycle
  // This ensures all months are displayed even if no data exists for them
  for (let i = 1; i <= 12; i++) {
    monthly[i] = { spend: 0, purchases: 0, revenue: 0 };
  }

  // Group data by the 26-25 reporting month
  data.forEach(e => {
    const dataDate = new Date(e.date);

    // Determine which "reporting month" (26th-25th cycle) the dataDate falls into
    // The reporting month is the *calendar* month where the 25th falls.
    // Example: A date between Dec 26, 2023 - Jan 25, 2024 is part of "January 2024" reporting month.
    // Example: A date between Jan 26, 2024 - Feb 25, 2024 is part of "February 2024" reporting month.

    let reportingMonthCalendarIndex = dataDate.getMonth(); // 0-11 for Date object
    let reportingYear = dataDate.getFullYear();

    if (dataDate.getDate() > 25) {
        // If the day is after the 25th, it belongs to the *next* reporting month's cycle.
        // E.g., Jan 26 belongs to Feb's reporting cycle (Jan 26 - Feb 25).
        reportingMonthCalendarIndex = (reportingMonthCalendarIndex + 1) % 12;
        if (reportingMonthCalendarIndex === 0) { // If it wrapped from Dec (11) to Jan (0), increment the year
            reportingYear += 1;
        }
    }
    // Else (date.getDate() <= 25), it belongs to the *current* calendar month's reporting cycle.
    // E.g., Jan 1-25 belongs to Jan's reporting cycle (Dec 26 - Jan 25).


    // Only aggregate data for the selected filter year's reporting months
    if (reportingYear === selectedYear) {
        const reportingMonthNumber = reportingMonthCalendarIndex + 1; // Convert to 1-12 for monthly object key
        if (monthly[reportingMonthNumber]) {
            monthly[reportingMonthNumber].spend += +e.spend_total;
            monthly[reportingMonthNumber].purchases += +e.purchases;
            monthly[reportingMonthNumber].revenue += +e.revenue;
        }
    }
  });

  const tbody = document.getElementById("monthlyTableBody");
  tbody.innerHTML = ""; // Clear existing data

  for (let i = 1; i <= 12; i++) {
    const netRevenue = monthly[i].revenue - monthly[i].spend;
    const netRevenueClass = netRevenue < 0 ? 'text-refund' : 'text-money';

    tbody.innerHTML += `<tr>
      <td>${monthNames[i - 1]}</td>
      <td>‡∏ø${monthly[i].spend.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
      <td>${monthly[i].purchases.toLocaleString()}</td>
      <td class="text-money">‡∏ø${monthly[i].revenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
      <td class="${netRevenueClass}">‡∏ø${netRevenue.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
    </tr>`;
  }
}
</script>
</body>
</html>
