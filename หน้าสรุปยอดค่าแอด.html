<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>รายงานค่าโฆษณา - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            color: #333;
        }
        .header-section {
            background: linear-gradient(135deg, #007bff, #0056b3); /* Blue gradient */
            color: white;
            padding: 3rem 0;
            margin-bottom: 3rem;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .header-section h1 {
            font-weight: 600;
            font-size: 2.8rem;
            margin-bottom: 0.5rem;
        }
        .header-section p {
            font-weight: 300;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .filter-card .card-body {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Space between filter items */
            align-items: flex-end; /* Align items to the bottom */
        }
        .filter-item {
            flex-grow: 1; /* Allow items to grow */
            min-width: 150px; /* Minimum width for filter dropdowns */
        }
        .filter-item label {
            font-weight: 500;
            color: #555;
            margin-bottom: 0.5rem;
        }
        .filter-item .form-select,
        .filter-item .form-control {
            border-radius: 8px;
            border-color: #ced4da;
            transition: all 0.2s ease-in-out;
        }
        .filter-item .form-select:focus,
        .filter-item .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }
        .action-buttons .btn {
            border-radius: 8px;
            font-weight: 500;
        }
        .action-buttons .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .action-buttons .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .action-buttons .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .action-buttons .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        .summary-card {
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: white;
            min-height: 120px; /* Ensure consistent height */
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .summary-card .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .summary-card .total-value {
            font-size: 2.5rem;
            font-weight: 600;
            margin-top: 0.5rem;
            line-height: 1; /* Reduce line height */
        }
        .summary-card .total-label {
            font-size: 0.9rem;
            color: #777;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .bi {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #007bff; /* Default icon color */
        }
        .summary-card .text-primary .bi { color: #007bff; }
        .summary-card .text-success .bi { color: #28a745; }
        .summary-card .text-info .bi { color: #17a2b8; }
        .summary-card .roas-value.is-good { color: #28a745 !important; }
        .summary-card .roas-value { color: #dc3545 !important; }


        .grouped-card {
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            background-color: white;
        }
        .grouped-card .card-header-grouped {
            background-color: #e9ecef; /* Lighter grey for header */
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            font-size: 1.1rem;
        }
        .grouped-card .card-header-grouped span {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .grouped-card .card-header-grouped .float-end {
            font-size: 0.9rem;
            color: #555;
        }
        .grouped-card .card-body {
            padding: 0; /* Remove padding from card body to make table full width */
        }
        .grouped-card .table {
            margin-bottom: 0; /* Remove margin from table */
        }
        .grouped-card .table thead {
            background-color: #f8f9fa; /* Light background for table header */
            color: #495057;
            font-weight: 500;
        }
        .grouped-card .table th, .grouped-card .table td {
            padding: 1rem;
            vertical-align: middle;
        }
        .grouped-card .table tbody tr:hover {
            background-color: #f2f2f2; /* Hover effect for table rows */
        }

        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .header-section {
                padding: 2rem 0;
                margin-bottom: 2rem;
            }
            .header-section h1 {
                font-size: 2rem;
            }
            .header-section p {
                font-size: 1rem;
            }
            .filter-card .card-body {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-item {
                min-width: unset;
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            .action-buttons .btn {
                width: 100%;
            }
            .grouped-card .card-header-grouped {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            .grouped-card .card-header-grouped .float-end {
                width: 100%;
                text-align: left;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-light">
    <div class="header-section text-center">
        <div class="container">
            <h1 class="mb-2"><i class="bi bi-bar-chart-fill me-2"></i> รายงานค่าโฆษณา</h1>
            <p class="lead">สรุปยอดและข้อมูลจาก ad_history เพื่อการวิเคราะห์</p>
        </div>
    </div>

    <div class="container py-4">
        <div class="card shadow-sm mb-5 filter-card rounded-3">
            <div class="card-body">
                <div class="filter-item">
                    <label for="yearFilter" class="form-label">เลือกปี:</label>
                    <select id="yearFilter" class="form-select">
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="monthFilter" class="form-label">เลือกเดือน:</label>
                    <select id="monthFilter" class="form-select">
                        <option value="all">ทั้งหมด</option>
                        <option value="01">มกราคม</option>
                        <option value="02">กุมภาพันธ์</option>
                        <option value="03">มีนาคม</option>
                        <option value="04">เมษายน</option>
                        <option value="05">พฤษภาคม</option>
                        <option value="06">มิถุนายน</option>
                        <option value="07">กรกฎาคม</option>
                        <option value="08">สิงหาคม</option>
                        <option value="09">กันยายน</option>
                        <option value="10">ตุลาคม</option>
                        <option value="11">พฤศจิกายน</option>
                        <option value="12">ธันวาคม</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="dateFromFilter" class="form-label">จากวันที่:</label>
                    <input type="date" id="dateFromFilter" class="form-control">
                </div>
                <div class="filter-item">
                    <label for="dateToFilter" class="form-label">ถึงวันที่:</label>
                    <input type="date" id="dateToFilter" class="form-control">
                </div>
                <div class="filter-item">
                    <label for="ownerFilter" class="form-label">ผู้ดูแล:</label>
                    <select id="ownerFilter" class="form-select">
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="accountFilter" class="form-label">ชื่อบัญชี:</label>
                    <select id="accountFilter" class="form-select">
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button id="clearFiltersBtn" class="btn btn-secondary">
                        <i class="bi bi-x-circle-fill me-2"></i> ล้างตัวกรอง
                    </button>
                    <button id="index.html" class="btn btn-primary">
                        <i class="bi bi-house-door-fill me-2"></i> กลับหน้าหลัก
                    </button>
                </div>
            </div>
        </div>

        <h2 class="mb-4 fw-bold text-dark">สรุปภาพรวมทั้งหมด</h2>
        <div class="row g-4 mb-5" id="overallSummary">
            
</div>

        <h2 class="mb-4 fw-bold text-dark">รายละเอียดตามผู้ดูแลบัญชี</h2>
        <div id="groupedTablesContainer">
            
</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const _supabase = supabase.createClient(
            "https://vzxttbvwukpsxqdaulvo.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
        );
        let rawData = [];
        
        // **แก้ไข URL นี้ให้เป็นหน้าหลักของคุณ**
        const HOME_URL = "https://your-homepage-url.com"; 

        async function loadDataAndRender() {
            const { data, error } = await _supabase
                .from("ad_history")
                .select("date, account_name, owner, status, spend_total, purchases, revenue, roas")
                .order("date", { ascending: false });

            if (error) {
                console.error("โหลดข้อมูลผิดพลาด:", error.message);
                document.getElementById("overallSummary").innerHTML = `<div class="col-12 text-center text-danger">ไม่สามารถโหลดข้อมูลได้: ${error.message}</div>`;
                document.getElementById("groupedTablesContainer").innerHTML = ``;
                return;
            }

            rawData = data;
            populateYearFilter(data);
            populateOwnerFilter(data);
            updateAccountFilter();
            filterAndRenderData();
        }

        function populateYearFilter(data) {
            const years = [...new Set(data.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);
            const yearFilter = document.getElementById("yearFilter");
            yearFilter.innerHTML = '<option value="all">ทั้งหมด</option>';
            years.forEach(year => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }
        
        function populateOwnerFilter(data) {
            const owners = [...new Set(data.map(d => d.owner).filter(o => o))].sort();
            const ownerFilter = document.getElementById("ownerFilter");
            ownerFilter.innerHTML = '<option value="all">ทั้งหมด</option>';
            owners.forEach(owner => {
                const option = document.createElement("option");
                option.value = owner;
                option.textContent = owner;
                ownerFilter.appendChild(option);
            });
        }
        
        function updateAccountFilter() {
            const owner = document.getElementById("ownerFilter").value;
            const accountFilter = document.getElementById("accountFilter");
            accountFilter.innerHTML = '<option value="all">ทั้งหมด</option>';
            
            let filteredAccountsData = rawData;
            if (owner !== "all") {
                filteredAccountsData = rawData.filter(row => row.owner === owner);
            }
            
            const accounts = [...new Set(filteredAccountsData.map(d => d.account_name).filter(a => a))].sort();
            accounts.forEach(account => {
                const option = document.createElement("option");
                option.value = account;
                option.textContent = account;
                accountFilter.appendChild(option);
            });
        }
        
        function filterAndRenderData() {
            const year = document.getElementById("yearFilter").value;
            const month = document.getElementById("monthFilter").value;
            const dateFrom = document.getElementById("dateFromFilter").value;
            const dateTo = document.getElementById("dateToFilter").value;
            const owner = document.getElementById("ownerFilter").value;
            const account = document.getElementById("accountFilter").value;

            let filteredData = rawData;

            // Date filtering logic based on which filter is used
            if (year !== "all") {
                filteredData = filteredData.filter(row => {
                    const rowDate = new Date(row.date);
                    return !isNaN(rowDate) && rowDate.getFullYear().toString() === year;
                });
            } else if (month !== "all") {
                filteredData = filteredData.filter(row => {
                    const rowDate = new Date(row.date);
                    return !isNaN(rowDate) && (rowDate.getMonth() + 1).toString().padStart(2, '0') === month;
                });
            } else if (dateFrom || dateTo) {
                filteredData = filteredData.filter(row => {
                    const rowDateStr = row.date.split('T')[0];
                    const fromValid = !dateFrom || rowDateStr >= dateFrom;
                    const toValid = !dateTo || rowDateStr <= dateTo;
                    return fromValid && toValid;
                });
            }

            // Other filters
            if (owner !== "all") {
                filteredData = filteredData.filter(row => row.owner === owner);
            }
            if (account !== "all") {
                filteredData = filteredData.filter(row => row.account_name === account);
            }

            renderDashboard(filteredData);
        }
        
        function handleDateFilterChange() {
            const yearFilter = document.getElementById("yearFilter");
            const monthFilter = document.getElementById("monthFilter");
            const dateFromFilter = document.getElementById("dateFromFilter");
            const dateToFilter = document.getElementById("dateToFilter");

            const isYearSelected = yearFilter.value !== "all";
            const isMonthSelected = monthFilter.value !== "all";
            const isDateRangeSelected = dateFromFilter.value || dateToFilter.value;
            
            // Clear other date filters based on which one was just changed
            if (isYearSelected) {
                monthFilter.value = "all";
                dateFromFilter.value = "";
                dateToFilter.value = "";
            } else if (isMonthSelected) {
                yearFilter.value = "all";
                dateFromFilter.value = "";
                dateToFilter.value = "";
            } else if (isDateRangeSelected) {
                yearFilter.value = "all";
                monthFilter.value = "all";
            }

            filterAndRenderData();
        }

        function renderDashboard(data) {
            renderOverallSummary(data);

            const groupedData = data.reduce((acc, row) => {
                if (!row.owner || row.owner.trim() === '') return acc; 
                if (!acc[row.owner]) {
                    acc[row.owner] = [];
                }
                acc[row.owner].push(row);
                return acc;
            }, {});

            renderGroupedTables(groupedData);
        }

        function renderOverallSummary(data) {
            const totals = data.reduce((acc, row) => {
                acc.spend += row.spend_total || 0;
                acc.orders += row.purchases || 0;
                acc.revenue += row.revenue || 0;
                return acc;
            }, { spend: 0, orders: 0, revenue: 0 });

            const overallRoas = totals.spend ? (totals.revenue / totals.spend).toFixed(2) : '0.00';
            const overallCostPerOrder = totals.orders ? (totals.spend / totals.orders).toFixed(2) : '0.00';
            
            const summaryContainer = document.getElementById("overallSummary");
            summaryContainer.innerHTML = `
                <div class="col-md-6 col-lg-3">
                    <div class="card summary-card text-primary">
                        <div class="card-body">
                            <i class="bi bi-cash-stack"></i>
                            <p class="total-label mb-1">ยอดรวมค่าโฆษณา</p>
                            <p class="total-value">฿${totals.spend.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card summary-card text-info">
                        <div class="card-body">
                            <i class="bi bi-cart-fill"></i>
                            <p class="total-label mb-1">ยอดรวมจำนวนออเดอร์</p>
                            <p class="total-value">${totals.orders.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card summary-card text-success">
                        <div class="card-body">
                            <i class="bi bi-coin"></i>
                            <p class="total-label mb-1">ต้นทุน/ออเดอร์</p>
                            <p class="total-value">฿${overallCostPerOrder}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card summary-card">
                        <div class="card-body">
                            <i class="bi bi-graph-up"></i>
                            <p class="total-label mb-1">ยอดรวม ROAS</p>
                            <p class="total-value roas-value ${overallRoas >= 3 ? 'is-good' : ''}">${overallRoas}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGroupedTables(groupedData) {
            const container = document.getElementById("groupedTablesContainer");
            container.innerHTML = "";

            if (Object.keys(groupedData).length === 0) {
                 container.innerHTML = `<div class="alert alert-info text-center" role="alert">
                                            ไม่พบข้อมูลผู้ดูแลในตัวกรองที่เลือก.
                                        </div>`;
                 return;
            }

            Object.keys(groupedData).sort().forEach(owner => {
                const ownerData = groupedData[owner];
                const ownerTotals = ownerData.reduce((acc, row) => {
                    acc.spend += row.spend_total || 0;
                    acc.orders += row.purchases || 0;
                    acc.revenue += row.revenue || 0;
                    return acc;
                }, { spend: 0, orders: 0, revenue: 0 });

                const ownerRoas = ownerTotals.spend ? (ownerTotals.revenue / ownerTotals.spend).toFixed(2) : '0.00';
                
                const accountsSummary = ownerData.reduce((acc, row) => {
                    if (!acc[row.account_name]) {
                        acc[row.account_name] = { 
                            spend: 0, 
                            orders: 0, 
                            revenue: 0,
                        };
                    }
                    acc[row.account_name].spend += row.spend_total || 0;
                    acc[row.account_name].orders += row.purchases || 0;
                    acc[row.account_name].revenue += row.revenue || 0;
                    return acc;
                }, {});

                const cardHtml = `
                    <div class="card grouped-card mb-4">
                        <div class="card-header card-header-grouped">
                            <span><i class="bi bi-person-fill me-2"></i> เจ้าของบัญชี: <span class="text-primary">${owner || '-'}</span></span>
                            <span class="float-end">
                                ค่าแอดรวม: <span class="fw-bold text-primary">฿${ownerTotals.spend.toLocaleString()}</span> |
                                จำนวนซื้อรวม: <span class="fw-bold text-info">${ownerTotals.orders.toLocaleString()}</span> |
                                รายได้รวม: <span class="fw-bold text-success">฿${ownerTotals.revenue.toLocaleString()}</span> |
                                ROAS รวม: <span class="roas-value ${ownerRoas >= 3 ? 'is-good' : ''}">${ownerRoas}</span>
                            </span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="text-center">
                                        <tr>
                                            <th>ชื่อบัญชี</th>
                                            <th>ค่าแอด</th>
                                            <th>ต้นทุน/ซื้อ</th>
                                            <th>จำนวนซื้อ</th>
                                            <th>รายได้</th>
                                            <th>ROAS</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-center">
                                        ${Object.keys(accountsSummary).map(accountName => {
                                            const { spend, orders, revenue } = accountsSummary[accountName];
                                            const costPerOrder = orders ? (spend / orders).toFixed(2) : '0.00';
                                            const roas = spend ? (revenue / spend).toFixed(2) : '-';
                                            return `
                                                <tr>
                                                    <td><i class="bi bi-bookmark-fill me-2"></i> ${accountName}</td>
                                                    <td>฿${spend.toLocaleString()}</td>
                                                    <td>฿${costPerOrder}</td>
                                                    <td>${orders}</td>
                                                    <td>฿${revenue.toLocaleString()}</td>
                                                    <td class="roas-value ${roas >= 3 ? 'is-good' : ''}">${roas}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }
        
        function resetFilters() {
            document.getElementById("yearFilter").value = "all";
            document.getElementById("monthFilter").value = "all";
            document.getElementById("dateFromFilter").value = "";
            document.getElementById("dateToFilter").value = "";
            document.getElementById("ownerFilter").value = "all";
            updateAccountFilter();
            filterAndRenderData();
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadDataAndRender();
            
            // Attach event listeners for all date filters
            document.getElementById("yearFilter").addEventListener("change", handleDateFilterChange);
            document.getElementById("monthFilter").addEventListener("change", handleDateFilterChange);
            document.getElementById("dateFromFilter").addEventListener("change", handleDateFilterChange);
            document.getElementById("dateToFilter").addEventListener("change", handleDateFilterChange);
            
            document.getElementById("ownerFilter").addEventListener("change", () => {
                updateAccountFilter();
                filterAndRenderData();
            });
            document.getElementById("accountFilter").addEventListener("change", filterAndRenderData);
            document.getElementById("clearFiltersBtn").addEventListener("click", resetFilters);
            document.getElementById("homeBtn").addEventListener("click", () => {
                window.location.href = HOME_URL;
            });
        });
    </script>
</body>
</html>
