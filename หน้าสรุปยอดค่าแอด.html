<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .form-check-inline { margin-right: 1rem; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="mb-3 text-start">
      <a href="index.html" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left-circle"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </a>
    </div>

    <h2 class="text-center text-primary mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>

    <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
    <div class="card p-4 mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label>
          <select id="selectedYear" class="form-select"></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <div id="monthCheckboxes" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <div class="input-group">
            <input type="date" id="startDate" class="form-control" />
            <span class="input-group-text">‡∏ñ‡∏∂‡∏á</span>
            <input type="date" id="endDate" class="form-control" />
          </div>
        </div>
        <div class="col-md-12 text-end pt-2">
          <button class="btn btn-primary me-2" onclick="loadAndRender()">‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          <button class="btn btn-outline-secondary" onclick="clearFilters()">‚ùå ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
      </div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
    <div class="card p-4 mb-4">
      <h5 class="text-secondary mb-3"><i class="bi bi-calendar-month me-2"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (26-25)</h5>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
            <tr>
              <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (26-25)</th>
              <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
              <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th>ROAS</th>
            </tr>
          </thead>
          <tbody id="monthlyReportBody"></tbody>
          <tfoot id="monthlyFooter"></tfoot>
        </table>
      </div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
    <div class="card p-4 mb-4">
      <h5 class="text-secondary mb-3"><i class="bi bi-calendar2-week me-2"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h5>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-info">
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
              <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th>ROAS</th>
            </tr>
          </thead>
          <tbody id="dailyReportBody"></tbody>
          <tfoot id="dailyFooter"></tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Supabase
  const supabaseUrl = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô-5 ‡∏õ‡∏µ
  function populateYearOptions() {
    const select = document.getElementById('selectedYear');
    const currentYear = new Date().getFullYear();
    for(let y = currentYear; y >= currentYear - 5; y--) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      select.appendChild(opt);
    }
    select.value = currentYear;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á checkbox ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  function populateMonthCheckboxes() {
    const container = document.getElementById('monthCheckboxes');
    const monthNames = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
    for(let i=1; i<=12; i++) {
      const div = document.createElement('div');
      div.className = "form-check form-check-inline";
      div.innerHTML = `<input class="form-check-input" type="checkbox" id="month${i}" value="${i}" checked>
                       <label class="form-check-label" for="month${i}">${monthNames[i-1]}</label>`;
      container.appendChild(div);
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö 26-25
  function getCustomMonthPeriod(dateStr) {
    const d = new Date(dateStr);
    let year = d.getFullYear();
    let month = d.getMonth() + 1;
    if(d.getDate() < 26) {
      month -= 1;
      if(month === 0) {
        month = 12;
        year -= 1;
      }
    }
    return `${year}-${String(month).padStart(2,'0')}`;
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏∏‡πä‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (day ‡∏´‡∏£‡∏∑‡∏≠ month)
  function groupData(data, type) {
    const grouped = {};
    data.forEach(item => {
      const owner = item.owner || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      let key = "";
      if(type === 'day') {
        key = new Date(item.date).toISOString().slice(0,10);
      } else if(type === 'month') {
        key = getCustomMonthPeriod(item.date);
      }
      const groupKey = key + '|' + owner;
      if(!grouped[groupKey]) {
        grouped[groupKey] = { period: key, owner, spend: 0, cost: 0, purchase: 0, revenue: 0, roasSum: 0, roasCount: 0 };
      }
      grouped[groupKey].spend += +item.spend_total || 0;
      grouped[groupKey].cost += +item.cost_per_purchase || 0;
      grouped[groupKey].purchase += +item.purchases || 0;
      grouped[groupKey].revenue += +item.revenue || 0;
      grouped[groupKey].roasSum += +item.roas || 0;
      grouped[groupKey].roasCount += 1;
    });
    return Object.values(grouped);
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  function renderGroupTable(data, bodyId, footerId) {
    const body = document.getElementById(bodyId);
    const footer = document.getElementById(footerId);
    body.innerHTML = '';
    footer.innerHTML = '';

    let totalSpend = 0, totalCost = 0, totalPurchase = 0, totalRevenue = 0, totalRoasSum = 0, totalRoasCount = 0;

    data.forEach(row => {
      const avgRoas = row.roasCount > 0 ? row.roasSum / row.roasCount : 0;
      totalSpend += row.spend;
      totalCost += row.cost;
      totalPurchase += row.purchase;
      totalRevenue += row.revenue;
      totalRoasSum += row.roasSum;
      totalRoasCount += row.roasCount;

      let periodText = row.period;
      if(bodyId === 'monthlyReportBody') {
        const [y,m] = row.period.split('-');
        let year = parseInt(y), month = parseInt(m);
        let nextMonth = month + 1, nextYear = year;
        if(nextMonth > 12) { nextMonth = 1; nextYear++;}
        const monthNames = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        periodText = `26 ${monthNames[month-1]} ${year} - 25 ${monthNames[nextMonth-1]} ${nextYear}`;
      }

      body.innerHTML += `
        <tr>
          <td>${periodText}</td>
          <td>${row.owner}</td>
          <td>${row.spend.toFixed(2)}</td>
          <td>${row.cost.toFixed(2)}</td>
          <td>${row.purchase}</td>
          <td>${row.revenue.toFixed(2)}</td>
          <td>${avgRoas.toFixed(2)}</td>
        </tr>
      `;
    });

    // footer ‡∏£‡∏ß‡∏°
    const avgRoasTotal = totalRoasCount > 0 ? totalRoasSum / totalRoasCount : 0;
    footer.innerHTML = `
      <tr class="table-dark fw-bold">
        <td>‡∏£‡∏ß‡∏°</td>
        <td>-</td>
        <td>${totalSpend.toFixed(2)}</td>
        <td>${totalCost.toFixed(2)}</td>
        <td>${totalPurchase}</td>
        <td>${totalRevenue.toFixed(2)}</td>
        <td>${avgRoasTotal.toFixed(2)}</td>
      </tr>
    `;
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  async function loadAndRender() {
    const year = document.getElementById('selectedYear').value;
    const checkedMonths = Array.from(document.querySelectorAll('#monthCheckboxes input[type=checkbox]:checked')).map(cb => parseInt(cb.value));
    const startDateVal = document.getElementById('startDate').value;
    const endDateVal = document.getElementById('endDate').value;

    if (!year) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ');

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 26-25
    let dateRanges = [];
    if(startDateVal && endDateVal) {
      dateRanges.push({start: new Date(startDateVal), end: new Date(endDateVal)});
    } else {
      for(const m of checkedMonths) {
        let startYear = year, startMonth = m-2;
        if(startMonth < 0) {
          startMonth += 12;
          startYear--;
        }
        const start = new Date(startYear, startMonth, 26);
        const end = new Date(year, m-1, 25);
        dateRanges.push({start, end});
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á
    function inDateRanges(dateStr) {
      const d = new Date(dateStr);
      return dateRanges.some(r => d >= r.start && d <= r.end);
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase
    let { data, error } = await supabase
      .from('ad_history')
      .select('*')
      .order('date', { ascending: true });

    if(error) {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      console.error(error);
      return;
    }

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    data = data.filter(item => inDateRanges(item.date));

    // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Å‡∏•‡∏∏‡πà‡∏° owner + period)
    const dailyGrouped = groupData(data, 'day');
    const monthlyGrouped = groupData(data, 'month');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    renderGroupTable(monthlyGrouped, 'monthlyReportBody', 'monthlyFooter');
    renderGroupTable(dailyGrouped, 'dailyReportBody', 'dailyFooter');
  }

  function clearFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    const checkboxes = document.querySelectorAll('#monthCheckboxes input[type=checkbox]');
    checkboxes.forEach(cb => cb.checked = true);
    const currentYear = new Date().getFullYear();
    document.getElementById('selectedYear').value = currentYear;
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    populateYearOptions();
    populateMonthCheckboxes();
    clearFilters();
  });
</script>
</body>
</html>
