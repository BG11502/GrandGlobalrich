<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .table tfoot td { font-weight: bold; background-color: #f1f1f1; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="mb-3 d-flex justify-content-between">
    <a href="‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-primary">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
    <a href="index.html" class="btn btn-outline-secondary">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  </div>

  <h2 class="text-center text-primary mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î</h2>

  <!-- üîç ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
  <div class="card p-3 mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <select id="filterOwner" class="form-select"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="filterStart" class="form-control" />
      </div>
      <div class="col-md-3">
        <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" id="filterEnd" class="form-control" />
      </div>
      <div class="col-md-3 align-self-end">
        <button class="btn btn-success w-100" id="btnRender">üìà ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>
  </div>

  <!-- üìÜ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
  <div class="card p-4 mb-4">
    <h5 class="text-secondary mb-3">üìÜ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h5>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
            <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
            <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
            <th>ROAS</th>
          </tr>
        </thead>
        <tbody id="dailyReportBody"></tbody>
        <tfoot id="dailyFooter"></tfoot>
      </table>
    </div>
  </div>

  <!-- üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
  <div class="card p-4 mb-4">
    <h5 class="text-secondary mb-3">üóìÔ∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h5>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
            <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
            <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
            <th>ROAS</th>
          </tr>
        </thead>
        <tbody id="monthlyReportBody"></tbody>
        <tfoot id="monthlyFooter"></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- ‚úÖ ‡πÇ‡∏´‡∏•‡∏î Supabase ‡∏Å‡πà‡∏≠‡∏ô -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
  const supabaseUrl = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  let adData = [];

  async function loadOwners() {
    const { data: owners } = await supabase.from('ad_owners').select('name').order('name');
    const select = document.getElementById('filterOwner');
    select.innerHTML = '<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
    if (owners && owners.length > 0) {
      owners.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.name;
        opt.textContent = o.name;
        select.appendChild(opt);
      });
    }
  }

  function groupData(data, type) {
    const grouped = {};
    data.forEach(e => {
      const d = new Date(e.date);
      const owner = e.owner || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      let key = "";

      if (type === "day") {
        key = d.toISOString().slice(0, 10);
      } else if (type === "month") {
        key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
      }

      const groupKey = key + "|" + owner;

      if (!grouped[groupKey]) {
        grouped[groupKey] = {
          period: key,
          owner,
          spend: 0,
          cost: 0,
          purchase: 0,
          revenue: 0,
          roasSum: 0,
          roasCount: 0
        };
      }

      grouped[groupKey].spend += +e.spend_total || 0;
      grouped[groupKey].cost += +e.cost_per_purchase || 0;
      grouped[groupKey].purchase += +e.purchases || 0;
      grouped[groupKey].revenue += +e.revenue || 0;
      grouped[groupKey].roasSum += +e.roas || 0;
      grouped[groupKey].roasCount += 1;
    });

    return Object.values(grouped);
  }

  function renderGroupTable(data, bodyId, footerId) {
    const body = document.getElementById(bodyId);
    const footer = document.getElementById(footerId);
    body.innerHTML = "";
    footer.innerHTML = "";

    let totalSpend = 0, totalCost = 0, totalPurchase = 0, totalRevenue = 0, totalRoasSum = 0, totalRoasCount = 0;

    data.forEach(e => {
      const avgRoas = e.roasCount > 0 ? e.roasSum / e.roasCount : 0;

      totalSpend += e.spend;
      totalCost += e.cost;
      totalPurchase += e.purchase;
      totalRevenue += e.revenue;
      totalRoasSum += e.roasSum;
      totalRoasCount += e.roasCount;

      body.innerHTML += `
        <tr>
          <td>${e.period}</td>
          <td>${e.owner}</td>
          <td>${e.spend.toFixed(2)}</td>
          <td>${e.cost.toFixed(2)}</td>
          <td>${e.purchase}</td>
          <td>${e.revenue.toFixed(2)}</td>
          <td>${avgRoas.toFixed(2)}</td>
        </tr>`;
    });

    if (data.length > 0) {
      const avgRoasTotal = totalRoasCount > 0 ? totalRoasSum / totalRoasCount : 0;
      footer.innerHTML = `
        <tr>
          <td colspan="2">‡∏£‡∏ß‡∏°</td>
          <td>${totalSpend.toFixed(2)}</td>
          <td>${totalCost.toFixed(2)}</td>
          <td>${totalPurchase}</td>
          <td>${totalRevenue.toFixed(2)}</td>
          <td>${avgRoasTotal.toFixed(2)}</td>
        </tr>`;
    }
  }

  async function loadData() {
    const ownerFilter = document.getElementById("filterOwner").value;
    const start = document.getElementById("filterStart").value;
    const end = document.getElementById("filterEnd").value;

    let query = supabase.from('ad_history').select('*').order('date', { ascending: true });

    if (ownerFilter && ownerFilter !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
      query = query.eq('owner', ownerFilter);
    }
    if (start) {
      query = query.gte('date', start);
    }
    if (end) {
      query = query.lte('date', end);
    }

    const { data, error } = await query;

    if (error) {
      alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      return;
    }

    adData = data || [];
    const dailyData = groupData(adData, "day");
    const monthlyData = groupData(adData, "month");
    renderGroupTable(dailyData, "dailyReportBody", "dailyFooter");
    renderGroupTable(monthlyData, "monthlyReportBody", "monthlyFooter");
  }

  document.getElementById("btnRender").addEventListener("click", loadData);

  loadOwners().then(loadData);
</script>
</body>
</html>
