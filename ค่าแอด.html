<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .table tfoot td {
      font-weight: bold;
      background-color: #f1f1f1;
    }
    .btn-icon {
      display: inline-flex;
      align-items: center;
      gap: 0.4em;
    }
    .btn-outline-secondary:hover {
      background-color: #e2e6ea;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå -->
    <div class="d-flex justify-content-between mb-4">
      <a href="index.html" class="btn btn-outline-primary btn-icon">
        <i class="bi bi-house-door"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
      </a>
      <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-secondary btn-icon">
        <i class="bi bi-graph-up-arrow"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î
      </a>
    </div>

    <h2 class="text-center mb-4 text-primary">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h2>

    <!-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
      <div class="input-group">
        <input
          type="text"
          id="newOwner"
          class="form-control"
          placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà"
        />
        <button class="btn btn-success" id="btnAddOwner" type="button">
          <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
        </button>
      </div>
      <div id="ownerList" class="d-flex flex-wrap gap-2 mt-3"></div>
    </div>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="card p-4 mb-4">
      <form id="adForm">
        <input type="hidden" id="editIndex" />
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <input type="date" id="date" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input type="text" id="accountName" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <input type="text" id="accountId" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <select id="owner" class="form-select" required></select>
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
            <select id="status" class="form-select">
              <option value="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
              <option value="‡∏£‡∏∞‡∏á‡∏±‡∏ö">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
            <input
              type="number"
              id="spendTotal"
              class="form-control"
              step="0.01"
              value="0"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</label>
            <input
              type="number"
              id="costPerPurchase"
              class="form-control"
              step="0.01"
              value="0"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label>
            <input type="number" id="purchases" class="form-control" value="0" />
          </div>
          <div class="col-md-3">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
            <input
              type="number"
              id="revenue"
              class="form-control"
              step="0.01"
              value="0"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">ROAS</label>
            <input
              type="number"
              id="roas"
              class="form-control"
              step="0.01"
              value="0"
            />
          </div>
        </div>
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary btn-lg" id="btnSave">
            <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>
      </form>
    </div>

    <!-- ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
      <select id="filterOwner" class="form-select w-auto"></select>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
    <div class="card p-4">
      <h5 class="text-secondary mb-3">
        <i class="bi bi-clock-history"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
      </h5>
      <div class="table-responsive">
        <table
          class="table table-bordered table-striped text-center align-middle"
        >
          <thead class="table-light">
            <tr>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>ID</th>
              <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
              <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
              <th>ROAS</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5">‡∏£‡∏ß‡∏°</td>
              <td id="sumSpend">0.00</td>
              <td id="avgCost">0.00</td>
              <td id="sumPurchase">0</td>
              <td id="sumRevenue">0.00</td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="mt-3 text-end">
        <button
          class="btn btn-secondary btn-icon"
          onclick="undoDelete()"
          id="undoBtn"
          style="display: none"
        >
          <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://vzxttbvwukpsxqdaulvo.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let adHistory = [];
    let ownerList = [];
    let lastDeleted = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    async function fetchOwnerList() {
      try {
        const { data, error } = await supabase
          .from("ad_owners")
          .select("name")
          .order("name");
        if (error) throw error;
        ownerList = data.map((e) => e.name);
        renderOwnerSelect();
      } catch (err) {
        alert("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
    function renderOwnerSelect() {
      const owner = document.getElementById("owner");
      const filter = document.getElementById("filterOwner");
      const ownerListDiv = document.getElementById("ownerList");

      owner.innerHTML = `<option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>`;
      filter.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
      ownerListDiv.innerHTML = "";

      ownerList.forEach((name, i) => {
        owner.innerHTML += `<option value="${name}">${name}</option>`;
        filter.innerHTML += `<option value="${name}">${name}</option>`;
        ownerListDiv.innerHTML += `
          <div class="badge bg-secondary p-2">
            ${name}
            <button class="btn-close btn-sm ms-2" aria-label="Close" onclick="removeOwner(${i})"></button>
          </div>`;
      });
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤
    async function fetchAdHistory() {
      try {
        const { data, error } = await supabase
          .from("ad_history")
          .select("*")
          .order("date", { ascending: false });
        if (error) throw error;
        adHistory = data;
        renderTable();
      } catch (err) {
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
      }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function renderTable() {
      const filter = document.getElementById("filterOwner").value;
      const tbody = document.getElementById("historyBody");
      tbody.innerHTML = "";
      let filteredData =
        filter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
          ? adHistory
          : adHistory.filter((e) => e.owner === filter);

      if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
      }

      let sumSpend = 0,
        sumCost = 0,
        sumPurchase = 0,
        sumRevenue = 0;

      filteredData.forEach((e, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${e.date}</td>
            <td>${e.accountName}</td>
            <td>${e.accountId}</td>
            <td>${e.owner}</td>
            <td>${e.status || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</td>
            <td>${parseFloat(e.spendTotal).toFixed(2)}</td>
            <td>${parseFloat(e.costPerPurchase).toFixed(2)}</td>
            <td>${e.purchases}</td>
            <td>${parseFloat(e.revenue).toFixed(2)}</td>
            <td>${parseFloat(e.roas).toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="editEntry(${i})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})" title="‡∏•‡∏ö">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
        sumSpend += parseFloat(e.spendTotal) || 0;
        sumCost += parseFloat(e.costPerPurchase) || 0;
        sumPurchase += parseInt(e.purchases) || 0;
        sumRevenue += parseFloat(e.revenue) || 0;
      });

      document.getElementById("sumSpend").textContent = sumSpend.toFixed(2);
      document.getElementById("avgCost").textContent =
        filteredData.length > 0 ? (sumCost / filteredData.length).toFixed(2) : "0.00";
      document.getElementById("sumPurchase").textContent = sumPurchase;
      document.getElementById("sumRevenue").textContent = sumRevenue.toFixed(2);
    }

    // ‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    function editEntry(index) {
      const e = adHistory[index];
      document.getElementById("editIndex").value = index;
      date.value = e.date;
      accountName.value = e.accountName;
      accountId.value = e.accountId;
      owner.value = e.owner;
      status.value = e.status;
      spendTotal.value = e.spendTotal;
      costPerPurchase.value = e.costPerPurchase;
      purchases.value = e.purchases;
      revenue.value = e.revenue;
      roas.value = e.roas;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    async function addOwner() {
      const input = document.getElementById("newOwner");
      const name = input.value.trim();
      if (!name) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
        return;
      }
      if (ownerList.includes(name)) {
        alert("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
        return;
      }
      try {
        document.getElementById("btnAddOwner").disabled = true;
        const { error } = await supabase.from("ad_owners").insert([{ name }]);
        if (error) throw error;
        input.value = "";
        await fetchOwnerList();
      } catch (err) {
        alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      } finally {
        document.getElementById("btnAddOwner").disabled = false;
      }
    }

    // ‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
    async function removeOwner(i) {
      if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ "${ownerList[i]}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      try {
        const name = ownerList[i];
        const { error } = await supabase.from("ad_owners").delete().eq("name", name);
        if (error) throw error;
        await fetchOwnerList();
      } catch (err) {
        alert("‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    async function deleteEntry(i) {
      if (!confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
      try {
        const id = adHistory[i].id;
        lastDeleted = adHistory[i];
        const { error } = await supabase.from("ad_history").delete().eq("id", id);
        if (error) throw error;
        await fetchAdHistory();
        document.getElementById("undoBtn").style.display = "inline-block";
      } catch (err) {
        alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö
    async function undoDelete() {
      if (!lastDeleted) return;
      try {
        const { error } = await supabase.from("ad_history").insert([lastDeleted]);
        if (error) throw error;
        lastDeleted = null;
        await fetchAdHistory();
        document.getElementById("undoBtn").style.display = "none";
      } catch (err) {
        alert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
    document.getElementById("adForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btnSave = document.getElementById("btnSave");
      btnSave.disabled = true;

      const entry = {
        date: date.value,
        accountName: accountName.value,
        accountId: accountId.value,
        owner: owner.value,
        status: status.value,
        spendTotal: parseFloat(spendTotal.value) || 0,
        costPerPurchase: parseFloat(costPerPurchase.value) || 0,
        purchases: parseInt(purchases.value) || 0,
        revenue: parseFloat(revenue.value) || 0,
        roas: parseFloat(roas.value) || 0,
      };

      try {
        const editIdx = document.getElementById("editIndex").value;
        if (editIdx !== "") {
          // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          const id = adHistory[editIdx].id;
          const { error } = await supabase
            .from("ad_history")
            .update(entry)
            .eq("id", id);
          if (error) throw error;
        } else {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
          const { error } = await supabase.from("ad_history").insert([entry]);
          if (error) throw error;
        }
        document.getElementById("adForm").reset();
        document.getElementById("editIndex").value = "";
        await fetchAdHistory();
      } catch (err) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      } finally {
        btnSave.disabled = false;
      }
    });

    // ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
    document.getElementById("filterOwner").addEventListener("change", renderTable);

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
    document.getElementById("btnAddOwner").addEventListener("click", addOwner);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    fetchOwnerList();
    fetchAdHistory();
  </script>
</body>
</html>
