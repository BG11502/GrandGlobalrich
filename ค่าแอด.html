<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .table tfoot td { font-weight: bold; background-color: #f1f1f1; }
    .btn-icon { display: inline-flex; align-items: center; gap: 0.4em; }
    .btn-outline-secondary:hover { background-color: #e2e6ea; }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- üîó ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå -->
  <div class="d-flex justify-content-between mb-4">
    <a href="index.html" class="btn btn-outline-primary btn-icon">
      <i class="bi bi-house-door"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </a>
    <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-secondary btn-icon">
      <i class="bi bi-graph-up-arrow"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î
    </a>
  </div>

  <!-- ‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
  <h2 class="text-center mb-4 text-primary">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h2>

  <!-- üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
  <div class="card p-3 mb-4">
    <h5 class="mb-3">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
    <div class="input-group">
      <input type="text" id="newOwner" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà">
      <button class="btn btn-success" onclick="addOwner()">
        <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
    </div>
    <div id="ownerList" class="d-flex flex-wrap gap-2 mt-3"></div>
  </div>

  <!-- üì• ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  <div class="card p-4 mb-4">
    <form id="adForm">
      <input type="hidden" id="editIndex">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="date" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <input type="text" id="accountName" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <input type="text" id="accountId" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <select id="owner" class="form-select" required></select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <select id="status" class="form-select">
            <option value="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="‡∏£‡∏∞‡∏á‡∏±‡∏ö">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
          <input type="number" id="spendTotal" class="form-control" step="0.01">
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="number" id="costPerPurchase" class="form-control" step="0.01">
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label>
          <input type="number" id="purchases" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
          <input type="number" id="revenue" class="form-control" step="0.01">
        </div>
        <div class="col-md-3">
          <label class="form-label">ROAS</label>
          <input type="number" id="roas" class="form-control" step="0.01">
        </div>
      </div>
      <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary btn-lg">
          <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </form>
  </div>

  <!-- üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <label class="form-label">‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
    <select id="filterOwner" class="form-select w-auto"></select>
  </div>

  <!-- üïò ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <div class="card p-4">
    <h5 class="text-secondary mb-3"><i class="bi bi-clock-history"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-light">
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
            <th>ID</th>
            <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
            <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
            <th>ROAS</th>
            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="5">‡∏£‡∏ß‡∏°</td>
            <td id="sumSpend">0.00</td>
            <td id="avgCost">0.00</td>
            <td id="sumPurchase">0</td>
            <td id="sumRevenue">0.00</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="mt-3 text-end">
      <button class="btn btn-secondary btn-icon" onclick="undoDelete()" id="undoBtn" style="display:none;">
        <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö
      </button>
    </div>
  </div>
</div>

<!-- ‚úÖ SCRIPT ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -->
<script>
let adHistory = JSON.parse(localStorage.getItem("adHistory") || "[]");
let ownerList = JSON.parse(localStorage.getItem("ownerList") || "[]");
let lastDeleted = null;

function saveData() {
  localStorage.setItem("adHistory", JSON.stringify(adHistory));
  renderTable();
}

function saveOwners() {
  localStorage.setItem("ownerList", JSON.stringify(ownerList));
  renderOwnerSelect();
}

function renderOwnerSelect() {
  const owner = document.getElementById("owner");
  const filter = document.getElementById("filterOwner");
  owner.innerHTML = `<option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>`;
  filter.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
  ownerList.forEach(o => {
    owner.innerHTML += `<option value="${o}">${o}</option>`;
    filter.innerHTML += `<option value="${o}">${o}</option>`;
  });

  const list = document.getElementById("ownerList");
  list.innerHTML = "";
  ownerList.forEach((name, i) => {
    list.innerHTML += `
      <div class="badge bg-secondary p-2">
        ${name}
        <button class="btn-close btn-sm ms-2" onclick="removeOwner(${i})"></button>
      </div>`;
  });
}

function addOwner() {
  const name = document.getElementById("newOwner").value.trim();
  if (name && !ownerList.includes(name)) {
    ownerList.push(name);
    saveOwners();
    document.getElementById("newOwner").value = "";
  }
}

function removeOwner(i) {
  ownerList.splice(i, 1);
  saveOwners();
}

function renderTable() {
  const filter = document.getElementById("filterOwner").value;
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";
  const data = filter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ? adHistory : adHistory.filter(e => e.owner === filter);
  let sumSpend = 0, sumCost = 0, sumPurchase = 0, sumRevenue = 0;

  data.forEach((e, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${e.date}</td>
        <td>${e.accountName}</td>
        <td>${e.accountId}</td>
        <td>${e.owner}</td>
        <td>${e.status || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</td>
        <td>${e.spendTotal.toFixed(2)}</td>
        <td>${e.costPerPurchase.toFixed(2)}</td>
        <td>${e.purchases}</td>
        <td>${e.revenue.toFixed(2)}</td>
        <td>${e.roas.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editEntry(${i})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})">üóëÔ∏è</button>
        </td>
      </tr>`;
    sumSpend += e.spendTotal;
    sumCost += e.costPerPurchase;
    sumPurchase += e.purchases;
    sumRevenue += e.revenue;
  });

  document.getElementById("sumSpend").textContent = sumSpend.toFixed(2);
  document.getElementById("avgCost").textContent = (data.length ? (sumCost / data.length).toFixed(2) : "0.00");
  document.getElementById("sumPurchase").textContent = sumPurchase;
  document.getElementById("sumRevenue").textContent = sumRevenue.toFixed(2);
}

function editEntry(i) {
  const e = adHistory[i];
  document.getElementById("editIndex").value = i;
  date.value = e.date;
  accountName.value = e.accountName;
  accountId.value = e.accountId;
  owner.value = e.owner;
  status.value = e.status;
  spendTotal.value = e.spendTotal;
  costPerPurchase.value = e.costPerPurchase;
  purchases.value = e.purchases;
  revenue.value = e.revenue;
  roas.value = e.roas;
}

function deleteEntry(i) {
  if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) {
    lastDeleted = adHistory[i];
    adHistory.splice(i, 1);
    saveData();
    document.getElementById("undoBtn").style.display = "inline-block";
  }
}

function undoDelete() {
  if (lastDeleted) {
    adHistory.push(lastDeleted);
    lastDeleted = null;
    saveData();
    document.getElementById("undoBtn").style.display = "none";
  }
}

document.getElementById("adForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const entry = {
    date: date.value,
    accountName: accountName.value,
    accountId: accountId.value,
    owner: owner.value,
    status: status.value,
    spendTotal: parseFloat(spendTotal.value) || 0,
    costPerPurchase: parseFloat(costPerPurchase.value) || 0,
    purchases: parseInt(purchases.value) || 0,
    revenue: parseFloat(revenue.value) || 0,
    roas: parseFloat(roas.value) || 0,
  };
  const i = document.getElementById("editIndex").value;
  if (i) adHistory[i] = entry;
  else adHistory.push(entry);
  this.reset();
  document.getElementById("editIndex").value = "";
  saveData();
});

document.getElementById("filterOwner").addEventListener("change", renderTable);
renderOwnerSelect();
renderTable();
</script>
<script>
// ‚úÖ Supabase client
const supabase = supabase.createClient(
  "https://vzxttbvwukpsxqdaulvo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U"
);

// üóÉÔ∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡πÅ‡∏ó‡∏ô localStorage
async function fetchAdHistory() {
  const { data, error } = await supabase.from("ad_history").select("*").order("date", { ascending: true });
  if (error) return console.error("Load error", error);
  window.adHistory = data;
  renderTable();
}

async function fetchOwnerList() {
  const { data, error } = await supabase.from("ad_owners").select("name");
  if (error) return console.error("Owner fetch error", error);
  window.ownerList = data.map(e => e.name);
  renderOwnerSelect();
}

// üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
document.getElementById("adForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const entry = {
    date: date.value,
    accountName: accountName.value,
    accountId: accountId.value,
    owner: owner.value,
    status: status.value,
    spendTotal: parseFloat(spendTotal.value) || 0,
    costPerPurchase: parseFloat(costPerPurchase.value) || 0,
    purchases: parseInt(purchases.value) || 0,
    revenue: parseFloat(revenue.value) || 0,
    roas: parseFloat(roas.value) || 0,
  };

  const editIdx = document.getElementById("editIndex").value;
  if (editIdx) {
    const id = adHistory[editIdx].id;
    await supabase.from("ad_history").update(entry).eq("id", id);
  } else {
    await supabase.from("ad_history").insert([entry]);
  }
  this.reset();
  document.getElementById("editIndex").value = "";
  fetchAdHistory();
});

// üìù ‡∏•‡∏ö / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / Undo
async function deleteEntry(i) {
  if (!confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
  const id = adHistory[i].id;
  window.lastDeleted = adHistory[i];
  await supabase.from("ad_history").delete().eq("id", id);
  document.getElementById("undoBtn").style.display = "inline-block";
  fetchAdHistory();
}

async function undoDelete() {
  if (window.lastDeleted) {
    await supabase.from("ad_history").insert([window.lastDeleted]);
    window.lastDeleted = null;
    fetchAdHistory();
    document.getElementById("undoBtn").style.display = "none";
  }
}

// üë§ Owner management
async function addOwner() {
  const name = document.getElementById("newOwner").value.trim();
  if (!name || ownerList.includes(name)) return;
  await supabase.from("ad_owners").insert([{ name }]);
  fetchOwnerList();
  document.getElementById("newOwner").value = "";
}

async function removeOwner(i) {
  const name = ownerList[i];
  await supabase.from("ad_owners").delete().eq("name", name);
  fetchOwnerList();
}

window.addOwner = addOwner;
window.removeOwner = removeOwner;
window.deleteEntry = deleteEntry;
window.undoDelete = undoDelete;

// üöÄ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
fetchAdHistory();
fetchOwnerList();
</script>

</body>
</html>
