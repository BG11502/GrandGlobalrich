<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body {
            background-color: #e9f0f6; /* Lighter, soft blue background */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #ffffff; /* White navbar for crisp look */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* More prominent shadow */
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px); /* Subtle lift on hover */
        }
        .card-header {
            background-color: #f0f8ff; /* Lightest blue for header */
            border-bottom: 1px solid #dcdcdc;
            font-weight: bold;
            color: #34495e; /* Darker text for contrast */
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            padding: 1.25rem 1.5rem;
            font-size: 1.15rem;
        }
        .table thead {
            background-color: #e0e9f0; /* Soft blue for table header */
            color: #34495e;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f6faff; /* Lighter row background */
        }
        .table tfoot td {
            font-weight: bold;
            background-color: #dbe4ec; /* Slightly darker footer */
            color: #2c3e50;
            border-top: 2px solid #b0c4de;
        }
        .btn-primary {
            background-color: #007bff; /* Bootstrap primary blue */
            border-color: #007bff;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3; /* Darker blue on hover */
            border-color: #004085;
        }
        .btn-outline-primary {
            color: #007bff;
            border-color: #007bff;
        }
        .btn-outline-primary:hover {
            background-color: #e6f2ff;
            color: #0056b3;
            border-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #343a40; /* Darker text for readability */
        }
        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #cc9c00;
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .form-control, .form-select {
            border-radius: 0.5rem; /* Slightly rounded inputs */
            border: 1px solid #ced4da;
            padding: 0.75rem 1rem;
        }
        .badge {
            font-size: 0.9em;
            padding: 0.6em 0.9em;
            border-radius: 0.5rem;
        }
        .bi {
            vertical-align: middle; /* Align icons nicely */
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid container">
        <a class="navbar-brand text-primary fw-bold" href="#">
            <i class="bi bi-bar-chart-fill me-2"></i>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤
        </a>
        <div class="d-flex ms-auto">
            <a href="index.html" class="btn btn-outline-primary btn-icon me-2">
                <i class="bi bi-house-door"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
            <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html" class="btn btn-outline-secondary btn-icon">
                <i class="bi bi-graph-up-arrow"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î
            </a>
        </div>
    </div>
</nav>

<div class="container py-5">
    <h2 class="text-center mb-5 text-primary display-5 fw-bold">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h2>

    <div class="card mb-5">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-person-fill me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
        </div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="text" id="newOwner" class="form-control form-control-lg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà" />
                <button class="btn btn-success btn-lg" id="btnAddOwner"><i class="bi bi-plus-circle me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div id="ownerList" class="d-flex flex-wrap gap-2 mt-3"></div>
        </div>
    </div>

    <div class="card mb-5">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i> ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h5>
        </div>
        <div class="card-body">
            <form id="adForm">
                <input type="hidden" id="editId" />
                <div class="row g-4">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="date" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="text" id="accountName" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <input type="text" id="accountId" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <select id="owner" class="form-select" required></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                        <select id="status" class="form-select">
                            <option>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
                            <option>‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
                        <input type="number" id="spendTotal" class="form-control" step="0.01" value="0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="number" id="costPerPurchase" class="form-control" step="0.01" value="0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="number" id="purchases" class="form-control" value="0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
                        <input type="number" id="revenue" class="form-control" step="0.01" value="0" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">ROAS</label>
                        <input type="number" id="roas" class="form-control" step="0.01" value="0" />
                    </div>
                </div>
                <div class="mt-5 text-end">
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 p-3 bg-white rounded-3 shadow-sm">
        <div class="d-flex flex-wrap align-items-center gap-3 mb-2 mb-md-0">
            <label class="form-label mb-0 fw-bold text-muted">‡∏Å‡∏£‡∏≠‡∏á:</label>
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <select id="filterOwner" class="form-select form-select-sm w-auto"></select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                <select id="filterAccountName" class="form-select form-select-sm w-auto">
                    <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
            </div>
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" id="filterStartDate" class="form-control form-control-sm w-auto" />
            </div>
            <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="date" id="filterEndDate" class="form-control form-control-sm w-auto" />
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <button id="toggleHistoryBtn" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-eye me-1"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
            </button>
            <div id="undoContainer" style="display:none;">
                <button id="undoBtn" class="btn btn-sm btn-warning">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                </button>
            </div>
        </div>
    </div>

    <div class="card p-4">
        <h5 class="text-secondary mb-4"><i class="bi bi-clock-history me-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-striped text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                        <th>ID</th>
                        <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
                        <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</th>
                        <th>‡∏ã‡∏∑‡πâ‡∏≠</th>
                        <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                        <th>ROAS</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="5">‡∏£‡∏ß‡∏°</td>
                        <td id="sumSpend">0.00</td>
                        <td id="avgCost">0.00</td>
                        <td id="sumPurchase">0</td>
                        <td id="sumRevenue">0.00</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<script>
    const supabaseUrl = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let adData = [];
    let lastDeletedEntry = null;

    const historyTableDiv = document.querySelector(".table-responsive");
    const toggleBtn = document.getElementById("toggleHistoryBtn");
    
    // Function to calculate ROAS
    function calculateROAS() {
        const spend = parseFloat(document.getElementById("spendTotal").value) || 0;
        const revenue = parseFloat(document.getElementById("revenue").value) || 0;
        const roas = spend > 0 ? (revenue / spend).toFixed(2) : 0;
        document.getElementById("roas").value = roas;
    }

    // Attach event listeners for ROAS calculation
    document.getElementById("spendTotal").addEventListener("input", calculateROAS);
    document.getElementById("revenue").addEventListener("input", calculateROAS);


    function loadHistoryVisibility() {
        const visible = localStorage.getItem("historyVisible");
        if (visible === "false") {
            historyTableDiv.style.display = "none";
            toggleBtn.innerHTML = '<i class="bi bi-eye-fill me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
        } else {
            historyTableDiv.style.display = "block";
            toggleBtn.innerHTML = '<i class="bi bi-eye-slash-fill me-1"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
        }
    }

    toggleBtn.addEventListener("click", () => {
        if (historyTableDiv.style.display === "none") {
            historyTableDiv.style.display = "block";
            toggleBtn.innerHTML = '<i class="bi bi-eye-slash-fill me-1"></i> ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
            localStorage.setItem("historyVisible", "true");
        } else {
            historyTableDiv.style.display = "none";
            toggleBtn.innerHTML = '<i class="bi bi-eye-fill me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á';
            localStorage.setItem("historyVisible", "false");
        }
    });

    function showUndoButton(show) {
        const undoContainer = document.getElementById("undoContainer");
        undoContainer.style.display = show ? "block" : "none";
    }

    async function loadOwners() {
        const { data } = await _supabase.from('ad_owners').select('name');
        const ownerSel = document.getElementById("owner");
        const filterSel = document.getElementById("filterOwner");
        const list = document.getElementById("ownerList");

        ownerSel.innerHTML = `<option disabled selected value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>`;
        filterSel.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
        list.innerHTML = "";

        if (data) {
            data.forEach((o) => {
                ownerSel.innerHTML += `<option value="${o.name}">${o.name}</option>`;
                filterSel.innerHTML += `<option value="${o.name}">${o.name}</option>`;
                list.innerHTML += `<div class="badge bg-primary p-2 d-flex align-items-center me-2 mb-2">${o.name}
                    <button class="btn-close btn-close-white btn-sm ms-2" onclick="removeOwner('${o.name}')" aria-label="Remove"></button></div>`;
            });
        }
    }

    async function populateAccountNamesFilter() {
        const { data } = await _supabase.from("ad_history").select("account_name");
        const filterAccountNameSel = document.getElementById("filterAccountName");
        filterAccountNameSel.innerHTML = `<option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
        if (data) {
            const uniqueAccountNames = [...new Set(data.map(e => e.account_name))].sort();
            uniqueAccountNames.forEach(name => {
                filterAccountNameSel.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
    }

    async function loadHistory() {
        const filterOwner = document.getElementById("filterOwner").value;
        const filterAccountName = document.getElementById("filterAccountName").value;
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const filterStartDate = document.getElementById("filterStartDate").value;
        const filterEndDate = document.getElementById("filterEndDate").value;

        let { data } = await _supabase.from("ad_history").select("*").order("date", { ascending: false });
        adData = data || [];

        if (filterOwner !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
            adData = adData.filter(e => e.owner === filterOwner);
        }
        if (filterAccountName !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
            adData = adData.filter(e => e.account_name === filterAccountName);
        }
        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (filterStartDate) {
            adData = adData.filter(e => e.date >= filterStartDate);
        }
        if (filterEndDate) {
            adData = adData.filter(e => e.date <= filterEndDate);
        }

        renderTable();
        showUndoButton(lastDeletedEntry !== null);
    }

    function renderTable() {
        const tbody = document.getElementById("historyBody");
        if (adData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="text-muted py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</td></tr>';
            document.getElementById("sumSpend").textContent = "0.00";
            document.getElementById("avgCost").textContent = "0.00";
            document.getElementById("sumPurchase").textContent = "0";
            document.getElementById("sumRevenue").textContent = "0.00";
            return;
        }
        tbody.innerHTML = "";
        let sumSpend = 0, sumPurchasesForAvg = 0, sumRevenue = 0;
        adData.forEach((e, i) => {
            tbody.innerHTML += `
                <tr>
                    <td>${e.date}</td>
                    <td>${e.account_name}</td>
                    <td>${e.account_id}</td>
                    <td>${e.owner}</td>
                    <td><span class="badge ${e.status === '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥' ? 'bg-success' : 'bg-danger'}">${e.status}</span></td>
                    <td>${(+e.spend_total).toFixed(2)}</td>
                    <td>${(+e.cost_per_purchase).toFixed(2)}</td>
                    <td>${e.purchases}</td>
                    <td>${(+e.revenue).toFixed(2)}</td>
                    <td>${(+e.roas).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editEntry(${i})" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${i})" title="‡∏•‡∏ö">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            sumSpend += +e.spend_total;
            sumPurchasesForAvg += +e.purchases;
            sumRevenue += +e.revenue;
        });

        const totalCostPerPurchase = adData.reduce((sum, e) => sum + (+e.cost_per_purchase), 0);

        document.getElementById("sumSpend").textContent = sumSpend.toFixed(2);
        document.getElementById("avgCost").textContent = (adData.length ? totalCostPerPurchase / adData.length : 0).toFixed(2);
        document.getElementById("sumPurchase").textContent = sumPurchasesForAvg;
        document.getElementById("sumRevenue").textContent = sumRevenue.toFixed(2);
    }

    async function addOwner() {
        const name = document.getElementById("newOwner").value.trim();
        if (!name) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
            return;
        }
        const { error } = await _supabase.from("ad_owners").insert([{ name }]);
        if (error) {
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            return;
        }
        document.getElementById("newOwner").value = "";
        await loadOwners();
        await loadHistory();
    }

    async function removeOwner(name) {
        if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ "${name}"? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö`)) return;
        const { error } = await _supabase.from("ad_owners").delete().eq("name", name);
        if (error) {
            alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            return;
        }
        await loadOwners();
        await loadHistory();
    }

    function editEntry(i) {
        const e = adData[i];
        document.getElementById("editId").value = e.id;
        document.getElementById("date").value = e.date;
        document.getElementById("accountName").value = e.account_name;
        document.getElementById("accountId").value = e.account_id;
        document.getElementById("owner").value = e.owner;
        document.getElementById("status").value = e.status;
        document.getElementById("spendTotal").value = e.spend_total;
        document.getElementById("costPerPurchase").value = e.cost_per_purchase;
        document.getElementById("purchases").value = e.purchases;
        document.getElementById("revenue").value = e.revenue;
        document.getElementById("roas").value = e.roas;
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function deleteEntry(i) {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;
        const id = adData[i].id;
        lastDeletedEntry = adData[i];
        const { error } = await _supabase.from("ad_history").delete().eq("id", id);
        if (error) {
            alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            lastDeletedEntry = null;
            return;
        }
        await loadHistory();
        await populateAccountNamesFilter();
        showUndoButton(true);
    }

    document.getElementById("undoBtn").addEventListener("click", async () => {
        if (!lastDeletedEntry) return;
        const { error } = await _supabase.from("ad_history").insert([lastDeletedEntry]);
        if (error) {
            alert("‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            return;
        }
        lastDeletedEntry = null;
        showUndoButton(false);
        await loadHistory();
        await populateAccountNamesFilter();
    });

    document.getElementById("adForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const entry = {
            date: document.getElementById("date").value,
            account_name: document.getElementById("accountName").value,
            account_id: document.getElementById("accountId").value,
            owner: document.getElementById("owner").value,
            status: document.getElementById("status").value,
            spend_total: parseFloat(document.getElementById("spendTotal").value) || 0,
            cost_per_purchase: parseFloat(document.getElementById("costPerPurchase").value) || 0,
            purchases: parseInt(document.getElementById("purchases").value) || 0,
            revenue: parseFloat(document.getElementById("revenue").value) || 0,
            roas: parseFloat(document.getElementById("roas").value) || 0,
        };

        let error;
        if (id) {
            ({ error } = await _supabase.from("ad_history").update(entry).eq("id", id));
        } else {
            ({ error } = await _supabase.from("ad_history").insert([entry]));
        }

        if (error) {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
            return;
        }

        document.getElementById("adForm").reset();
        document.getElementById("editId").value = "";
        await loadHistory();
        await populateAccountNamesFilter();
        calculateROAS(); // Reset ROAS field after submission
    });

    document.getElementById("btnAddOwner").addEventListener("click", addOwner);
    document.getElementById("filterOwner").addEventListener("change", loadHistory);
    document.getElementById("filterAccountName").addEventListener("change", loadHistory);
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    document.getElementById("filterStartDate").addEventListener("change", loadHistory);
    document.getElementById("filterEndDate").addEventListener("change", loadHistory);
    

    // Add event listener to "‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î" button for login check
    document.querySelector('a[href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏î.html"]').addEventListener('click', (e) => {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            e.preventDefault(); // Prevent default navigation
            window.location.href = 'login.html';
        }
    });

    loadOwners();
    populateAccountNamesFilter();
    loadHistory();
    loadHistoryVisibility();
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (!loggedInUser) {
            window.location.href = 'login.html';
        }
    });
</script>
</body>
</html>
