<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />
  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 900px; }
    table th, table td { vertical-align: middle !important; text-align: center; }
    .btn-small { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-4 text-primary text-center">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h2>

  <div class="mb-4">
    <label for="newOwner" class="form-label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</label>
    <div class="input-group">
      <input type="text" id="newOwner" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà" />
      <button class="btn btn-success" id="btnAddOwner" type="button">
        <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
      </button>
    </div>
  </div>

  <form id="adForm" class="card p-4 mb-4 shadow-sm bg-white rounded">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
        <input type="date" id="date" class="form-control" required />
      </div>
      <div class="col-md-4">
        <label for="accountName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ *</label>
        <input type="text" id="accountName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" required />
      </div>
      <div class="col-md-4">
        <label for="accountId" class="form-label">ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ *</label>
        <input type="text" id="accountId" class="form-control" placeholder="ID ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" required />
      </div>

      <div class="col-md-4">
        <label for="owner" class="form-label">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ *</label>
        <select id="owner" class="form-select" required></select>
      </div>

      <div class="col-md-4">
        <label for="status" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <select id="status" class="form-select">
          <option value="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="‡∏£‡∏∞‡∏á‡∏±‡∏ö">‡∏£‡∏∞‡∏á‡∏±‡∏ö</option>
        </select>
      </div>

      <div class="col-md-4">
        <label for="spendTotal" class="form-label">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</label>
        <input type="number" id="spendTotal" class="form-control" step="0.01" placeholder="0.00" />
      </div>

      <div class="col-md-4">
        <label for="costPerPurchase" class="form-label">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="number" id="costPerPurchase" class="form-control" step="0.01" placeholder="0.00" />
      </div>

      <div class="col-md-4">
        <label for="purchases" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</label>
        <input type="number" id="purchases" class="form-control" placeholder="0" />
      </div>

      <div class="col-md-4">
        <label for="revenue" class="form-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</label>
        <input type="number" id="revenue" class="form-control" step="0.01" placeholder="0.00" />
      </div>

      <div class="col-md-4">
        <label for="roas" class="form-label">ROAS</label>
        <input type="number" id="roas" class="form-control" step="0.01" placeholder="0.00" />
      </div>
    </div>

    <div class="mt-4 text-end">
      <button type="submit" class="btn btn-primary btn-lg">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </form>

  <h3 class="mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
  <div class="table-responsive shadow-sm bg-white rounded p-3">
    <table
      class="table table-bordered table-striped align-middle text-center"
      id="historyTable"
    >
      <thead class="table-primary">
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
          <th>ID</th>
          <th>‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://vzxttbvwukpsxqdaulvo.supabase.co";
  const supabaseKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  async function fetchOwners() {
    const { data, error } = await supabase
      .from("ad_owners")
      .select("id,name")
      .order("name");
    if (error) {
      alert("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      return;
    }
    const ownerSelect = document.getElementById("owner");
    ownerSelect.innerHTML = "";
    data.forEach((o) => {
      ownerSelect.innerHTML += `<option value="${o.name}">${o.name}</option>`;
    });
  }

  async function addOwner() {
    const nameInput = document.getElementById("newOwner");
    const name = nameInput.value.trim();
    if (!name) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ");
      return;
    }
    const btn = document.getElementById("btnAddOwner");
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...`;

    const { data: existing, error: checkError } = await supabase
      .from("ad_owners")
      .select("id")
      .eq("name", name)
      .limit(1);

    if (checkError) {
      alert("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + checkError.message);
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°`;
      return;
    }
    if (existing.length > 0) {
      alert("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°`;
      return;
    }

    const { error } = await supabase.from("ad_owners").insert([{ name }]);
    if (error) {
      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      btn.disabled = false;
      btn.innerHTML = `<i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°`;
      return;
    }

    nameInput.value = "";
    await fetchOwners();

    btn.disabled = false;
    btn.innerHTML = `<i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°`;
  }

  async function fetchAdHistory() {
    const { data, error } = await supabase
      .from("ad_history")
      .select("*")
      .order("date", { ascending: false });
    if (error) {
      alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
      return;
    }
    renderHistory(data);
  }

  function renderHistory(data) {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";
    data.forEach((item) => {
      tbody.innerHTML += `
        <tr>
          <td>${item.date}</td>
          <td>${item.accountName}</td>
          <td>${item.accountId}</td>
          <td>${item.owner}</td>
          <td>${item.status || "-"}</td>
          <td>${parseFloat(item.spendTotal).toFixed(2)}</td>
          <td>
            <button class="btn btn-danger btn-small" onclick="deleteEntry('${item.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
  }

  async function deleteEntry(id) {
    if (!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
    const { error } = await supabase.from("ad_history").delete().eq("id", id);
    if (error) {
      alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      return;
    }
    fetchAdHistory();
  }

  document.getElementById("adForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const entry = {
      date: document.getElementById("date").value,
      accountName: document.getElementById("accountName").value.trim(),
      accountId: document.getElementById("accountId").value.trim(),
      owner: document.getElementById("owner").value,
      status: document.getElementById("status").value,
      spendTotal: parseFloat(document.getElementById("spendTotal").value) || 0,
      costPerPurchase: parseFloat(document.getElementById("costPerPurchase").value) || 0,
      purchases: parseInt(document.getElementById("purchases").value) || 0,
      revenue: parseFloat(document.getElementById("revenue").value) || 0,
      roas: parseFloat(document.getElementById("roas").value) || 0,
    };

    const btnSave = e.target.querySelector("button[type=submit]");
    btnSave.disabled = true;
    btnSave.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;

    const { error } = await supabase.from("ad_history").insert([entry]);
    if (error) {
      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
      btnSave.disabled = false;
      btnSave.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      return;
    }

    e.target.reset();
    await fetchAdHistory();

    btnSave.disabled = false;
    btnSave.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  });

  fetchOwners();
  fetchAdHistory();

  document.getElementById("btnAddOwner").addEventListener("click", addOwner);
</script>
</body>
</html>
