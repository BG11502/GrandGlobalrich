<!DOCTYPE html>
<html lang="th">

<head>

    <meta charset="UTF-8">
    <title>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Excel (‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .error-log {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
        }

        /* Custom style to ensure buttons are at the very top and span width */
        .top-nav-buttons {
            padding: 1rem 0;
            /* Add some padding above and below the buttons */
            margin-bottom: 2rem;
            /* Space below the buttons and the main content */
            border-bottom: 1px solid #dee2e6;
            /* Optional: A subtle line below */
        }

        /* Added style for the new navigation buttons */
        .nav-buttons-container {
            display: flex;
            justify-content: space-between; /* Puts space between items */
            align-items: center;
            padding-bottom: 1rem; /* Space below these buttons */
            margin-bottom: 1rem; /* Space before the main title */
            border-bottom: 1px solid #eee; /* Optional: separator line */
        }

        .nav-buttons-container .btn {
            min-width: 150px; /* Ensure buttons have a consistent minimum width */
            text-align: center;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container my-5">
        <div class="nav-buttons-container">
            <a href="index.html" class="btn btn-outline-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"/>
                </svg>
                ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
            <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö.html" class="btn btn-outline-primary">
                ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M11.354 8.354a.5.5 0 0 0 0-.708L8.646 5.146a.5.5 0 1 0-.708.708L10.293 8l-2.355 2.354a.5.5 0 0 0 .708.708z"/>
                </svg>
            </a>
        </div>
        <h2 class="mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Excel (‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)</h2>

        <div class="mb-3">
            <label for="merchantId" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Merchant ID):</label>
            <input type="text" class="form-control" id="merchantId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
        </div>

        <div class="mb-4">
            <label for="excelFile" class="form-label">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" />
        </div>

        <div id="processingStatus" class="alert alert-info text-center" style="display: none;">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
            <strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå...</strong> ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
        </div>

        <div id="parsingErrors" class="alert alert-warning" style="display: none;">
            <strong>‚ö†Ô∏è ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong>
            <p id="errorSummary" class="mb-2"></p>
            <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse"
                data-bs-target="#errorDetails" aria-expanded="false" aria-controls="errorDetails">
                ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            </button>
            <div class="collapse" id="errorDetails">
                <pre id="errorLog" class="error-log mt-2"
                    style="max-height: 250px; overflow-y: auto;"></pre>
            </div>
        </div>

        <hr>

        <div class="mb-3 text-end top-nav-buttons">
            <button id="downloadSummaryBtn" class="btn btn-success me-2" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16">
                    <path
                        d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                    <path
                        d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                </svg>
                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (.xlsx)
            </button>
            <button id="saveToSupabaseBtn" class="btn btn-info" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z" />
                    <path
                        d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 3.109-3.502s4.552-1.242 2.68-1.53zM3.781 4.5C2.608 4.5 1.625 5.326 1.625 6.315c0 .539.213 1.028.569 1.454zm8.354 1.479c-.876-.415-1.89-.74-2.923-.74-1.954 0-3.658.99-4.653 2.11A4.5 4.5 0 0 0 3.78 12.375h8.906c1.808 0 3.25-1.366 3.25-3.182 0-1.58-.949-2.529-2.194-2.772z" />
                </svg>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Supabase
            </button>
        </div>

    
        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
            <h4 class="text-success mb-0">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
        </div>
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-6 mb-2">
                        <div class="p-3 bg-light rounded">
                            <h5 class="text-muted">Quantity ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                            <h3 id="totalQtyOverall" class="text-success display-5">0</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="p-3 bg-light rounded">
                            <h5 class="text-muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</h5>
                            <h3 id="totalAmountOverall" class="text-success display-5">0.00</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
            <h4 class="text-primary mb-0">üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î SKU ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h4>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                data-bs-target="#skuDetailCollapse" aria-expanded="true" aria-controls="skuDetailCollapse"
                id="toggleSkuDetailTableBtn">
                ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            </button>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col-md-auto">
                        <label for="filterDate" class="form-label mb-0">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="filterDate">
                    </div>
                    <div class="col-md-auto">
                        <button id="applyFilterBtn" class="btn btn-outline-primary">‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                    <div class="col-md-auto">
                        <button id="clearFilterBtn" class="btn btn-outline-secondary">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapse show" id="skuDetailCollapse">
            <div class="card mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (DD/MM/YYYY)</th>
                                    <th>Seller SKU</th>
                                    <th>Quantity ‡∏£‡∏ß‡∏°</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody id="skuSummaryTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)
        let globalSKUSummaryMap = {};
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase)
        let processedRawData = [];

        // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ---
        // ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà 'YOUR_SUPABASE_PROJECT_URL' ‡πÅ‡∏•‡∏∞ 'YOUR_SUPABASE_ANON_KEY' ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SUPABASE_URL = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏à‡∏≤‡∏Å Excel
        function parseFlexibleDate(raw) {
            if (raw === undefined || raw === null || raw === '') return null;

            // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á Excel (‡πÄ‡∏ä‡πà‡∏ô 44383 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 2021-07-06)
            if (typeof raw === "number") {
                const dateObj = XLSX.SSF.parse_date_code(raw);
                if (dateObj) {
                    // XLSX.SSF.parse_date_code ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ year, month, day, hour, minute, second
                    // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô XLSX.SSF ‡πÄ‡∏õ‡πá‡∏ô 1-indexed, ‡πÅ‡∏ï‡πà Date constructor ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 0-indexed
                    const d = new Date(dateObj.y, dateObj.m - 1, dateObj.d, dateObj.H || 0, dateObj.M || 0, dateObj.S || 0);
                    if (!isNaN(d.getTime())) return d;
                }
            }

            // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á
            if (typeof raw === "string") {
                raw = raw.trim();

                // Regex ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö DD/MM/YYYY [HH:MM:SS] ‡∏´‡∏£‡∏∑‡∏≠ DD-MM-YYYY [HH:MM:SS]
                const regexDMY = /^(\d{1,2})[/-](\d{1,2})[/-](\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/;
                let mDMY = raw.match(regexDMY);
                if (mDMY) {
                    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏à‡∏≥: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠ ‡∏ß‡∏±‡∏ô, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏õ‡∏µ ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Date constructor (YYYY-MM-DD)
                    const [_, day, month, year, hour, min, sec] = mDMY;
                    const dateString = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    const timeString = hour ? `T${hour.padStart(2, '0')}:${min.padStart(2, '0')}:${(sec || '00').padStart(2, '0')}` : '';
                    const d = new Date(`${dateString}${timeString}`);
                    if (!isNaN(d.getTime())) return d;
                }

                // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ISO-like YYYY-MM-DD [HH:MM:SS] ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô
                // ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà JavaScript Date.parse() ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
                const d = new Date(raw);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function formatDateToDDMMYYYY(date) {
            if (!date) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function formatDateToYYYYMMDD(date) {
            if (!date) return null;
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î "‡∏õ‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à" (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 26 ‡∏ñ‡∏∂‡∏á 25 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
        function getBusinessYearMonth(date) {
            const day = date.getDate();
            if (day >= 26) {
                const nextMonthDate = new Date(date);
                nextMonthDate.setMonth(date.getMonth() + 1);
                return { year: nextMonthDate.getFullYear(), month: nextMonthDate.getMonth() + 1 };
            } else {
                return { year: date.getFullYear(), month: date.getMonth() + 1 };
            }
        }

        // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel
        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) {
                resetTables();
                return;
            }

            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('parsingErrors').style.display = 'none';
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            document.getElementById('saveToSupabaseBtn').style.display = 'none';
            resetTables('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...');
            updateOverallTotals(0, 0); // Clear overall totals

            const sheetName = "OrderSKUList";
            const sellerSkuCol = "Seller SKU";
            const quantityCol = "Quantity";
            const orderAmountCol = "Order Amount";
            const cancelledTimeCol = "Cancelled Time";

            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheet = workbook.Sheets[sheetName];
                if (!sheet) {
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠ '${sheetName}' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`);
                    document.getElementById('processingStatus').style.display = 'none';
                    resetTables(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠ '${sheetName}'`);
                    updateOverallTotals(0, 0);
                    return;
                }

                const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö global map ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                globalSKUSummaryMap = {};
                processedRawData = [];

                const rowsNotParsed = [];
                let totalRowsProcessed = 0;

                json.forEach((row, index) => {
                    totalRowsProcessed++;
                    const sku = row[sellerSkuCol]?.toString().trim();
                    const qty = parseInt(row[quantityCol]) || 0;
                    const amount = parseFloat(row[orderAmountCol]) || 0;
                    const rawCancelledTime = row[cancelledTimeCol];

                    if (!sku) {
                        rowsNotParsed.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 2} (‡πÉ‡∏ô Excel): ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '${sellerSkuCol}' ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (Cancelled Time: "${rawCancelledTime}")`);
                        return;
                    }

                    const dateObj = parseFlexibleDate(rawCancelledTime);

                    if (!dateObj) {
                        rowsNotParsed.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${index + 2} (‡πÉ‡∏ô Excel): ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å "${rawCancelledTime}" (‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '${cancelledTimeCol}', Seller SKU: "${sku}", Type: ${typeof rawCancelledTime})`);
                        return;
                    }

                    const dateOnlyFormattedDDMMYYYY = formatDateToDDMMYYYY(dateObj);
                    const dateOnlyFormattedYYYYMMDD = formatDateToYYYYMMDD(dateObj);
                    const calendarYear = dateObj.getFullYear();
                    const { year: businessYear, month: businessMonth } = getBusinessYearMonth(dateObj);

                    // **‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡πÉ‡∏ô processedRawData**
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠ key ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'cancelled_order_records' ‡πÉ‡∏ô Supabase
                    processedRawData.push({
                        cancelled_date: dateOnlyFormattedYYYYMMDD,
                        seller_sku: sku,
                        quantity: qty,
                        order_amount: amount,
                        original_cancelled_time_string: rawCancelledTime ? rawCancelledTime.toString() : null,
                        cancelled_year: calendarYear, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                        cancelled_month: dateObj.getMonth() + 1, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                        business_year: businessYear, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                        business_month: businessMonth // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                    });

                    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SKU Detail Summary) ---
                    const skuKey = `${dateOnlyFormattedDDMMYYYY}||${sku}`;
                    if (!globalSKUSummaryMap[skuKey]) {
                        globalSKUSummaryMap[skuKey] = {
                            date_display: dateOnlyFormattedDDMMYYYY,
                            date_db: dateOnlyFormattedYYYYMMDD,
                            sku,
                            totalQty: 0,
                            totalAmount: 0
                        };
                    }
                    globalSKUSummaryMap[skuKey].totalQty += qty;
                    globalSKUSummaryMap[skuKey].totalAmount += amount;
                    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
                });

                renderSKUSummary(globalSKUSummaryMap);
                updateOverallTotalsBasedOnProcessedData();


                document.getElementById('processingStatus').style.display = 'none';
                document.getElementById('downloadSummaryBtn').style.display = 'inline-block';
                document.getElementById('saveToSupabaseBtn').style.display = 'inline-block';

                if (rowsNotParsed.length > 0) {
                    document.getElementById('parsingErrors').style.display = 'block';
                    document.getElementById('errorSummary').innerText = `‡∏û‡∏ö ${rowsNotParsed.length} ‡πÅ‡∏ñ‡∏ß‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalRowsProcessed} ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'Cancelled Time' ‡∏´‡∏£‡∏∑‡∏≠ 'Seller SKU' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel)`;
                    document.getElementById('errorLog').innerText = rowsNotParsed.join("\n");
                } else {
                    document.getElementById('parsingErrors').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function updateOverallTotals(totalQty, totalAmount) {
            document.getElementById('totalQtyOverall').innerText = totalQty.toLocaleString();
            document.getElementById('totalAmountOverall').innerText = totalAmount.toFixed(2).toLocaleString();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å processedRawData
        function updateOverallTotalsBasedOnProcessedData() {
            let overallTotalQty = 0;
            let overallTotalAmount = 0;

            processedRawData.forEach(item => {
                overallTotalQty += item.quantity;
                overallTotalAmount += item.order_amount;
            });
            updateOverallTotals(overallTotalQty, overallTotalAmount);
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function resetTables(message = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...') {
            document.getElementById('skuSummaryTable').innerHTML = `<tr><td colspan="4" class="text-center text-muted">${message}</td></tr>`;
            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Global
            globalSKUSummaryMap = {};
            processedRawData = [];
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            document.getElementById('saveToSupabaseBtn').style.display = 'none';
            document.getElementById('filterDate').value = '';
            updateOverallTotals(0, 0); // Reset overall totals on table reset
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ SKU (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
        function renderSKUSummary(dataMap, filterDate = null) {
            const tbody = document.getElementById('skuSummaryTable');
            tbody.innerHTML = '';

            let filteredData = Object.values(dataMap);

            if (filterDate) {
                filteredData = filteredData.filter(item => item.date_display === filterDate);
            }

            const sorted = filteredData.sort((a, b) => {
                const dateA = new Date(a.date_db);
                const dateB = new Date(b.date_db);
                if (dateA - dateB !== 0) return dateA - dateB;
                return a.sku.localeCompare(b.sku);
            });

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>';
            } else {
                sorted.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.date_display}</td>
                        <td>${item.sku}</td>
                        <td>${item.totalQty}</td>
                        <td>${item.totalAmount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
        document.getElementById('applyFilterBtn').addEventListener('click', function () {
            const filterDateInput = document.getElementById('filterDate').value;
            if (filterDateInput) {
                const [year, month, day] = filterDateInput.split('-');
                const formattedFilterDate = `${day}/${month}/${year}`;
                renderSKUSummary(globalSKUSummaryMap, formattedFilterDate);
            } else {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á');
            }
        });

        // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á"
        document.getElementById('clearFilterBtn').addEventListener('click', function () {
            document.getElementById('filterDate').value = '';
            renderSKUSummary(globalSKUSummaryMap);
        });

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô Excel (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ SKU Detail Summary)
        document.getElementById('downloadSummaryBtn').addEventListener('click', function () {
            const wb = XLSX.utils.book_new();

            // 1. ‡∏ä‡∏µ‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î SKU
            const allSKUDataForExport = Object.values(globalSKUSummaryMap).sort((a, b) => {
                const dateA = new Date(a.date_db);
                const dateB = new Date(b.date_db);
                if (dateA - dateB !== 0) return dateA - dateB;
                return a.sku.localeCompare(b.sku);
            }).map(item => [item.date_display, item.sku, item.totalQty, item.totalAmount.toFixed(2)]);

            const skuHeader = ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Seller SKU', 'Quantity ‡∏£‡∏ß‡∏°', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)'];

            if (allSKUDataForExport.length > 0) {
                // Calculate totals for export
                let exportTotalQuantity = 0;
                let exportTotalSalesAmount = 0;
                Object.values(globalSKUSummaryMap).forEach(item => {
                    exportTotalQuantity += item.totalQty;
                    exportTotalSalesAmount += item.totalAmount;
                });

                const dataWithTotals = [
                    skuHeader,
                    ...allSKUDataForExport,
                    ['', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', exportTotalQuantity, exportTotalSalesAmount.toFixed(2)] // Total row for export
                ];

                const wsSKU = XLSX.utils.aoa_to_sheet(dataWithTotals);
                XLSX.utils.book_append_sheet(wb, wsSKU, "SKU_Detail_Summary");
            } else {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }

            // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            XLSX.writeFile(wb, "SKU_Summary_Report_" + new Date().toLocaleDateString('en-CA') + ".xlsx");
        });

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase ---
        document.getElementById('saveToSupabaseBtn').addEventListener('click', async function () {
            const merchantId = document.getElementById('merchantId').value.trim();

            if (!merchantId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Merchant ID) ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }

            if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL ‡πÅ‡∏•‡∏∞ SUPABASE_ANON_KEY ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            if (processedRawData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Excel ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                return;
            }

            // Add merchant_id to each item in processedRawData
            const dataToInsert = processedRawData.map(item => ({
                ...item,
                merchant_id: merchantId // Add the merchant ID here
            }));

            this.disabled = true; // ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö...`; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°

            try {
                // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'cancelled_order_records'
                // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ 'insert' ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                const { data, error } = await supabase
                    .from('cancelled_order_records') // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Supabase
                    .insert(dataToInsert); // Use dataToInsert which includes merchant_id

                if (error) {
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase:', error);
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏•‡∏á Supabase: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î.`);
                } else {
                    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö ${dataToInsert.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Merchant ID: ${merchantId}) ‡∏•‡∏á Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', data);
                }

            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console.`);
            } finally {
                this.disabled = false; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z"/>
                        <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 3.109-3.502s4.552-1.242 2.68-1.53zM3.781 4.5C2.608 4.5 1.625 5.326 1.625 6.315c0 .539.213 1.028.569 1.454zm8.354 1.479c-.876-.415-1.89-.74-2.923-.74-1.954 0-3.658.99-4.653 2.11A4.5 4.5 0 0 0 3.78 12.375h8.906c1.808 0 3.25-1.366 3.25-3.182 0-1.58-.949-2.529-2.194-2.772z"/>
                    </svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Supabase
                `; // ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            }
        });

        // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á SKU Detail
        const skuDetailCollapseElement = document.getElementById('skuDetailCollapse');
        const toggleSkuDetailTableBtn = document.getElementById('toggleSkuDetailTableBtn');

        skuDetailCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleSkuDetailTableBtn.innerText = '‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        });

        skuDetailCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleSkuDetailTableBtn.innerText = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        });
    </script>
</body>

</html>
