<!DOCTYPE html>
<html lang="th">

<head>

    <meta charset="UTF-8">
    <title>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Excel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Custom style to ensure buttons are at the very top and span width */
        .top-nav-buttons {
            padding: 1rem 0;
            /* Add some padding above and below the buttons */
            margin-bottom: 2rem;
            /* Space below the buttons and the main content */
            border-bottom: 1px solid #dee2e6;
            /* Optional: A subtle line below */
        }

        /* Added style for the new navigation buttons */
        .nav-buttons-container {
            display: flex;
            justify-content: space-between;
            /* Puts space between items */
            align-items: center;
            padding-bottom: 1rem;
            /* Space below these buttons */
            margin-bottom: 1rem;
            /* Space before the main title */
            border-bottom: 1px solid #eee;
            /* Optional: separator line */
        }

        .nav-buttons-container .btn {
            min-width: 150px;
            /* Ensure buttons have a consistent minimum width */
            text-align: center;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container my-5">
        <div class="nav-buttons-container">
            <a href="index.html" class="btn btn-outline-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z" />
                </svg>
                ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
            <a href="‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö.html" class="btn btn-outline-primary">
                ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-arrow-right-circle" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M11.354 8.354a.5.5 0 0 0 0-.708L8.646 5.146a.5.5 0 1 0-.708.708L10.293 8l-2.355 2.354a.5.5 0 0 0 .708.708z" />
                </svg>
            </a>
        </div>
        <h2 class="mb-4">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å Excel</h2>

        <div class="mb-3">
            <label for="merchantId" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Merchant ID):</label>
            <input type="text" class="form-control" id="merchantId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
        </div>

        <div class="mb-4">
            <label for="excelFile" class="form-label">üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" />
        </div>

        <div id="processingStatus" class="alert alert-info text-center" style="display: none;">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
            <strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå...</strong> ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà
        </div>

        <hr>

        <div class="mb-3 text-end top-nav-buttons">
            <button id="downloadSummaryBtn" class="btn btn-success me-2" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-file-earmark-arrow-down" viewBox="0 0 16 16">
                    <path
                        d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293z" />
                    <path
                        d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z" />
                </svg>
                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (.xlsx)
            </button>
            <button id="saveToSupabaseBtn" class="btn btn-info" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                    <path fill-rule="evenodd"
                        d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z" />
                    <path
                        d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 3.109-3.502s4.552-1.242 2.68-1.53zM3.781 4.5C2.608 4.5 1.625 5.326 1.625 6.315c0 .539.213 1.028.569 1.454zm8.354 1.479c-.876-.415-1.89-.74-2.923-.74-1.954 0-3.658.99-4.653 2.11A4.5 4.5 0 0 0 3.78 12.375h8.906c1.808 0 3.25-1.366 3.25-3.182 0-1.58-.949-2.529-2.194-2.772z"/>
                </svg>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Supabase
            </button>
        </div>

        <div class="card mb-4 p-3" id="monthYearSelectionCard" style="display: none;">
            <h5 class="card-title mb-3">üóìÔ∏è ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤ Supabase)</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="selectUserYear" class="form-label">‡∏õ‡∏µ:</label>
                    <select class="form-select" id="selectUserYear">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</option>
                        </select>
                </div>
                <div class="col-md-6">
                    <label for="selectUserMonth" class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                    <select class="form-select" id="selectUserMonth">
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                        <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                        <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                        <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                        <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                        <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                        <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                        <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                        <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                        <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                        <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                    </select>
                </div>
            </div>
            <small class="text-muted mt-2">
                *‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
            </small>
        </div>


        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
            <h4 class="text-success mb-0">üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
        </div>
        <div class="card mb-4">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-6 mb-2">
                        <div class="p-3 bg-light rounded">
                            <h5 class="text-muted">Quantity ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                            <h3 id="totalQtyOverall" class="text-success display-5">0</h3>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="p-3 bg-light rounded">
                            <h5 class="text-muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</h5>
                            <h3 id="totalAmountOverall" class="text-success display-5">0.00</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
            <h4 class="text-primary mb-0">üîç ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î SKU (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h4>
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                data-bs-target="#skuDetailCollapse" aria-expanded="true" aria-controls="skuDetailCollapse"
                id="toggleSkuDetailTableBtn">
                ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            </button>
        </div>

        <div class="collapse show" id="skuDetailCollapse">
            <div class="card mb-4">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Seller SKU</th>
                                    <th>Quantity ‡∏£‡∏ß‡∏°</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                </tr>
                            </thead>
                            <tbody id="skuSummaryTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let globalSKUSummaryMap = {};
        let rawDataForSupabase = []; // Raw data per row (now without date parsing from Excel)

        const SUPABASE_URL = 'https://vzxttbvwukpsxqdaulvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eHR0YnZ3dWtwc3hxZGF1bHZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTI2MzIsImV4cCI6MjA2NzQ4ODYzMn0.s05eiK-WITEq_uEVH4zXNkPG0KUk4Fmv4Yo5jZizm2U';
        supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Populate year dropdown on page load
        document.addEventListener('DOMContentLoaded', () => {
            const selectYear = document.getElementById('selectUserYear');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear - 5; i <= currentYear + 1; i++) { // From 5 years ago to next year
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `‡∏õ‡∏µ ${i}`;
                selectYear.appendChild(option);
            }
            selectYear.value = currentYear; // Set current year as default
            
            // Set current month as default (Optional)
            const selectMonth = document.getElementById('selectUserMonth');
            selectMonth.value = (new Date().getMonth() + 1).toString();
        });

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) {
                resetTables();
                return;
            }

            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            document.getElementById('saveToSupabaseBtn').style.display = 'none';
            document.getElementById('monthYearSelectionCard').style.display = 'none'; // Hide selection until loaded
            resetTables('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...');
            updateOverallTotals(0, 0);

            const sheetName = "OrderSKUList";
            const sellerSkuCol = "Seller SKU";
            const quantityCol = "Quantity";
            const orderAmountCol = "Order Amount";
            // const cancelledTimeCol = "Cancelled Time"; // Removed as it's not used for date parsing now

            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const sheet = workbook.Sheets[sheetName];
                if (!sheet) {
                    alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠ '${sheetName}' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`);
                    document.getElementById('processingStatus').style.display = 'none';
                    resetTables(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠ '${sheetName}'`);
                    updateOverallTotals(0, 0);
                    return;
                }

                const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

                globalSKUSummaryMap = {};
                rawDataForSupabase = [];

                json.forEach((row, index) => {
                    const sku = row[sellerSkuCol]?.toString().trim();
                    const qty = parseInt(row[quantityCol]) || 0;
                    const amount = parseFloat(row[orderAmountCol]) || 0;
                    // const rawCancelledTime = row[cancelledTimeCol]; // Still good to capture original string if desired, but not for parsing

                    if (!sku) {
                        return; // Skip rows with no Seller SKU
                    }

                    // No date parsing from Excel needed for this logic
                    rawDataForSupabase.push({
                        // We no longer get cancelled_date, business_year, business_month from Excel
                        seller_sku: sku,
                        quantity: qty,
                        order_amount: amount,
                        // original_cancelled_time_string: rawCancelledTime ? rawCancelledTime.toString() : null, // Optional: keep if you want to store original string
                    });

                    // Aggregate for display summary (still SKU only)
                    if (!globalSKUSummaryMap[sku]) {
                        globalSKUSummaryMap[sku] = {
                            sku,
                            totalQty: 0,
                            totalAmount: 0
                        };
                    }
                    globalSKUSummaryMap[sku].totalQty += qty;
                    globalSKUSummaryMap[sku].totalAmount += amount;
                });

                renderSKUSummary();
                updateOverallTotalsBasedOnProcessedData(); // Use globalSKUSummaryMap for overall totals

                document.getElementById('processingStatus').style.display = 'none';
                document.getElementById('downloadSummaryBtn').style.display = 'inline-block';
                document.getElementById('saveToSupabaseBtn').style.display = 'inline-block';
                document.getElementById('monthYearSelectionCard').style.display = 'block'; // Show month/year selection
            };
            reader.readAsArrayBuffer(file);
        });

        function updateOverallTotals(totalQty, totalAmount) {
            document.getElementById('totalQtyOverall').innerText = totalQty.toLocaleString();
            document.getElementById('totalAmountOverall').innerText = totalAmount.toFixed(2).toLocaleString();
        }

        function updateOverallTotalsBasedOnProcessedData() {
            let overallTotalQty = 0;
            let overallTotalAmount = 0;

            Object.values(globalSKUSummaryMap).forEach(item => {
                overallTotalQty += item.totalQty;
                overallTotalAmount += item.totalAmount;
            });
            updateOverallTotals(overallTotalQty, overallTotalAmount);
        }

        function resetTables(message = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...') {
            document.getElementById('skuSummaryTable').innerHTML = `<tr><td colspan="3" class="text-center text-muted">${message}</td></tr>`;
            globalSKUSummaryMap = {};
            rawDataForSupabase = []; // Clear Supabase data
            document.getElementById('downloadSummaryBtn').style.display = 'none';
            document.getElementById('saveToSupabaseBtn').style.display = 'none';
            document.getElementById('monthYearSelectionCard').style.display = 'none'; // Hide month/year selection
            updateOverallTotals(0, 0);
        }

        function renderSKUSummary() {
            const tbody = document.getElementById('skuSummaryTable');
            tbody.innerHTML = '';

            let filteredData = Object.values(globalSKUSummaryMap);

            const sorted = filteredData.sort((a, b) => {
                return a.sku.localeCompare(b.sku);
            });

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ</td></tr>';
            } else {
                sorted.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.sku}</td>
                        <td>${item.totalQty}</td>
                        <td>${item.totalAmount.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        document.getElementById('downloadSummaryBtn').addEventListener('click', function () {
            const wb = XLSX.utils.book_new();

            const allSKUDataForExport = Object.values(globalSKUSummaryMap).sort((a, b) => {
                return a.sku.localeCompare(b.sku);
            }).map(item => [item.sku, item.totalQty, item.totalAmount.toFixed(2)]);

            const skuHeader = ['Seller SKU', 'Quantity ‡∏£‡∏ß‡∏°', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)'];

            if (allSKUDataForExport.length > 0) {
                let exportTotalQuantity = 0;
                let exportTotalSalesAmount = 0;
                Object.values(globalSKUSummaryMap).forEach(item => {
                    exportTotalQuantity += item.totalQty;
                    exportTotalSalesAmount += item.totalAmount;
                });

                const dataWithTotals = [
                    skuHeader,
                    ...allSKUDataForExport,
                    ['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', exportTotalQuantity, exportTotalSalesAmount.toFixed(2)]
                ];

                const wsSKU = XLSX.utils.aoa_to_sheet(dataWithTotals);
                XLSX.utils.book_append_sheet(wb, wsSKU, "SKU_Summary");
            } else {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }

            XLSX.writeFile(wb, "SKU_Summary_Report_" + new Date().toLocaleDateString('en-CA') + ".xlsx");
        });

        document.getElementById('saveToSupabaseBtn').addEventListener('click', async function () {
            const merchantId = document.getElementById('merchantId').value.trim();
            const selectedYear = parseInt(document.getElementById('selectUserYear').value);
            const selectedMonth = parseInt(document.getElementById('selectUserMonth').value);

            if (!merchantId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Merchant ID) ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }

            if (isNaN(selectedYear) || isNaN(selectedMonth)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }

            if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SUPABASE_URL ‡πÅ‡∏•‡∏∞ SUPABASE_ANON_KEY ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            if (Object.keys(globalSKUSummaryMap).length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SKU ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                return;
            }

            // Prepare summarized data for Supabase
            const dataToInsert = Object.values(globalSKUSummaryMap).map(item => ({
                merchant_id: merchantId,
                seller_sku: item.sku,
                total_quantity: item.totalQty, // Renamed column for clarity in summary table
                total_order_amount: item.totalAmount, // Renamed column for clarity in summary table
                summary_year: selectedYear, // New column for user-defined year
                summary_month: selectedMonth // New column for user-defined month
            }));

            this.disabled = true;
            this.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...`;

            try {
                // Supabase recommends inserting in batches for large datasets.
                // You might need to adjust the table name here to 'monthly_sku_summary'
                const { data, error } = await supabase
                    .from('monthly_sku_summary') // *** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
                    .upsert(dataToInsert, { onConflict: ['merchant_id', 'seller_sku', 'summary_year', 'summary_month'] });
                    // Using upsert: If a record with the same merchant_id, seller_sku, summary_year, and summary_month exists, it will be updated. Otherwise, a new record will be inserted.

                if (error) {
                    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase:', error);
                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Supabase: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î.`);
                } else {
                    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ ${dataToInsert.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Merchant ID: ${merchantId}, ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${selectedMonth}/${selectedYear}) ‡∏•‡∏á Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                    console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', data);
                }

            } catch (error) {
                console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ:', error);
                alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console.`);
            } finally {
                this.disabled = false;
                this.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-arrow-up" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708z"/>
                        <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 3.109-3.502s4.552-1.242 2.68-1.53zM3.781 4.5C2.608 4.5 1.625 5.326 1.625 6.315c0 .539.213 1.028.569 1.454zm8.354 1.479c-.876-.415-1.89-.74-2.923-.74-1.954 0-3.658.99-4.653 2.11A4.5 4.5 0 0 0 3.78 12.375h8.906c1.808 0 3.25-1.366 3.25-3.182 0-1.58-.949-2.529-2.194-2.772z"/>
                    </svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ Supabase
                `;
            }
        });

        const skuDetailCollapseElement = document.getElementById('skuDetailCollapse');
        const toggleSkuDetailTableBtn = document.getElementById('toggleSkuDetailTableBtn');

        skuDetailCollapseElement.addEventListener('show.bs.collapse', function () {
            toggleSkuDetailTableBtn.innerText = '‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        });

        skuDetailCollapseElement.addEventListener('hide.bs.collapse', function () {
            toggleSkuDetailTableBtn.innerText = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
        });
    </script>
</body>

</html>
