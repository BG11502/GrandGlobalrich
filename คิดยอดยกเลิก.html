<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î SKU ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<div class="container my-5">
  <h2 class="mb-4">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î SKU ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏Å Excel</h2>

  <!-- Input file -->
  <div class="mb-4">
    <label for="excelFile" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
    <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls" />
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• -->
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th>Seller SKU</th>
          <th>Quantity ‡∏£‡∏ß‡∏°</th>
          <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Order Amount)</th>
        </tr>
      </thead>
      <tbody id="summaryTable"></tbody>
    </table>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script -->
<script>
  document.getElementById('excelFile').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });

      const sheet = workbook.Sheets['OrderSKUList'];
      if (!sheet) {
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ó‡∏ä‡∏∑‡πà‡∏≠ OrderSKUList");
        return;
      }

      const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      const summaryMap = {};

      json.forEach(row => {
        const sku = row['Seller SKU']?.toString().trim();
        const qty = parseInt(row['Quantity']) || 0;
        const amount = parseFloat(row['Order Amount']) || 0;

        // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Cancelled Time ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö "dd/mm/yyyy hh:mm:ss"
        let dateOnly = '';
        if (row['Cancelled Time']) {
          try {
            const [day, month, yearAndTime] = row['Cancelled Time'].split('/');
            const [year, time] = yearAndTime.split(' ');
            const formatted = new Date(`${year}-${month}-${day}T${time}`);
            if (!isNaN(formatted)) {
              dateOnly = formatted.toLocaleDateString('th-TH'); // ex: 21/7/2568
            } else {
              console.warn('Invalid date:', row['Cancelled Time']);
              return;
            }
          } catch (err) {
            console.warn('Invalid date format:', row['Cancelled Time']);
            return;
          }
        }

        if (!sku || !dateOnly) return;

        const key = `${dateOnly}||${sku}`;
        if (!summaryMap[key]) {
          summaryMap[key] = { date: dateOnly, sku, totalQty: 0, totalAmount: 0 };
        }

        summaryMap[key].totalQty += qty;
        summaryMap[key].totalAmount += amount;
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const tbody = document.getElementById('summaryTable');
      tbody.innerHTML = '';

      const sorted = Object.values(summaryMap).sort((a, b) => {
        return new Date(a.date) - new Date(b.date);
      });

      sorted.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.date}</td>
          <td>${item.sku}</td>
          <td>${item.totalQty}</td>
          <td>${item.totalAmount.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
    };
    reader.readAsArrayBuffer(file);
  });
</script>

</body>
</html>
